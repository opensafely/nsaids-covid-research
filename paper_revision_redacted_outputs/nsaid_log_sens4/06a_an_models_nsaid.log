------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\nsaids-covid-research\analysis\nsaid_log_sens4\06a_an_models_nsaid.log
  log type:  text
 opened on:   7 Oct 2020, 20:36:18

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Sense check outcomes=======================================================*/ 
. 
. safetab exposure $outcome, missing row
23

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use | 1,926,672        612 | 1,927,284 
                      |     99.97       0.03 |    100.00 
----------------------+----------------------+----------
    current NSAID use |   531,055        217 |   531,272 
                      |     99.96       0.04 |    100.00 
----------------------+----------------------+----------
                Total | 2,457,727        829 | 2,458,556 
                      |     99.97       0.03 |    100.00 

. 
. /* Main Model=================================================================*/
. 
. /* Univariable model */ 
. 
. stcox i.exposure 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -12180.495
Iteration 1:   log likelihood = -12176.598
Iteration 2:   log likelihood = -12176.582
Iteration 3:   log likelihood = -12176.582
Refining estimates:
Iteration 0:   log likelihood = -12176.582

Cox regression -- Breslow method for ties

No. of subjects =    2,458,556                  Number of obs    =   2,458,556
No. of failures =          829
Time at risk    =    252402378
                                                LR chi2(1)       =        7.83
Log likelihood  =   -12176.582                  Prob > chi2      =      0.0052

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |    1.25251   .0989591     2.85   0.004     1.072825     1.46229
------------------------------------------------------------------------------------

. estimates save ./$tempdir/univar, replace 
(note: file ./nsaid_tempdata_sens4/univar.ster not found)
file ./nsaid_tempdata_sens4/univar.ster saved

. 
. /* Multivariable models */ 
. 
. * Age and Gender 
. * Age fit as spline in first instance, categorical below 
. 
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -12180.495
Iteration 1:   log likelihood = -11514.948
Iteration 2:   log likelihood = -11232.465
Iteration 3:   log likelihood = -11231.397
Iteration 4:   log likelihood = -11231.353
Iteration 5:   log likelihood = -11231.353
Refining estimates:
Iteration 0:   log likelihood = -11231.353

Cox regression -- Breslow method for ties

No. of subjects =    2,458,556                  Number of obs    =   2,458,556
No. of failures =          829
Time at risk    =    252402378
                                                LR chi2(5)       =     1898.28
Log likelihood  =   -11231.353                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |    1.09412   .0866614     1.14   0.256     .9367941    1.277867
            1.male |   2.157443   .1531547    10.83   0.000     1.877212    2.479507
              age1 |   1.148016   .0469388     3.38   0.001     1.059607    1.243801
              age2 |   .8825558   .0698744    -1.58   0.115     .7557014    1.030704
              age3 |   1.554052   .3554149     1.93   0.054     .9926449    2.432972
------------------------------------------------------------------------------------

. estimates save ./$tempdir/multivar1, replace 
(note: file ./nsaid_tempdata_sens4/multivar1.ster not found)
file ./nsaid_tempdata_sens4/multivar1.ster saved

. 
. * Age, Gender and Comorbidities (note: diabetes variable is diabcat) 
. stcox i.exposure i.male age1 age2 age3  i.obese4cat                                     ///
>                                                                                 i.smoke_nomiss                          ///
>                                                                                 i.imd                                           ///
>                                                                                 i.ckd                                           ///             
>                                                                                 i.hypertension                          ///             
>                                                                                 i.heart_failure                         ///             
>                                                                                 i.other_heart_disease           ///             
>                                                                                 i.diabcat                                       ///     
>                                                                                 i.copd                      ///
>                                                                                 i.other_respiratory         ///
>                                                                                 i.immunodef_any                         ///
>                                                                                 i.cancer                                ///     
>                                                                             i.rheumatoid                                ///     
>                                                                                 i.osteoarthritis                        ///     
>                                                                                 i.statin                                        ///     
>                                                                                 i.ppi                       ///
>                                                                                 i.steroid_prednisolone      ///
>                                                                                 i.hydroxychloroquine        ///
>                                                                                 i.dmards_primary_care       ///
>                                                                                 i.flu_vaccine                           ///     
>                                                                                 i.pneumococcal_vaccine , strata(stp)                            

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -9505.1161
Iteration 1:   log likelihood = -8579.2608
Iteration 2:   log likelihood = -8330.0411
Iteration 3:   log likelihood = -8312.4393
Iteration 4:   log likelihood =  -8309.555
Iteration 5:   log likelihood = -8309.2307
Iteration 6:   log likelihood = -8309.2246
Iteration 7:   log likelihood = -8309.2246
Refining estimates:
Iteration 0:   log likelihood = -8309.2246

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    2,458,556                  Number of obs    =   2,458,556
No. of failures =          829
Time at risk    =    252402378
                                                LR chi2(34)      =     2391.78
Log likelihood  =   -8309.2246                  Prob > chi2      =      0.0000

---------------------------------------------------------------------------------------------
                         _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
----------------------------+----------------------------------------------------------------
                   exposure |
         current NSAID use  |   .9600558    .084874    -0.46   0.645     .8073201    1.141687
                     1.male |   2.199189   .1602287    10.82   0.000     1.906539    2.536761
                       age1 |   1.133786   .0460706     3.09   0.002     1.046992    1.227776
                       age2 |    .904184   .0720841    -1.26   0.206     .7733865    1.057102
                       age3 |   1.429143   .3312108     1.54   0.123     .9074143    2.250846
                            |
                  obese4cat |
         Obese I (30-34.9)  |   1.091984    .099877     0.96   0.336     .9127714    1.306382
        Obese II (35-39.9)  |   1.539815   .1911194     3.48   0.001      1.20731    1.963896
           Obese III (40+)  |   1.714245   .2978405     3.10   0.002     1.219498    2.409708
                            |
               smoke_nomiss |
                    Former  |   1.044493   .0802065     0.57   0.571      .898549    1.214141
                   Current  |    .815914   .1112626    -1.49   0.136     .6245538    1.065906
                            |
                        imd |
                         2  |   1.480733   .1662753     3.50   0.000      1.18821    1.845272
                         3  |   1.535145   .1780969     3.69   0.000     1.222922    1.927081
                         4  |   1.825331   .2153689     5.10   0.000      1.44847    2.300245
           5 most deprived  |   2.366808   .2879693     7.08   0.000      1.86465    3.004198
                            |
                        ckd |
                       CKD  |   1.397126   .1331059     3.51   0.000     1.159153    1.683956
             1.hypertension |   1.052613   .0812741     0.66   0.507     .9047858    1.224592
            1.heart_failure |   1.650963   .2746134     3.01   0.003      1.19166    2.287295
      1.other_heart_disease |   1.159969   .1909663     0.90   0.367     .8400642    1.601696
                            |
                    diabcat |
       Controlled diabetes  |   1.423092   .1377813     3.64   0.000     1.177121    1.720461
     Uncontrolled diabetes  |   2.411901   .3213187     6.61   0.000     1.857636    3.131543
Diabetes, no hba1c measure  |    .411308   .4121469    -0.89   0.375     .0577071    2.931601
                            |
                     1.copd |   1.326989   .1640271     2.29   0.022     1.041481    1.690764
        1.other_respiratory |   2.425874   .3248337     6.62   0.000     1.865903    3.153896
            1.immunodef_any |   2.452295   .7186564     3.06   0.002     1.380779    4.355332
                   1.cancer |   1.993331   .1667267     8.25   0.000     1.691932     2.34842
               1.rheumatoid |   1.239078   .2405059     1.10   0.269     .8469933    1.812665
           1.osteoarthritis |    .855953   .0645683    -2.06   0.039     .7383122    .9923384
                   1.statin |   .6913749   .0583352    -4.37   0.000     .5859936    .8157073
                      1.ppi |   1.426705   .1140951     4.44   0.000     1.219727    1.668805
     1.steroid_prednisolone |   1.533562   .1950876     3.36   0.001     1.195139    1.967816
       1.hydroxychloroquine |   1.298719   .3966098     0.86   0.392     .7137903    2.362978
      1.dmards_primary_care |   1.542488   .3345874     2.00   0.046     1.008287    2.359714
              1.flu_vaccine |    1.00335   .0867716     0.04   0.969     .8469127    1.188682
     1.pneumococcal_vaccine |   1.073999   .1149827     0.67   0.505      .870711     1.32475
---------------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates save ./$tempdir/multivar2, replace 
(note: file ./nsaid_tempdata_sens4/multivar2.ster not found)
file ./nsaid_tempdata_sens4/multivar2.ster saved

. 
. * Age, Gender and Comorbidities (note: changed diabetes category: grouped no HbA1c to uncontrolled DM after first run because diab causing the model not to converge)
. stcox i.exposure i.male age1 age2 age3  $varlist, strata(stp)                           

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -9505.1161
Iteration 1:   log likelihood =  -8582.056
Iteration 2:   log likelihood = -8332.9794
Iteration 3:   log likelihood = -8315.3599
Iteration 4:   log likelihood = -8312.4601
Iteration 5:   log likelihood = -8312.1327
Iteration 6:   log likelihood = -8312.1265
Iteration 7:   log likelihood = -8312.1265
Refining estimates:
Iteration 0:   log likelihood = -8312.1265

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    2,458,556                  Number of obs    =   2,458,556
No. of failures =          829
Time at risk    =    252402378
                                                LR chi2(33)      =     2385.98
Log likelihood  =   -8312.1265                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
    current NSAID use  |    .958581    .084761    -0.48   0.632     .8060513    1.139974
                1.male |   2.200991   .1603334    10.83   0.000     1.908146    2.538779
                  age1 |   1.134056    .046108     3.09   0.002     1.047193    1.228125
                  age2 |   .9038154   .0720892    -1.27   0.205     .7730136     1.05675
                  age3 |    1.42999   .3315417     1.54   0.123     .9077845    2.252595
                       |
             obese4cat |
    Obese I (30-34.9)  |   1.095609   .1001771     1.00   0.318     .9158538    1.310646
   Obese II (35-39.9)  |   1.548049   .1920756     3.52   0.000     1.213867    1.974232
      Obese III (40+)  |    1.72403   .2994443     3.14   0.002     1.226594    2.423197
                       |
          smoke_nomiss |
               Former  |    1.04527   .0802577     0.58   0.564     .8992323    1.215026
              Current  |    .816485    .111341    -1.49   0.137     .6249899    1.066654
                       |
                   imd |
                    2  |   1.482457   .1664724     3.51   0.000     1.189588    1.847429
                    3  |   1.536358     .17823     3.70   0.000       1.2239    1.928584
                    4  |    1.82727   .2155972     5.11   0.000     1.450009    2.302687
      5 most deprived  |   2.370413   .2884131     7.09   0.000     1.867482    3.008787
                       |
                   ckd |
                  CKD  |   1.401261   .1334912     3.54   0.000     1.162597    1.688918
        1.hypertension |   1.053217   .0813346     0.67   0.502     .9052824    1.225327
       1.heart_failure |    1.66324   .2764975     3.06   0.002     1.200746    2.303875
 1.other_heart_disease |   1.154306   .1900237     0.87   0.383     .8359782    1.593849
                       |
          diab_control |
  Controlled diabetes  |    1.41718   .1371894     3.60   0.000     1.172262    1.713267
Uncontrolled diabetes  |   2.245896    .295798     6.14   0.000     1.734927    2.907355
                       |
                1.copd |   1.323847   .1636917     2.27   0.023     1.038934    1.686893
   1.other_respiratory |   2.426879   .3249962     6.62   0.000     1.866634    3.155274
       1.immunodef_any |   2.447505   .7171771     3.05   0.002     1.378165    4.346562
              1.cancer |   1.992554   .1666663     8.24   0.000     1.691265    2.347516
          1.rheumatoid |   1.240715   .2409654     1.11   0.267     .8479223    1.815466
      1.osteoarthritis |   .8558126   .0645572    -2.06   0.039     .7381919    .9921745
              1.statin |   .6971986   .0587153    -4.28   0.000     .5911146    .8223209
                 1.ppi |   1.427854   .1142259     4.45   0.000     1.220644    1.670239
1.steroid_prednisolone |   1.532762   .1950497     3.36   0.001     1.194417     1.96695
  1.hydroxychloroquine |   1.293173   .3949501     0.84   0.400     .7107053    2.353008
 1.dmards_primary_care |   1.540807   .3343868     1.99   0.046     1.006978    2.357635
         1.flu_vaccine |   1.007531   .0871595     0.09   0.931     .8503987    1.193697
1.pneumococcal_vaccine |   1.073534   .1149484     0.66   0.508      .870309    1.324213
----------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates save ./$tempdir/multivar3, replace
(note: file ./nsaid_tempdata_sens4/multivar3.ster not found)
file ./nsaid_tempdata_sens4/multivar3.ster saved

. 
. /* Print table================================================================*/ 
. *  Print the results for the main model 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table2.txt, write text replace
(note: file ./nsaid_output_sens4/table2.txt not found)

. 
. * Column headings 
. file write tablecontent ("Table 2: Association between current NSAID use and $tableoutcome - $population Population") _n

. file write tablecontent _tab ("Number of events") _tab ("Total person-weeks") _tab ("Rate per 1,000") _tab ("Univariable") _tab _tab ("Age/Sex Adjusted") _tab _tab ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _tab ///
>                                                 ("Age/Sex and Comorbidity (diabetes regroup)") _tab _tab _n

. file write tablecontent _tab _tab _tab _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ("95% CI") _n

. file write tablecontent ("Main Analysis") _n                                    

. 
. * Row headings 
. local lab0: label exposure 0

. local lab1: label exposure 1

.  
. /* Counts */
.  
. * First row, exposure = 0 (reference)
. 
.         safecount if exposure == 0 & $outcome == 1
  612

.         local event = r(N)

.     bysort exposure: egen total_follow_up = total(_t)

.         su total_follow_up if exposure == 0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |  1,927,284    1.97e+08           0   1.97e+08   1.97e+08

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         
.         file write tablecontent ("`lab0'") _tab

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

.         file write tablecontent ("1.00 (ref)") _tab _tab ("1.00 (ref)") _tab _tab ("1.00 (ref)") _n

.         
. * Second row, exposure = 1 (NSAID)
. 
. file write tablecontent ("`lab1'") _tab  

. 
.         safecount if exposure == 1 & $outcome == 1
  217

.         local event = r(N)

.         su total_follow_up if exposure == 1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    531,272    5.57e+07           0   5.57e+07   5.57e+07

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

. 
. /* Main Model */ 
. estimates use ./$tempdir/univar 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |    1.25251   .0989591     2.85   0.004     1.072825     1.46229
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar1 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |    1.09412   .0866614     1.14   0.256     .9367941    1.277867
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar2  

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .9600558    .084874    -0.46   0.645     .8073201    1.141687
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar3

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |    .958581    .084761    -0.48   0.632     .8060513    1.139974
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _n 

. 
. file write tablecontent _n

. file close tablecontent

. 
. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\nsaids-covid-research\analysis\nsaid_log_sens4\06a_an_models_nsaid.log
  log type:  text
 closed on:   7 Oct 2020, 20:51:21
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
