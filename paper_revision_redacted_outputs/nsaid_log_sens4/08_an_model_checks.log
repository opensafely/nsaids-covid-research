------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\nsaids-covid-research\analysis\nsaid_log_sens4\08_an_model_checks.log
  log type:  text
 opened on:   7 Oct 2020, 20:51:21

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Quietly run models, perform test and store results in local macro==========*/
. 
. qui stcox i.exposure 

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |     -0.04432         1.63        1         0.2018
      ------------+---------------------------------------------------
      global test |                      1.63        1         0.2018
      ----------------------------------------------------------------

. local univar_p = round(r(p),0.001)

. di `univar_p'
.202

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Schoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, univariable", position(11) size(medsmall)) 

. 
. graph export "$outdir/schoenplot1.svg", as(svg) replace
(note: file nsaid_output_sens4/schoenplot1.svg not found)
(file nsaid_output_sens4/schoenplot1.svg written in SVG format)

. 
. * Close window 
. graph close  

.                           
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -12180.495
Iteration 1:   log likelihood = -11514.948
Iteration 2:   log likelihood = -11232.465
Iteration 3:   log likelihood = -11231.397
Iteration 4:   log likelihood = -11231.353
Iteration 5:   log likelihood = -11231.353
Refining estimates:
Iteration 0:   log likelihood = -11231.353

Cox regression -- Breslow method for ties

No. of subjects =    2,458,556                  Number of obs    =   2,458,556
No. of failures =          829
Time at risk    =    252402378
                                                LR chi2(5)       =     1898.28
Log likelihood  =   -11231.353                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |    1.09412   .0866614     1.14   0.256     .9367941    1.277867
            1.male |   2.157443   .1531547    10.83   0.000     1.877212    2.479507
              age1 |   1.148016   .0469388     3.38   0.001     1.059607    1.243801
              age2 |   .8825558   .0698744    -1.58   0.115     .7557014    1.030704
              age3 |   1.554052   .3554149     1.93   0.054     .9926449    2.432972
------------------------------------------------------------------------------------

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |     -0.03874         1.24        1         0.2648
      0b.male     |            .            .        1             .
      1.male      |     -0.09881         8.08        1         0.0045
      age1        |     -0.01161         0.10        1         0.7516
      age2        |     -0.00022         0.00        1         0.9952
      age3        |      0.00961         0.07        1         0.7938
      ------------+---------------------------------------------------
      global test |                     25.99        5         0.0001
      ----------------------------------------------------------------

. local multivar1_p = round(r(phtest)[2,4],0.001)

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Schoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, age and sex adjusted", position(11) size(medsmall))                          

. 
. graph export "$outdir/schoenplot2.svg", as(svg) replace
(note: file nsaid_output_sens4/schoenplot2.svg not found)
(file nsaid_output_sens4/schoenplot2.svg written in SVG format)

. 
. * Close window 
. graph close

.                   
. stcox i.exposure i.male age1 age2 age3 $varlist, strata(stp)

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -9505.1161
Iteration 1:   log likelihood =  -8582.056
Iteration 2:   log likelihood = -8332.9794
Iteration 3:   log likelihood = -8315.3599
Iteration 4:   log likelihood = -8312.4601
Iteration 5:   log likelihood = -8312.1327
Iteration 6:   log likelihood = -8312.1265
Iteration 7:   log likelihood = -8312.1265
Refining estimates:
Iteration 0:   log likelihood = -8312.1265

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    2,458,556                  Number of obs    =   2,458,556
No. of failures =          829
Time at risk    =    252402378
                                                LR chi2(33)      =     2385.98
Log likelihood  =   -8312.1265                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
    current NSAID use  |    .958581    .084761    -0.48   0.632     .8060513    1.139974
                1.male |   2.200991   .1603334    10.83   0.000     1.908146    2.538779
                  age1 |   1.134056    .046108     3.09   0.002     1.047193    1.228125
                  age2 |   .9038154   .0720892    -1.27   0.205     .7730136     1.05675
                  age3 |    1.42999   .3315417     1.54   0.123     .9077845    2.252595
                       |
             obese4cat |
    Obese I (30-34.9)  |   1.095609   .1001771     1.00   0.318     .9158538    1.310646
   Obese II (35-39.9)  |   1.548049   .1920756     3.52   0.000     1.213867    1.974232
      Obese III (40+)  |    1.72403   .2994443     3.14   0.002     1.226594    2.423197
                       |
          smoke_nomiss |
               Former  |    1.04527   .0802577     0.58   0.564     .8992323    1.215026
              Current  |    .816485    .111341    -1.49   0.137     .6249899    1.066654
                       |
                   imd |
                    2  |   1.482457   .1664724     3.51   0.000     1.189588    1.847429
                    3  |   1.536358     .17823     3.70   0.000       1.2239    1.928584
                    4  |    1.82727   .2155972     5.11   0.000     1.450009    2.302687
      5 most deprived  |   2.370413   .2884131     7.09   0.000     1.867482    3.008787
                       |
                   ckd |
                  CKD  |   1.401261   .1334912     3.54   0.000     1.162597    1.688918
        1.hypertension |   1.053217   .0813346     0.67   0.502     .9052824    1.225327
       1.heart_failure |    1.66324   .2764975     3.06   0.002     1.200746    2.303875
 1.other_heart_disease |   1.154306   .1900237     0.87   0.383     .8359782    1.593849
                       |
          diab_control |
  Controlled diabetes  |    1.41718   .1371894     3.60   0.000     1.172262    1.713267
Uncontrolled diabetes  |   2.245896    .295798     6.14   0.000     1.734927    2.907355
                       |
                1.copd |   1.323847   .1636917     2.27   0.023     1.038934    1.686893
   1.other_respiratory |   2.426879   .3249962     6.62   0.000     1.866634    3.155274
       1.immunodef_any |   2.447505   .7171771     3.05   0.002     1.378165    4.346562
              1.cancer |   1.992554   .1666663     8.24   0.000     1.691265    2.347516
          1.rheumatoid |   1.240715   .2409654     1.11   0.267     .8479223    1.815466
      1.osteoarthritis |   .8558126   .0645572    -2.06   0.039     .7381919    .9921745
              1.statin |   .6971986   .0587153    -4.28   0.000     .5911146    .8223209
                 1.ppi |   1.427854   .1142259     4.45   0.000     1.220644    1.670239
1.steroid_prednisolone |   1.532762   .1950497     3.36   0.001     1.194417     1.96695
  1.hydroxychloroquine |   1.293173   .3949501     0.84   0.400     .7107053    2.353008
 1.dmards_primary_care |   1.540807   .3343868     1.99   0.046     1.006978    2.357635
         1.flu_vaccine |   1.007531   .0871595     0.09   0.931     .8503987    1.193697
1.pneumococcal_vaccine |   1.073534   .1149484     0.66   0.508      .870309    1.324213
----------------------------------------------------------------------------------------
                                                             Stratified by stp

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |     -0.04369         1.61        1         0.2048
      0b.male     |            .            .        1             .
      1.male      |     -0.09355         7.27        1         0.0070
      age1        |     -0.01474         0.16        1         0.6897
      age2        |      0.01011         0.08        1         0.7831
      age3        |     -0.00312         0.01        1         0.9319
      1b.obese4cat|            .            .        1             .
      2.obese4cat |     -0.03863         1.22        1         0.2693
      3.obese4cat |     -0.03355         0.94        1         0.3321
      4.obese4cat |     -0.01407         0.16        1         0.6858
      1b.smoke_n~s|            .            .        1             .
      2.smoke_no~s|     -0.03668         1.12        1         0.2892
      3.smoke_no~s|      0.05119         2.17        1         0.1405
      1b.imd      |            .            .        1             .
      2.imd       |      0.00956         0.08        1         0.7834
      3.imd       |      0.00349         0.01        1         0.9204
      4.imd       |      0.02093         0.36        1         0.5461
      5.imd       |      0.00367         0.01        1         0.9155
      0b.ckd      |            .            .        1             .
      1.ckd       |     -0.01129         0.11        1         0.7349
      0b.hyperte~n|            .            .        1             .
      1.hyperten~n|     -0.00871         0.06        1         0.8003
      0b.heart_~re|            .            .        1             .
      1.heart_f~re|     -0.05936         2.96        1         0.0855
      0b.other_~se|            .            .        1             .
      1.other_h~se|      0.00470         0.02        1         0.8935
      1b.diab_co~l|            .            .        1             .
      2.diab_con~l|     -0.00519         0.02        1         0.8807
      3.diab_con~l|     -0.00711         0.04        1         0.8401
      0b.copd     |            .            .        1             .
      1.copd      |     -0.00242         0.00        1         0.9445
      0b.other_r~y|            .            .        1             .
      1.other_re~y|     -0.00261         0.01        1         0.9400
      0b.immunod~y|            .            .        1             .
      1.immunode~y|     -0.00506         0.02        1         0.8838
      0b.cancer   |            .            .        1             .
      1.cancer    |      0.06021         3.36        1         0.0669
      0b.rheumat~d|            .            .        1             .
      1.rheumatoid|      0.02380         0.57        1         0.4517
      0b.osteoar~s|            .            .        1             .
      1.osteoart~s|     -0.02128         0.38        1         0.5367
      0b.statin   |            .            .        1             .
      1.statin    |     -0.13839        15.44        1         0.0001
      0b.ppi      |            .            .        1             .
      1.ppi       |      0.01546         0.21        1         0.6455
      0b.steroi~ne|            .            .        1             .
      1.steroid~ne|     -0.07280         4.58        1         0.0323
      0b.hydrox~ne|            .            .        1             .
      1.hydroxy~ne|     -0.01937         0.34        1         0.5593
      0b.dmards~re|            .            .        1             .
      1.dmards_~re|      0.00125         0.00        1         0.9668
      0b.flu_vac~e|            .            .        1             .
      1.flu_vacc~e|      0.01924         0.33        1         0.5639
      0b.pneumoc~e|            .            .        1             .
      1.pneumoco~e|     -0.03029         0.76        1         0.3823
      ------------+---------------------------------------------------
      global test |                     71.77       33         0.0001
      ----------------------------------------------------------------

. local multivar2_p = round(r(phtest)[2,4],0.001)

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Schoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, fully adjusted", position(11) size(medsmall))                

.                           
. graph export "$outdir/schoenplot3.svg", as(svg) replace
(note: file nsaid_output_sens4/schoenplot3.svg not found)
(file nsaid_output_sens4/schoenplot3.svg written in SVG format)

. 
. * Close window 
. graph close

. 
. * Print table of results======================================================*/        
. 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table4.txt, write text replace
(note: file ./nsaid_output_sens4/table4.txt not found)

. 
. * Column headings 
. file write tablecontent ("Table 4: Testing the PH assumption - $population Population") _n

. file write tablecontent _tab ("Univariable") _tab ("Age/Sex Adjusted") _tab ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _n

.                                                 
. file write tablecontent _tab ("p-value") _tab ("p-value") _tab ("p-value") _tab _n

. 
. * Row heading and content  
. file write tablecontent ("Treatment Exposure") _tab

. file write tablecontent ("`univar_p'") _tab ("`multivar1_p'") _tab ("`multivar2_p'")

. 
. file write tablecontent _n

. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\nsaids-covid-research\analysis\nsaid_log_sens4\08_an_model_checks.log
  log type:  text
 closed on:   7 Oct 2020, 21:21:03
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
