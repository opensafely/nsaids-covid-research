------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\nsaids-covid-research\analysis\nsaid_log_sens5\06a_an_models_nsaid.log
  log type:  text
 opened on:   7 Oct 2020, 21:26:09

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Sense check outcomes=======================================================*/ 
. 
. safetab exposure $outcome, missing row
23

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use | 1,882,520        564 | 1,883,084 
                      |     99.97       0.03 |    100.00 
----------------------+----------------------+----------
    current NSAID use |   520,952        209 |   521,161 
                      |     99.96       0.04 |    100.00 
----------------------+----------------------+----------
                Total | 2,403,472        773 | 2,404,245 
                      |     99.97       0.03 |    100.00 

. 
. /* Main Model=================================================================*/
. 
. /* Univariable model */ 
. 
. stcox i.exposure 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -11340.649
Iteration 1:   log likelihood = -11335.526
Iteration 2:   log likelihood = -11335.497
Iteration 3:   log likelihood = -11335.497
Refining estimates:
Iteration 0:   log likelihood = -11335.497

Cox regression -- Breslow method for ties

No. of subjects =    2,404,245                  Number of obs    =   2,404,245
No. of failures =          773
Time at risk    =    246857371
                                                LR chi2(1)       =       10.31
Log likelihood  =   -11335.497                  Prob > chi2      =      0.0013

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   1.304128   .1056088     3.28   0.001      1.11273    1.528449
------------------------------------------------------------------------------------

. estimates save ./$tempdir/univar, replace 
(note: file ./nsaid_tempdata_sens5/univar.ster not found)
file ./nsaid_tempdata_sens5/univar.ster saved

. 
. /* Multivariable models */ 
. 
. * Age and Gender 
. * Age fit as spline in first instance, categorical below 
. 
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -11340.649
Iteration 1:   log likelihood = -10757.546
Iteration 2:   log likelihood = -10457.967
Iteration 3:   log likelihood = -10457.408
Iteration 4:   log likelihood = -10457.396
Iteration 5:   log likelihood = -10457.396
Refining estimates:
Iteration 0:   log likelihood = -10457.396

Cox regression -- Breslow method for ties

No. of subjects =    2,404,245                  Number of obs    =   2,404,245
No. of failures =          773
Time at risk    =    246857371
                                                LR chi2(5)       =     1766.51
Log likelihood  =   -10457.396                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   1.121566   .0910485     1.41   0.158     .9565872    1.314999
            1.male |   2.160253   .1589029    10.47   0.000     1.870218    2.495266
              age1 |   1.149885   .0474107     3.39   0.001     1.060617    1.246666
              age2 |   .8780419   .0702326    -1.63   0.104     .7506363    1.027072
              age3 |   1.583976   .3665507     1.99   0.047       1.0064    2.493025
------------------------------------------------------------------------------------

. estimates save ./$tempdir/multivar1, replace 
(note: file ./nsaid_tempdata_sens5/multivar1.ster not found)
file ./nsaid_tempdata_sens5/multivar1.ster saved

. 
. * Age, Gender and Comorbidities (note: diabetes variable is diabcat) 
. stcox i.exposure i.male age1 age2 age3  i.obese4cat                                     ///
>                                                                                 i.smoke_nomiss                          ///
>                                                                                 i.imd                                           ///
>                                                                                 i.ckd                                           ///             
>                                                                                 i.hypertension                          ///             
>                                                                                 i.heart_failure                         ///             
>                                                                                 i.other_heart_disease           ///             
>                                                                                 i.diabcat                                       ///     
>                                                                                 i.copd                      ///
>                                                                                 i.other_respiratory         ///
>                                                                                 i.immunodef_any                         ///
>                                                                                 i.cancer                                ///     
>                                                                             i.rheumatoid                                ///     
>                                                                                 i.osteoarthritis                        ///     
>                                                                                 i.statin                                        ///     
>                                                                                 i.ppi                       ///
>                                                                                 i.steroid_prednisolone      ///
>                                                                                 i.hydroxychloroquine        ///
>                                                                                 i.dmards_primary_care       ///
>                                                                                 i.flu_vaccine                           ///     
>                                                                                 i.pneumococcal_vaccine , strata(stp)                            

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -8846.3872
Iteration 1:   log likelihood = -7978.1989
Iteration 2:   log likelihood = -7751.5096
Iteration 3:   log likelihood = -7735.4547
Iteration 4:   log likelihood =  -7732.796
Iteration 5:   log likelihood =   -7732.51
Iteration 6:   log likelihood = -7732.5052
Iteration 7:   log likelihood = -7732.5052
Refining estimates:
Iteration 0:   log likelihood = -7732.5052

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    2,404,245                  Number of obs    =   2,404,245
No. of failures =          773
Time at risk    =    246857371
                                                LR chi2(34)      =     2227.76
Log likelihood  =   -7732.5052                  Prob > chi2      =      0.0000

---------------------------------------------------------------------------------------------
                         _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
----------------------------+----------------------------------------------------------------
                   exposure |
         current NSAID use  |   .9835106    .089425    -0.18   0.855     .8229703    1.175368
                     1.male |   2.202061   .1661247    10.46   0.000      1.89939    2.552962
                       age1 |   1.138535   .0468729     3.15   0.002     1.050275    1.234213
                       age2 |   .8923139    .072142    -1.41   0.159      .761552    1.045528
                       age3 |   1.492656   .3511512     1.70   0.089     .9412658    2.367048
                            |
                  obese4cat |
         Obese I (30-34.9)  |   1.085481   .1027511     0.87   0.386     .9016703    1.306762
        Obese II (35-39.9)  |   1.491795   .1932978     3.09   0.002     1.157219    1.923103
           Obese III (40+)  |   1.617263   .2960343     2.63   0.009     1.129721    2.315209
                            |
               smoke_nomiss |
                    Former  |   1.030498   .0819664     0.38   0.706     .8817428    1.204348
                   Current  |   .8387048   .1157655    -1.27   0.203     .6399098    1.099258
                            |
                        imd |
                         2  |   1.489217   .1732388     3.42   0.001     1.185601    1.870584
                         3  |    1.56274   .1874056     3.72   0.000     1.235406    1.976805
                         4  |   1.806592    .221276     4.83   0.000     1.421028    2.296769
           5 most deprived  |   2.327063   .2943272     6.68   0.000     1.816135     2.98173
                            |
                        ckd |
                       CKD  |   1.469357   .1459423     3.87   0.000     1.209436    1.785139
             1.hypertension |   1.064489   .0848897     0.78   0.433     .9104591    1.244577
            1.heart_failure |   1.638301   .2958575     2.73   0.006     1.149944    2.334051
      1.other_heart_disease |     1.2462   .2238949     1.23   0.221      .876313    1.772215
                            |
                    diabcat |
       Controlled diabetes  |   1.446665   .1458848     3.66   0.000     1.187219    1.762808
     Uncontrolled diabetes  |   2.353625   .3361151     5.99   0.000     1.779014    3.113832
Diabetes, no hba1c measure  |   .4259942   .4269761    -0.85   0.395     .0597365    3.037857
                            |
                     1.copd |   1.329167   .1719997     2.20   0.028     1.031409    1.712887
        1.other_respiratory |   2.454945    .344297     6.40   0.000     1.864936    3.231615
            1.immunodef_any |   2.362496   .7228026     2.81   0.005     1.297021    4.303236
                   1.cancer |   2.093334   .1809322     8.55   0.000     1.767124    2.479763
               1.rheumatoid |   1.133289   .2347775     0.60   0.546     .7550957    1.700904
           1.osteoarthritis |   .8708968    .068063    -1.77   0.077     .7472103    1.015057
                   1.statin |   .7229418   .0633557    -3.70   0.000      .608846    .8584189
                      1.ppi |   1.424701   .1185273     4.25   0.000     1.210343    1.677023
     1.steroid_prednisolone |   1.572642   .2083855     3.42   0.001     1.212942    2.039012
       1.hydroxychloroquine |   1.447602   .4469656     1.20   0.231     .7903686    2.651359
      1.dmards_primary_care |   1.510734   .3450565     1.81   0.071     .9655414     2.36377
              1.flu_vaccine |   1.004051    .089719     0.05   0.964     .8427422    1.196235
     1.pneumococcal_vaccine |   1.121498   .1214541     1.06   0.290     .9070194    1.386694
---------------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates save ./$tempdir/multivar2, replace 
(note: file ./nsaid_tempdata_sens5/multivar2.ster not found)
file ./nsaid_tempdata_sens5/multivar2.ster saved

. 
. * Age, Gender and Comorbidities (note: changed diabetes category: grouped no HbA1c to uncontrolled DM after first run because diab causing the model not to converge)
. stcox i.exposure i.male age1 age2 age3  $varlist, strata(stp)                           

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -8846.3872
Iteration 1:   log likelihood = -7980.5875
Iteration 2:   log likelihood = -7754.1546
Iteration 3:   log likelihood = -7738.0962
Iteration 4:   log likelihood = -7735.4224
Iteration 5:   log likelihood = -7735.1335
Iteration 6:   log likelihood = -7735.1286
Iteration 7:   log likelihood = -7735.1286
Refining estimates:
Iteration 0:   log likelihood = -7735.1286

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    2,404,245                  Number of obs    =   2,404,245
No. of failures =          773
Time at risk    =    246857371
                                                LR chi2(33)      =     2222.52
Log likelihood  =   -7735.1286                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
    current NSAID use  |   .9823481   .0893401    -0.20   0.845     .8219633    1.174028
                1.male |   2.203459   .1662005    10.47   0.000     1.900646    2.554516
                  age1 |   1.138832   .0469135     3.16   0.002     1.050497    1.234594
                  age2 |    .891915   .0721461    -1.41   0.157     .7611506    1.045144
                  age3 |   1.493676   .3515433     1.70   0.088     .9417213    2.369139
                       |
             obese4cat |
    Obese I (30-34.9)  |   1.089136   .1030613     0.90   0.367     .9047653    1.311078
   Obese II (35-39.9)  |   1.499864    .194274     3.13   0.002     1.163584    1.933331
      Obese III (40+)  |   1.626423   .2976135     2.66   0.008     1.136253    2.328048
                       |
          smoke_nomiss |
               Former  |   1.031425   .0820326     0.39   0.697      .882549    1.205415
              Current  |   .8391469   .1158285    -1.27   0.204     .6402441    1.099842
                       |
                   imd |
                    2  |   1.492033    .173571     3.44   0.001     1.187836    1.874133
                    3  |   1.564755   .1876376     3.73   0.000     1.237013     1.97933
                    4  |   1.809791   .2216736     4.84   0.000     1.423536    2.300851
      5 most deprived  |   2.331555   .2948891     6.69   0.000      1.81965    2.987469
                       |
                   ckd |
                  CKD  |   1.473816   .1463857     3.90   0.000     1.213105    1.790557
        1.hypertension |   1.064376   .0849081     0.78   0.434     .9103167    1.244508
       1.heart_failure |    1.65209   .2981389     2.78   0.005      1.15991    2.353114
 1.other_heart_disease |   1.238572   .2225168     1.19   0.234     .8709591    1.761346
                       |
          diab_control |
  Controlled diabetes  |   1.440787   .1452745     3.62   0.000     1.182424    1.755603
Uncontrolled diabetes  |   2.180778      .3076     5.53   0.000     1.654052    2.875239
                       |
                1.copd |   1.325412   .1715769     2.18   0.030     1.028398    1.708206
   1.other_respiratory |   2.454557   .3442549     6.40   0.000     1.864623    3.231136
       1.immunodef_any |   2.357249     .72113     2.80   0.005     1.294213    4.293438
              1.cancer |   2.091839   .1808096     8.54   0.000     1.765851    2.478007
          1.rheumatoid |   1.134683   .2351911     0.61   0.542     .7558607    1.703362
      1.osteoarthritis |   .8708234   .0680565    -1.77   0.077     .7471487     1.01497
              1.statin |   .7289597   .0637598    -3.61   0.000     .6141177    .8652776
                 1.ppi |   1.425654   .1186495     4.26   0.000     1.211081    1.678244
1.steroid_prednisolone |    1.57209   .2084108     3.41   0.001     1.212367    2.038546
  1.hydroxychloroquine |   1.441812   .4452115     1.18   0.236     .7871716    2.640875
 1.dmards_primary_care |   1.509534   .3449435     1.80   0.072     .9645722    2.362386
         1.flu_vaccine |   1.008269   .0901272     0.09   0.927     .8462317    1.201334
1.pneumococcal_vaccine |   1.121553   .1214872     1.06   0.290     .9070209    1.386827
----------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates save ./$tempdir/multivar3, replace
(note: file ./nsaid_tempdata_sens5/multivar3.ster not found)
file ./nsaid_tempdata_sens5/multivar3.ster saved

. 
. /* Print table================================================================*/ 
. *  Print the results for the main model 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table2.txt, write text replace
(note: file ./nsaid_output_sens5/table2.txt not found)

. 
. * Column headings 
. file write tablecontent ("Table 2: Association between current NSAID use and $tableoutcome - $population Population") _n

. file write tablecontent _tab ("Number of events") _tab ("Total person-weeks") _tab ("Rate per 1,000") _tab ("Univariable") _tab _tab ("Age/Sex Adjusted") _tab _tab ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _tab ///
>                                                 ("Age/Sex and Comorbidity (diabetes regroup)") _tab _tab _n

. file write tablecontent _tab _tab _tab _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ("95% CI") _n

. file write tablecontent ("Main Analysis") _n                                    

. 
. * Row headings 
. local lab0: label exposure 0

. local lab1: label exposure 1

.  
. /* Counts */
.  
. * First row, exposure = 0 (reference)
. 
.         safecount if exposure == 0 & $outcome == 1
  564

.         local event = r(N)

.     bysort exposure: egen total_follow_up = total(_t)

.         su total_follow_up if exposure == 0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |  1,883,084    1.92e+08           0   1.92e+08   1.92e+08

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         
.         file write tablecontent ("`lab0'") _tab

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

.         file write tablecontent ("1.00 (ref)") _tab _tab ("1.00 (ref)") _tab _tab ("1.00 (ref)") _n

.         
. * Second row, exposure = 1 (NSAID)
. 
. file write tablecontent ("`lab1'") _tab  

. 
.         safecount if exposure == 1 & $outcome == 1
  209

.         local event = r(N)

.         su total_follow_up if exposure == 1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    521,161    5.47e+07           0   5.47e+07   5.47e+07

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

. 
. /* Main Model */ 
. estimates use ./$tempdir/univar 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.304128   .1056088     3.28   0.001      1.11273    1.528449
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar1 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.121566   .0910485     1.41   0.158     .9565872    1.314999
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar2  

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .9835106    .089425    -0.18   0.855     .8229703    1.175368
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar3

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .9823481   .0893401    -0.20   0.845     .8219633    1.174028
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _n 

. 
. file write tablecontent _n

. file close tablecontent

. 
. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\nsaids-covid-research\analysis\nsaid_log_sens5\06a_an_models_nsaid.log
  log type:  text
 closed on:   7 Oct 2020, 21:39:55
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
