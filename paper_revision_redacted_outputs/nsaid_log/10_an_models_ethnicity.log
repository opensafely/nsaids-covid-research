------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\nsaids-covid-research\analysis\nsaid_log\10_an_models_ethnicity.log
  log type:  text
 opened on:   7 Oct 2020, 13:19:14

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Restrict population========================================================*/ 
. 
. preserve 

. drop if ethnicity == .u
(562,123 observations deleted)

. 
. /* Sense check outcomes=======================================================*/ 
. 
. safetab exposure $outcome, missing row
23

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use | 1,488,311        464 | 1,488,775 
                      |     99.97       0.03 |    100.00 
----------------------+----------------------+----------
    current NSAID use |   412,642        167 |   412,809 
                      |     99.96       0.04 |    100.00 
----------------------+----------------------+----------
                Total | 1,900,953        631 | 1,901,584 
                      |     99.97       0.03 |    100.00 

. 
. /* Main Model=================================================================*/
. 
. /* Univariable model */ 
. 
. stcox i.exposure 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -9109.2422
Iteration 1:   log likelihood = -9106.0145
Iteration 2:   log likelihood = -9106.0005
Iteration 3:   log likelihood = -9106.0005
Refining estimates:
Iteration 0:   log likelihood = -9106.0005

Cox regression -- Breslow method for ties

No. of subjects =    1,901,584                  Number of obs    =   1,901,584
No. of failures =          631
Time at risk    =    195196082
                                                LR chi2(1)       =        6.48
Log likelihood  =   -9106.0005                  Prob > chi2      =      0.0109

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |    1.26389   .1140538     2.60   0.009     1.059002    1.508419
------------------------------------------------------------------------------------

. estimates save ./$tempdir/univar_ethn, replace 
(note: file ./nsaid_tempdata/univar_ethn.ster not found)
file ./nsaid_tempdata/univar_ethn.ster saved

. 
. /* Multivariable models */ 
. 
. * Age and Gender 
. * Age fit as spline in first instance, categorical below 
. 
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -9109.2422
Iteration 1:   log likelihood = -8620.1958
Iteration 2:   log likelihood = -8406.6971
Iteration 3:   log likelihood = -8405.4118
Iteration 4:   log likelihood = -8405.3445
Iteration 5:   log likelihood = -8405.3441
Iteration 6:   log likelihood = -8405.3441
Refining estimates:
Iteration 0:   log likelihood = -8405.3441

Cox regression -- Breslow method for ties

No. of subjects =    1,901,584                  Number of obs    =   1,901,584
No. of failures =          631
Time at risk    =    195196082
                                                LR chi2(5)       =     1407.80
Log likelihood  =   -8405.3441                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   1.097501    .099283     1.03   0.304     .9191851    1.310409
            1.male |   2.077804    .168434     9.02   0.000     1.772569      2.4356
              age1 |   1.153211   .0594876     2.76   0.006     1.042318    1.275902
              age2 |   .8922485   .0873732    -1.16   0.244     .7364312    1.081034
              age3 |    1.46936    .411608     1.37   0.170     .8485619    2.544328
------------------------------------------------------------------------------------

. estimates save ./$tempdir/multivar1_ethn, replace 
(note: file ./nsaid_tempdata/multivar1_ethn.ster not found)
file ./nsaid_tempdata/multivar1_ethn.ster saved

. 
. * Age, Gender and Comorbidities 
. stcox i.exposure i.male age1 age2 age3  $varlist   ///
>                                                                                 i.ethnicity, strata(stp)                

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -7100.9667
Iteration 1:   log likelihood = -6404.6711
Iteration 2:   log likelihood = -6174.8637
Iteration 3:   log likelihood = -6162.4802
Iteration 4:   log likelihood = -6160.6992
Iteration 5:   log likelihood =   -6160.51
Iteration 6:   log likelihood =  -6160.507
Iteration 7:   log likelihood =  -6160.507
Refining estimates:
Iteration 0:   log likelihood =  -6160.507

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    1,901,584                  Number of obs    =   1,901,584
No. of failures =          631
Time at risk    =    195196082
                                                LR chi2(37)      =     1880.92
Log likelihood  =    -6160.507                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------
                     _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------+----------------------------------------------------------------
               exposure |
     current NSAID use  |   1.013999   .1025136     0.14   0.891     .8317306    1.236211
                 1.male |   2.110981   .1759282     8.97   0.000     1.792856    2.485553
                   age1 |   1.127497   .0571183     2.37   0.018     1.020925    1.245193
                   age2 |   .9472654   .0924285    -0.56   0.579     .7823779    1.146903
                   age3 |   1.186858   .3336861     0.61   0.542     .6840423    2.059277
                        |
              obese4cat |
     Obese I (30-34.9)  |   1.042414   .1101046     0.39   0.694     .8474856    1.282177
    Obese II (35-39.9)  |   1.612929   .2247966     3.43   0.001     1.227388    2.119574
       Obese III (40+)  |   1.918772   .3659751     3.42   0.001     1.320293    2.788538
                        |
           smoke_nomiss |
                Former  |   1.065286   .0962648     0.70   0.484     .8923743    1.271701
               Current  |   .9164779   .1401218    -0.57   0.568     .6791731    1.236698
                        |
                    imd |
                     2  |   1.747128   .2399107     4.06   0.000     1.334874    2.286701
                     3  |   1.720107   .2440139     3.82   0.000      1.30258    2.271469
                     4  |   2.220226   .3117185     5.68   0.000     1.686122    2.923516
       5 most deprived  |   2.434027   .3597427     6.02   0.000     1.821881    3.251851
                        |
                    ckd |
                   CKD  |   1.591933   .1729688     4.28   0.000     1.286586    1.969748
         1.hypertension |   1.085288   .0965313     0.92   0.357     .9116633    1.291979
        1.heart_failure |   1.846166   .3398294     3.33   0.001     1.287027     2.64822
  1.other_heart_disease |   1.089503   .2066391     0.45   0.651     .7512538    1.580049
                        |
           diab_control |
   Controlled diabetes  |   1.302821   .1456514     2.37   0.018     1.046461    1.621984
 Uncontrolled diabetes  |   2.127141   .3153258     5.09   0.000     1.590797    2.844316
                        |
                 1.copd |   1.323799   .1838572     2.02   0.043     1.008328    1.737969
    1.other_respiratory |   2.882902   .4145054     7.36   0.000     2.174922    3.821344
        1.immunodef_any |   2.670687   .8219389     3.19   0.001     1.461015    4.881929
               1.cancer |   2.189225   .2081025     8.24   0.000     1.817093    2.637568
           1.rheumatoid |   1.208936   .2680612     0.86   0.392     .7828233    1.866994
       1.osteoarthritis |   .8147416   .0705584    -2.37   0.018     .6875495    .9654633
               1.statin |   .6739064   .0647825    -4.11   0.000     .5581793    .8136271
                  1.ppi |   1.307676   .1199737     2.92   0.003     1.092461    1.565288
 1.steroid_prednisolone |   1.603041   .2299799     3.29   0.001     1.210117    2.123548
   1.hydroxychloroquine |   1.069893    .388077     0.19   0.852      .525519    2.178174
  1.dmards_primary_care |   1.698608     .41292     2.18   0.029     1.054804     2.73536
          1.flu_vaccine |    1.12771   .1130711     1.20   0.231     .9265114      1.3726
 1.pneumococcal_vaccine |   1.036175   .1233379     0.30   0.765      .820565    1.308439
                        |
              ethnicity |
                 Mixed  |   1.027766   .5195047     0.05   0.957     .3816259    2.767903
Asian or Asian British  |   2.124202   .3117794     5.13   0.000     1.593165    2.832245
                 Black  |   1.847447   .3970805     2.86   0.004     1.212326    2.815301
                 Other  |   1.003245   .3874508     0.01   0.993     .4706254    2.138647
-----------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates save ./$tempdir/multivar2_ethn, replace 
(note: file ./nsaid_tempdata/multivar2_ethn.ster not found)
file ./nsaid_tempdata/multivar2_ethn.ster saved

. 
. /* Print table================================================================*/ 
. *  Print the results for the main model 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table6.txt, write text replace
(note: file ./nsaid_output/table6.txt not found)

. 
. * Column headings 
. file write tablecontent ("Table 6: Association between current NSAID use and death - $population Population, restrict to known ethnicity") _n

. file write tablecontent _tab ("Number of events") _tab ("Total person-weeks") _tab ("Rate per 1,000") _tab ("Univariable") _tab _tab ("Age/Sex Adjusted") _tab _tab ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _tab _n

. file write tablecontent _tab _tab _tab _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("HR") _tab ("95% CI") _n

. file write tablecontent ("Main Analysis") _n                                    

. 
. * Row headings 
. local lab0: label exposure 0

. local lab1: label exposure 1

.  
. * First row, exposure = 0 (reference)
. 
.         safecount if exposure == 0 & $outcome == 1
  464

.         local event = r(N)

.     bysort exposure: egen total_follow_up = total(_t)

.         su total_follow_up if exposure == 0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |  1,488,775    1.52e+08           0   1.52e+08   1.52e+08

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         
.         file write tablecontent ("`lab0'") _tab

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

.         file write tablecontent ("1.00 (ref)") _tab _tab ("1.00 (ref)") _tab _tab ("1.00 (ref)") _n

.         
. * Second row, exposure = 1 (NSAID)
. 
. file write tablecontent ("`lab1'") _tab  

. 
.         safecount if exposure == 1 & $outcome == 1
  167

.         local event = r(N)

.         su total_follow_up if exposure == 1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    412,809    4.33e+07           0   4.33e+07   4.33e+07

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

. 
. /* Main Model */ 
. estimates use ./$tempdir/univar_ethn 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |    1.26389   .1140538     2.60   0.009     1.059002    1.508419
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar1_ethn

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.097501    .099283     1.03   0.304     .9191851    1.310409
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar2_ethn

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.013999   .1025136     0.14   0.891     .8317306    1.236211
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _n 

. 
. 
. file write tablecontent _n

. file close tablecontent

. 
. restore 

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\nsaids-covid-research\analysis\nsaid_log\10_an_models_ethnicity.log
  log type:  text
 closed on:   7 Oct 2020, 13:26:07
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
