------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\nsaids-covid-research\analysis\nsaid_log\11_an_models_GPcount_A&E.log
  log type:  text
 opened on:   7 Oct 2020, 13:26:07

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Sense check outcomes=======================================================*/ 
. 
. safetab exposure $outcome, missing row
23

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use | 1,926,672        612 | 1,927,284 
                      |     99.97       0.03 |    100.00 
----------------------+----------------------+----------
    current NSAID use |   536,203        220 |   536,423 
                      |     99.96       0.04 |    100.00 
----------------------+----------------------+----------
                Total | 2,462,875        832 | 2,463,707 
                      |     99.97       0.03 |    100.00 

. 
. /* Main Model=================================================================*/
. 
. * Age, Gender and Comorbidities 
. stcox i.exposure i.male age1 age2 age3  $varlist                 ///
>                                                                                 i.gp_consult             ///
>                                                                                 i.aande_attendance_last_year, strata(stp)               

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -9541.0673
Iteration 1:   log likelihood =  -8581.543
Iteration 2:   log likelihood = -8304.2516
Iteration 3:   log likelihood = -8286.1489
Iteration 4:   log likelihood = -8283.2573
Iteration 5:   log likelihood = -8282.9341
Iteration 6:   log likelihood = -8282.9281
Iteration 7:   log likelihood = -8282.9281
Refining estimates:
Iteration 0:   log likelihood = -8282.9281

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    2,463,707                  Number of obs    =   2,463,707
No. of failures =          832
Time at risk    =    252942782
                                                LR chi2(35)      =     2516.28
Log likelihood  =   -8282.9281                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------------
                          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------------+----------------------------------------------------------------
                    exposure |
          current NSAID use  |   .9827595   .0863478    -0.20   0.843     .8272914    1.167444
                      1.male |   2.225638   .1620102    10.99   0.000     1.929715     2.56694
                        age1 |   1.135209   .0456638     3.15   0.002     1.049147    1.228331
                        age2 |   .9129949   .0721665    -1.15   0.249      .781963    1.065983
                        age3 |   1.360939   .3130275     1.34   0.180     .8670719    2.136103
                             |
                   obese4cat |
          Obese I (30-34.9)  |   1.096842   .1002486     1.01   0.312     .9169519    1.312024
         Obese II (35-39.9)  |   1.537725   .1907357     3.47   0.001     1.205863    1.960919
            Obese III (40+)  |   1.701561   .2952541     3.06   0.002     1.211009    2.390824
                             |
                smoke_nomiss |
                     Former  |   1.054493   .0808139     0.69   0.489     .9074224      1.2254
                    Current  |    .799914   .1091897    -1.64   0.102     .6121429    1.045283
                             |
                         imd |
                          2  |   1.480393   .1660521     3.50   0.000     1.188228    1.844396
                          3  |   1.518022   .1758694     3.60   0.000     1.209658    1.904993
                          4  |   1.781326    .209927     4.90   0.000     1.413938    2.244173
            5 most deprived  |   2.269633   .2759038     6.74   0.000     1.788467    2.880252
                             |
                         ckd |
                        CKD  |   1.386055   .1315986     3.44   0.001     1.150703    1.669542
              1.hypertension |   1.045199    .080526     0.57   0.566      .898709    1.215566
             1.heart_failure |   1.469789   .2449685     2.31   0.021     1.060196    2.037624
       1.other_heart_disease |   1.116191   .1835677     0.67   0.504     .8086319     1.54073
                             |
                diab_control |
        Controlled diabetes  |   1.410293   .1359001     3.57   0.000     1.167576    1.703467
      Uncontrolled diabetes  |   2.192699    .288786     5.96   0.000     1.693842    2.838476
                             |
                      1.copd |   1.274308   .1573449     1.96   0.050     1.000398    1.623217
         1.other_respiratory |   2.298514    .307165     6.23   0.000     1.768869    2.986749
             1.immunodef_any |   2.323913   .6809198     2.88   0.004     1.308618    4.126927
                    1.cancer |   1.909205    .159603     7.74   0.000     1.620671    2.249106
                1.rheumatoid |   1.219207   .2337238     1.03   0.301     .8373384    1.775228
            1.osteoarthritis |   .8349385   .0629333    -2.39   0.017     .7202701    .9678622
                    1.statin |   .7083345   .0596206    -4.10   0.000     .6006101    .8353802
                       1.ppi |   1.360023   .1085646     3.85   0.000     1.163051    1.590354
      1.steroid_prednisolone |   1.407446    .179422     2.68   0.007     1.096276    1.806938
        1.hydroxychloroquine |   1.443565   .4272607     1.24   0.215     .8081671    2.578527
       1.dmards_primary_care |    1.58322   .3376718     2.15   0.031     1.042307    2.404844
               1.flu_vaccine |   1.031402   .0893596     0.36   0.721     .8703237    1.222293
      1.pneumococcal_vaccine |   1.082009   .1153879     0.74   0.460     .8779242    1.333537
                1.gp_consult |   .8745737   .1501377    -0.78   0.435     .6246992    1.224396
1.aande_attendance_last_year |   2.311923   .1692958    11.44   0.000     2.002821    2.668729
----------------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates save ./$tempdir/multivar_gp_ae, replace 
(note: file ./nsaid_tempdata/multivar_gp_ae.ster not found)
file ./nsaid_tempdata/multivar_gp_ae.ster saved

. 
. /* Print table================================================================*/ 
. *  Print the results for the main model 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table7.txt, write text replace
(note: file ./nsaid_output/table7.txt not found)

. 
. * Column headings 
. file write tablecontent ("Table 7: Association between current NSAID use and death - $population Population, additionally adjusted for GP count and A&E count") _n

. file write tablecontent _tab ("Number of events") _tab ("Total person-weeks") _tab ("Rate per 1,000") _tab ("Age/Sex and Comorbidity Adjusted") _tab _tab _n

. file write tablecontent _tab _tab _tab _tab ("HR") _tab ("95% CI") _n

. file write tablecontent ("Sensitivity Analysis") _n                                     

. 
. * Row headings 
. local lab0: label exposure 0

. local lab1: label exposure 1

.  
. * First row, exposure = 0 (reference)
. 
.         safecount if exposure == 0 & $outcome == 1
  612

.         local event = r(N)

.     bysort exposure: egen total_follow_up = total(_t)

.         su total_follow_up if exposure == 0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |  1,927,284    1.97e+08           0   1.97e+08   1.97e+08

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         
.         file write tablecontent ("`lab0'") _tab

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

.         file write tablecontent ("1.00 (ref)") _n

.         
. * Second row, exposure = 1 (NSAID)
. 
. file write tablecontent ("`lab1'") _tab  

. 
.         safecount if exposure == 1 & $outcome == 1
  220

.         local event = r(N)

.         su total_follow_up if exposure == 1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    536,423    5.63e+07           0   5.63e+07   5.63e+07

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

. 
. /* Main Model */ 
. estimates use ./$tempdir/multivar_gp_ae

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .9827595   .0863478    -0.20   0.843     .8272914    1.167444
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _n 

. 
. 
. file write tablecontent _n

. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\nsaids-covid-research\analysis\nsaid_log\11_an_models_GPcount_A&E.log
  log type:  text
 closed on:   7 Oct 2020, 13:32:47
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
