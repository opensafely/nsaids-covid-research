------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\nsaids-covid-research\analysis\nsaid_log_sens9\00a_cr_create_analysis_dataset.log
  log type:  text
 opened on:   7 Oct 2020, 23:59:29

. 
. /* SET FU DATES===============================================================*/ 
. * Censoring dates for each outcome (largely, last date outcome data available)
. 
. global ecdscensor               = "17/04/2020" //subject to change

. global onscoviddeathcensor      = "14/06/2020"

. global indexdate                        = "01/03/2020"

. 
. 
. /* describe VARAIBLES===========================================================*/
. des, f

Contains data
  obs:     2,463,810                          
 vars:            71                          
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
patient_id      long    %12.0g                
died_ons_covid_flag_any
                byte    %8.0g                 
died_ons_covid_flag_underlying
                byte    %8.0g                 
died_date_ons   str10   %10s                  
aande_attendance_with_covid
                byte    %8.0g                 
nsaid_last_three_years
                str7    %9s                   
nsaid_after_march
                str10   %10s                  
nsaid_last_four_months
                str7    %9s                   
nsaid_last_two_months
                str7    %9s                   
nsaid_last_month
                str7    %9s                   
recent_stop_nsaid
                str7    %9s                   
naproxen_high   str7    %9s                   
naproxen_low    str7    %9s                   
naproxen_other  str7    %9s                   
cox_medication  str7    %9s                   
aspirin_ten_years
                byte    %8.0g                 
aspirin_ever    str7    %9s                   
ibuprofen       str7    %9s                   
indometacin     str7    %9s                   
steroid_prednisolone
                str7    %9s                   
hydroxychloroquine
                str7    %9s                   
dmards_primary_care
                str7    %9s                   
age             int     %8.0g                 
sex             str1    %9s                   
stp             str9    %9s                   
imd             long    %12.0g                
msoa            str9    %9s                   
rural_urban     byte    %8.0g                 
ethnicity       byte    %8.0g                 
ethnicity_date  int     %8.0g                 
bmi             float   %9.0g                 
bmi_date_measured
                str7    %9s                   
smoking_status  str1    %9s                   
smoking_status_date
                str7    %9s                   
hypertension    str7    %9s                   
heart_failure   str7    %9s                   
other_heart_disease
                str7    %9s                   
diabetes        str7    %9s                   
hba1c_mmol_per_mol
                float   %9.0g                 
hba1c_mmol_per_mol_date
                str7    %9s                   
hba1c_percentage
                float   %9.0g                 
hba1c_percentage_date
                str7    %9s                   
copd            str7    %9s                   
other_respiratory
                str7    %9s                   
asthma          str7    %9s                   
cancer          str7    %9s                   
permanent_immunodeficiency
                str7    %9s                   
aplastic_anaemia
                str7    %9s                   
temporary_immunodeficiency
                str7    %9s                   
creatinine      float   %9.0g                 
creatinine_date str7    %9s                   
esrf            str7    %9s                   
stroke          byte    %8.0g                 
mi              byte    %8.0g                 
gi_bleed_ulcer  byte    %8.0g                 
osteoarthritis  str7    %9s                   
rheumatoid      str7    %9s                   
flu_vaccine_tpp_table
                int     %8.0g                 
flu_vaccine_med str10   %10s                  
flu_vaccine_clinical
                str7    %9s                   
flu_vaccine     byte    %8.0g                 
pneumococcal_vaccine_tpp_table
                int     %8.0g                 
pneumococcal_vaccine_med
                str10   %10s                  
pneumococcal_vaccine_clinical
                str7    %9s                   
pneumococcal_vaccine
                byte    %8.0g                 
statin          str7    %9s                   
ppi             str7    %9s                   
saba_single     str7    %9s                   
annde_attendance_last_year
                int     %8.0g                 
gp_consult_count
                int     %8.0g                 
has_consultation_history
                byte    %8.0g                 
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. /* CONVERT STRINGS TO DATE====================================================*/
. /* Comorb dates are given with month only, so adding day 15 to enable
>    them to be processed as dates                                                                                          */
. 
. foreach var of varlist  aplastic_anaemia                                ///
>                                                 asthma                                          ///
>                                                 bmi_date_measured                               ///
>                                                 copd                                            ///
>                                                 creatinine_date                                 ///
>                                                 diabetes                                        ///
>                                                 heart_failure                                   ///
>                                                 hypertension                                    ///
>                                                 hba1c_percentage_date                   ///
>                                                 hba1c_mmol_per_mol_date                 ///
>                                                 esrf                                                    ///
>                         cancer                                          ///
>                                                 other_heart_disease                             ///
>                                                 other_respiratory                               ///
>                                                 permanent_immunodeficiency      ///
>                                                 smoking_status_date                             ///
>                                                 temporary_immunodeficiency      ///
>                                                 rheumatoid                      ///
>                                                 osteoarthritis                  ///
>                                                 statin                                                  ///
>                                                 ppi                             ///
>                                                 steroid_prednisolone            ///
>                                                 aspirin_ever                    ///
>                                                 hydroxychloroquine              ///
>                                                 dmards_primary_care             ///
>                                                 saba_single                     ///
>                                                 nsaid_last_three_years          ///
>                                                 nsaid_last_two_months           ///
>                                                 nsaid_last_month                ///
>                                                 recent_stop_nsaid               ///
>                                                 nsaid_last_four_months          ///
>                                         naproxen_high                   ///
>                                                 naproxen_low                    ///
>                                                 naproxen_other                  ///
>                                                 cox_medication                  ///
>                                                 indometacin                     ///
>                                                 ibuprofen                       ///
>                       {
  2.                 
.                 capture confirm string variable `var'
  3.                 if _rc!=0 {
  4.                         cap assert `var'==.
  5.                         rename `var' `var'_date
  6.                 }
  7.         
.                 else {
  8.                                 replace `var' = `var' + "-15"
  9.                                 rename `var' `var'_dstr
 10.                                 replace `var'_dstr = " " if `var'_dstr == "-15"
 11.                                 gen `var'_date = date(`var'_dstr, "YMD") 
 12.                                 order `var'_date, after(`var'_dstr)
 13.                                 drop `var'_dstr
 14.                 }
 15.         
.         format `var'_date %td
 16. }
variable aplastic_anaemia was str7 now str10
(2,463,810 real changes made)
(2,463,795 real changes made)
(2,463,795 missing values generated)
variable asthma was str7 now str10
(2,463,810 real changes made)
(2,146,259 real changes made)
(2,146,259 missing values generated)
variable bmi_date_measured was str7 now str10
(2,463,810 real changes made)
(325,353 real changes made)
(325,353 missing values generated)
variable copd was str7 now str10
(2,463,810 real changes made)
(2,405,732 real changes made)
(2,405,732 missing values generated)
variable creatinine_date was str7 now str10
(2,463,810 real changes made)
(1,327,378 real changes made)
(1,327,378 missing values generated)
variable diabetes was str7 now str10
(2,463,810 real changes made)
(2,226,402 real changes made)
(2,226,402 missing values generated)
variable heart_failure was str7 now str10
(2,463,810 real changes made)
(2,451,864 real changes made)
(2,451,864 missing values generated)
variable hypertension was str7 now str10
(2,463,810 real changes made)
(1,981,903 real changes made)
(1,981,903 missing values generated)
variable hba1c_percentage_date was str7 now str10
(2,463,810 real changes made)
(1,808,302 real changes made)
(1,808,302 missing values generated)
variable hba1c_mmol_per_mol_date was str7 now str10
(2,463,810 real changes made)
(842,087 real changes made)
(842,087 missing values generated)
variable esrf was str7 now str10
(2,463,810 real changes made)
(2,463,223 real changes made)
(2,463,223 missing values generated)
variable cancer was str7 now str10
(2,463,810 real changes made)
(2,336,340 real changes made)
(2,336,340 missing values generated)
variable other_heart_disease was str7 now str10
(2,463,810 real changes made)
(2,427,199 real changes made)
(2,427,199 missing values generated)
variable other_respiratory was str7 now str10
(2,463,810 real changes made)
(2,440,341 real changes made)
(2,440,341 missing values generated)
variable permanent_immunodeficiency was str7 now str10
(2,463,810 real changes made)
(2,452,638 real changes made)
(2,452,638 missing values generated)
variable smoking_status_date was str7 now str10
(2,463,810 real changes made)
(37,143 real changes made)
(37,143 missing values generated)
variable temporary_immunodeficiency was str7 now str10
(2,463,810 real changes made)
(2,462,759 real changes made)
(2,462,759 missing values generated)
variable rheumatoid was str7 now str10
(2,463,810 real changes made)
(2,413,589 real changes made)
(2,413,589 missing values generated)
variable osteoarthritis was str7 now str10
(2,463,810 real changes made)
(1,933,151 real changes made)
(1,933,151 missing values generated)
variable statin was str7 now str10
(2,463,810 real changes made)
(2,153,413 real changes made)
(2,153,413 missing values generated)
variable ppi was str7 now str10
(2,463,810 real changes made)
(1,852,570 real changes made)
(1,852,570 missing values generated)
variable steroid_prednisolone was str7 now str10
(2,463,810 real changes made)
(2,408,639 real changes made)
(2,408,639 missing values generated)
variable aspirin_ever was str7 now str10
(2,463,810 real changes made)
(2,404,344 real changes made)
(2,404,344 missing values generated)
variable hydroxychloroquine was str7 now str10
(2,463,810 real changes made)
(2,449,056 real changes made)
(2,449,056 missing values generated)
variable dmards_primary_care was str7 now str10
(2,463,810 real changes made)
(2,426,182 real changes made)
(2,426,182 missing values generated)
variable saba_single was str7 now str10
(2,463,810 real changes made)
(2,393,910 real changes made)
(2,393,910 missing values generated)
variable nsaid_last_three_years was str7 now str10
(2,463,810 real changes made)
(0 real changes made)
variable nsaid_last_two_months was str7 now str10
(2,463,810 real changes made)
(2,100,561 real changes made)
(2,100,561 missing values generated)
variable nsaid_last_month was str7 now str10
(2,463,810 real changes made)
(2,245,780 real changes made)
(2,245,780 missing values generated)
variable recent_stop_nsaid was str7 now str10
(2,463,810 real changes made)
(841,273 real changes made)
(841,273 missing values generated)
variable nsaid_last_four_months was str7 now str10
(2,463,810 real changes made)
(1,927,361 real changes made)
(1,927,361 missing values generated)
variable naproxen_high was str7 now str10
(2,463,810 real changes made)
(2,167,268 real changes made)
(2,167,268 missing values generated)
variable naproxen_low was str7 now str10
(2,463,810 real changes made)
(2,349,575 real changes made)
(2,349,575 missing values generated)
variable naproxen_other was str7 now str10
(2,463,810 real changes made)
(2,463,220 real changes made)
(2,463,220 missing values generated)
variable cox_medication was str7 now str10
(2,463,810 real changes made)
(2,438,455 real changes made)
(2,438,455 missing values generated)
variable indometacin was str7 now str10
(2,463,810 real changes made)
(2,458,659 real changes made)
(2,458,659 missing values generated)
variable ibuprofen was str7 now str10
(2,463,810 real changes made)
(2,411,716 real changes made)
(2,411,716 missing values generated)

. 
. * Note - outcome dates are handled separtely below 
. 
. /* RENAME VARAIBLES===========================================================*/
. *  An extra 'date' added to the end of some variable names, remove 
. 
. rename creatinine_date_date                     creatinine_measured_date

. rename smoking_status_date_date                 smoking_status_measured_date

. rename bmi_date_measured_date                   bmi_measured_date

. rename hba1c_percentage_date_date               hb1ac_percentage_date 

. rename hba1c_mmol_per_mol_date_date             hba1c_mmol_per_mol_date

. 
. * Some names too long for loops below, shorten
. 
. rename permanent_immunodeficiency_date perm_immunodef_date

. rename temporary_immunodeficiency_date temp_immunodef_date

. 
. /* CREATE BINARY VARIABLES====================================================*/
. *  Make indicator variables for all conditions where relevant 
. 
. foreach var of varlist  bmi_measured_date                                       ///
>                                                 copd_date                                       ///
>                                                 creatinine_measured_date                        ///
>                                                 diabetes_date                                   ///
>                                                 heart_failure_date                                      ///
>                                                 hypertension_date                               ///
>                                                 esrf_date                                                       ///
>                         cancer_date                                     ///
>                                                 other_heart_disease_date                        ///
>                                                 other_respiratory_date                          ///
>                                                 smoking_status_measured_date            ///
>                                                 rheumatoid_date                     ///
>                                                 osteoarthritis_date                 ///
>                                                 ppi_date                                                ///
>                                                 statin_date                                             ///
>                                             steroid_prednisolone_date           ///   
>                                                 hydroxychloroquine_date             ///
>                                                 dmards_primary_care_date            ///
>                                                 indometacin_date                    ///
>                                                 aspirin_ever_date                   ///
>                                                 {
  2.         
.         /* date ranges are applied in python, so presence of date indicates presence of 
>           disease in the correct time frame */ 
.         local newvar =  substr("`var'", 1, length("`var'") - 5)
  3.         gen `newvar' = (`var'!=. )
  4.         order `newvar', after(`var')
  5.         
. }

. 
. /* CREATE VARIABLES===========================================================*/
. 
. /* DEMOGRAPHICS */ 
. 
. * Sex
. gen male = 1 if sex == "M"
(1,410,997 missing values generated)

. replace male = 0 if sex == "F"
(1,410,953 real changes made)

. 
. * Ethnicity 
. replace ethnicity = .u if ethnicity == .
(562,149 real changes made, 562,149 to missing)

. 
. label define ethnicity  1 "White"                                       ///
>                                                 2 "Mixed"                                       ///
>                                                 3 "Asian or Asian British"      ///
>                                                 4 "Black"                                       ///
>                                                 5 "Other"                                       ///
>                                                 .u "Unknown"

. 
. label values ethnicity ethnicity

. 
. * STP 
. rename stp stp_old

. bysort stp_old: gen stp = 1 if _n==1
(2,463,778 missing values generated)

. replace stp = sum(stp)
(2,463,809 real changes made)

. drop stp_old

. 
. /*  IMD  */
. * Group into 5 groups
. rename imd imd_o

. egen imd = cut(imd_o), group(5) icodes

. 
. * add one to create groups 1 - 5 
. replace imd = imd + 1
(2,463,810 real changes made)

. 
. * - 1 is missing, should be excluded from population 
. replace imd = .u if imd_o == -1
(0 real changes made)

. drop imd_o

. 
. * Reverse the order (so high is more deprived)
. recode imd 5 = 1 4 = 2 3 = 3 2 = 4 1 = 5 .u = .u
(imd: 1973802 changes made)

. 
. label define imd 1 "1 least deprived" 2 "2" 3 "3" 4 "4" 5 "5 most deprived" .u "Unknown"

. label values imd imd 

. 
. /*  Age variables  */ 
. 
. * Create categorised age
. gen     agegroup=1 if age>=18 & age<40
(1,749,402 missing values generated)

. replace agegroup=2 if age>=40 & age<50
(500,289 real changes made)

. replace agegroup=3 if age>=50 & age<60
(557,017 real changes made)

. replace agegroup=4 if age>=60 & age<70
(389,860 real changes made)

. replace agegroup=5 if age>=70 & age<80
(231,515 real changes made)

. replace agegroup=6 if age>=80
(70,721 real changes made)

. replace agegroup=. if age==.
(0 real changes made)

. 
. label define agegroup   1 "18-<40" ///
>                                                 2 "40-<50" ///
>                                                 3 "50-<60" ///
>                                                 4 "60-<70" ///
>                                                 5 "70-<80" ///
>                                                 6 "80+"

.                                                 
. label values agegroup agegroup

. 
. * Create binary age
. gen     age70=0   if age>=18 & age<70
(302,236 missing values generated)

. replace age70=1   if age>=70
(302,236 real changes made)

. replace age70=.   if age==.
(0 real changes made)

. 
. * Check there are no missing ages
. assert age < .

. datacheck agegroup !=. , nolist

. datacheck age70    !=. , nolist

. 
. * Create restricted cubic splines fir age
. mkspline age = age, cubic nknots(4)

. 
. /*  Body Mass Index  */
. * NB: watch for missingness
. 
. * Recode strange values 
. replace bmi = . if bmi == 0 
(335,396 real changes made, 335,396 to missing)

. replace bmi = . if !inrange(bmi, 15, 50)
(22,765 real changes made, 22,765 to missing)

. 
. * Restrict to within 10 years of index and aged > 16 
. gen bmi_time = (date("$indexdate", "DMY") - bmi_measured_date)/365.25
(325,353 missing values generated)

. gen bmi_age = age - bmi_time
(325,353 missing values generated)

. 
. replace bmi = . if bmi_age < 16 
(4,304 real changes made, 4,304 to missing)

. replace bmi = . if bmi_time > 10 & bmi_time != . 
(2,630 real changes made, 2,630 to missing)

. 
. * Set to missing if no date, and vice versa 
. replace bmi = . if bmi_measured_date == . 
(0 real changes made)

. replace bmi_measured_date = . if bmi == . 
(39,742 real changes made, 39,742 to missing)

. replace bmi_measured_date = . if bmi == . 
(0 real changes made)

. 
. gen     bmicat = .
(2,463,810 missing values generated)

. recode  bmicat . = 1 if bmi < 18.5
(bmicat: 32480 changes made)

. recode  bmicat . = 2 if bmi < 25
(bmicat: 599554 changes made)

. recode  bmicat . = 3 if bmi < 30
(bmicat: 736684 changes made)

. recode  bmicat . = 4 if bmi < 35
(bmicat: 439587 changes made)

. recode  bmicat . = 5 if bmi < 40
(bmicat: 188469 changes made)

. recode  bmicat . = 6 if bmi < .
(bmicat: 101941 changes made)

. replace bmicat = .u if bmi >= .
(365,095 real changes made, 365,095 to missing)

. 
. label define bmicat 1 "Underweight (<18.5)"     ///
>                                         2 "Normal (18.5-24.9)"          ///
>                                         3 "Overweight (25-29.9)"        ///
>                                         4 "Obese I (30-34.9)"           ///
>                                         5 "Obese II (35-39.9)"          ///
>                                         6 "Obese III (40+)"                     ///
>                                         .u "Unknown (.u)"

.                                         
. label values bmicat bmicat

. 
. * Create less  granular categorisation
. recode bmicat 1/3 .u = 1 4 = 2 5 = 3 6 = 4, gen(obese4cat)
(2431330 differences between bmicat and obese4cat)

. 
. label define obese4cat  1 "No record of obesity"        ///
>                                                 2 "Obese I (30-34.9)"           ///
>                                                 3 "Obese II (35-39.9)"          ///
>                                                 4 "Obese III (40+)"             

. 
. label values obese4cat obese4cat

. order obese4cat, after(bmicat)

. 
. /*  Smoking  */
. 
. * Smoking 
. label define smoke 1 "Never" 2 "Former" 3 "Current" .u "Unknown (.u)"

. 
. gen     smoke = 1  if smoking_status == "N"
(1,402,223 missing values generated)

. replace smoke = 2  if smoking_status == "E"
(872,464 real changes made)

. replace smoke = 3  if smoking_status == "S"
(492,616 real changes made)

. replace smoke = .u if smoking_status == "M"
(37,143 real changes made, 37,143 to missing)

. replace smoke = .u if smoking_status == "" 
(0 real changes made)

. 
. label values smoke smoke

. drop smoking_status

. 
. * Create non-missing 3-category variable for current smoking
. * Assumes missing smoking is never smoking 
. recode smoke .u = 1, gen(smoke_nomiss)
(37143 differences between smoke and smoke_nomiss)

. order smoke_nomiss, after(smoke)

. label values smoke_nomiss smoke

. 
. /* CLINICAL COMORBIDITIES */ 
. 
. /* GP consultation rate */ 
. replace gp_consult_count = 0 if gp_consult_count <1 
(0 real changes made)

. 
. * those with no count assumed to have no visits 
. replace gp_consult_count = 0 if gp_consult_count == . 
(0 real changes made)

. gen gp_consult = (gp_consult_count >=1)

. 
. /* A&E attendance rate */
. rename annde_attendance_last_year aande_attendance_count

. replace aande_attendance_count = 0 if aande_attendance_count <1 
(0 real changes made)

. 
. * those with no count assumed to have no visits 
. replace aande_attendance_count = 0 if aande_attendance_count == . 
(0 real changes made)

. gen aande_attendance_last_year = (aande_attendance_count >=1)

. 
. /* Vaccines */ 
. replace pneumococcal_vaccine = 0 if pneumococcal_vaccine == . 
(0 real changes made)

. replace flu_vaccine = 0 if flu_vaccine == . 
(0 real changes made)

. 
. /* Immunosuppression */
. 
. * Immunosuppressed:
. * permanent immunodeficiency ever, OR 
. * temporary immunodeficiency or aplastic anaemia last year
. * in python, index date not inclusive for defining temp_immunodef_date & aplastic_anaemia_date
. gen temp1  = (perm_immunodef_date               < .)

. gen temp2  = inrange(temp_immunodef_date, (date("$indexdate", "DMY") - 365), date("$indexdate", "DMY"))

. gen temp3  = inrange(aplastic_anaemia_date, (date("$indexdate", "DMY") - 365), date("$indexdate", "DMY"))

. 
. egen immunodef_any = rowmax(temp1 temp2 temp3)

. drop temp1 temp2 temp3

. order immunodef_any, after(temp_immunodef_date)

. 
. /* eGFR */
. 
. * Set implausible creatinine values to missing (Note: zero changed to missing)
. replace creatinine = . if !inrange(creatinine, 20, 3000) 
(1,329,224 real changes made, 1,329,224 to missing)

. 
. * Remove creatinine dates if no measurements, and vice versa 
. replace creatinine = . if creatinine_measured_date == . 
(0 real changes made)

. replace creatinine_measured_date = . if creatinine == . 
(1,846 real changes made, 1,846 to missing)

. replace creatinine_measured = . if creatinine == . 
(1,329,224 real changes made, 1,329,224 to missing)

. 
. * Divide by 88.4 (to convert umol/l to mg/dl)
. gen SCr_adj = creatinine/88.4
(1,329,224 missing values generated)

. 
. gen min = .
(2,463,810 missing values generated)

. replace min = SCr_adj/0.7 if male==0
(687,804 real changes made)

. replace min = SCr_adj/0.9 if male==1
(446,759 real changes made)

. replace min = min^-0.329  if male==0
(687,804 real changes made)

. replace min = min^-0.411  if male==1
(446,759 real changes made)

. replace min = 1 if min<1
(722,749 real changes made)

. 
. gen max=.
(2,463,810 missing values generated)

. replace max=SCr_adj/0.7 if male==0
(687,804 real changes made)

. replace max=SCr_adj/0.9 if male==1
(446,759 real changes made)

. replace max=max^-1.209
(1,134,563 real changes made)

. replace max=1 if max>1
(1,741,061 real changes made)

. 
. gen egfr=min*max*141
(1,329,247 missing values generated)

. replace egfr=egfr*(0.993^age)
(1,134,563 real changes made)

. replace egfr=egfr*1.018 if male==0
(687,804 real changes made)

. label var egfr "egfr calculated using CKD-EPI formula with no eth"

. 
. * Categorise into ckd stages
. egen egfr_cat = cut(egfr), at(0, 15, 30, 45, 60, 5000)
(1329247 missing values generated)

. recode egfr_cat 0 = 5 15 = 4 30 = 3 45 = 2 60 = 0, generate(ckd_egfr)
(1134563 differences between egfr_cat and ckd_egfr)

. 
. * 0 = "No CKD"  2 "stage 3a" 3 "stage 3b" 4 "stage 4" 5 "stage 5"
. 
. * Add in end stage renal failure and create a single CKD variable 
. * Missing assumed to not have CKD 
. gen ckd = 0

. replace ckd = 1 if ckd_egfr != . & ckd_egfr >= 1
(68,769 real changes made)

. replace ckd = 1 if esrf == 1
(447 real changes made)

. 
. label define ckd 0 "No CKD" 1 "CKD"

. label values ckd ckd

. label var ckd "CKD stage calc without eth"

. 
. * Create date (most recent measure prior to index)
. gen temp1_ckd_date = creatinine_measured_date if ckd_egfr >=1
(2,395,018 missing values generated)

. gen temp2_ckd_date = esrf_date if esrf == 1
(2,463,223 missing values generated)

. gen ckd_date = max(temp1_ckd_date,temp2_ckd_date) 
(2,394,571 missing values generated)

. format ckd_date %td 

. 
. /* Hb1AC */
. 
. /* Diabetes severity */
. 
. * Set zero or negative to missing
. replace hba1c_percentage   = . if hba1c_percentage <= 0
(2,079,888 real changes made, 2,079,888 to missing)

. replace hba1c_mmol_per_mol = . if hba1c_mmol_per_mol <= 0
(851,325 real changes made, 851,325 to missing)

. 
. /* Express HbA1c as percentage  */ 
. 
. * Express all values as perecentage 
. noi summ hba1c_percentage hba1c_mmol_per_mol 

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
hba1c_perc~e |    383,922    5.980113    2.895871         .1        354
hba1c_mmol~l |  1,612,485    39.85423    161.9462         .7      42000

. gen     hba1c_pct = hba1c_percentage 
(2,079,888 missing values generated)

. replace hba1c_pct = (hba1c_mmol_per_mol/10.929)+2.15 if hba1c_mmol_per_mol<. 
(1,612,485 real changes made)

. 
. * Valid % range between 0-20  
. replace hba1c_pct = . if !inrange(hba1c_pct, 0, 20) 
(77 real changes made, 77 to missing)

. replace hba1c_pct = round(hba1c_pct, 0.1)
(1,612,516 real changes made)

. 
. /* Categorise hba1c and diabetes  */
. 
. * Group hba1c
. gen     hba1ccat = 0 if hba1c_pct <  6.5
(990,147 missing values generated)

. replace hba1ccat = 1 if hba1c_pct >= 6.5  & hba1c_pct < 7.5
(80,754 real changes made)

. replace hba1ccat = 2 if hba1c_pct >= 7.5  & hba1c_pct < 8
(19,515 real changes made)

. replace hba1ccat = 3 if hba1c_pct >= 8    & hba1c_pct < 9
(21,347 real changes made)

. replace hba1ccat = 4 if hba1c_pct >= 9    & hba1c_pct !=.
(26,736 real changes made)

. label define hba1ccat 0 "<6.5%" 1">=6.5-7.4" 2">=7.5-7.9" 3">=8-8.9" 4">=9"

. label values hba1ccat hba1ccat

. safetab hba1ccat
0

   hba1ccat |      Freq.     Percent        Cum.
------------+-----------------------------------
      <6.5% |  1,473,663       90.85       90.85
  >=6.5-7.4 |     80,754        4.98       95.83
  >=7.5-7.9 |     19,515        1.20       97.04
    >=8-8.9 |     21,347        1.32       98.35
        >=9 |     26,736        1.65      100.00
------------+-----------------------------------
      Total |  1,622,015      100.00

. 
. * Create diabetes, split by control/not
. gen     diabcat = 1 if diabetes==0
(237,408 missing values generated)

. replace diabcat = 2 if diabetes==1 & inlist(hba1ccat, 0, 1)
(164,794 real changes made)

. replace diabcat = 3 if diabetes==1 & inlist(hba1ccat, 2, 3, 4)
(66,775 real changes made)

. replace diabcat = 4 if diabetes==1 & !inlist(hba1ccat, 0, 1, 2, 3, 4)
(5,839 real changes made)

. 
. label define diabcat    1 "No diabetes"                         ///
>                                                 2 "Controlled diabetes"         ///
>                                                 3 "Uncontrolled diabetes"       ///
>                                                 4 "Diabetes, no hba1c measure"

. label values diabcat diabcat

. 
. * Create new diabetes variable, group Diabetes, no hba1c with uncontrolled diabetes
. clonevar diab_control = diabcat

. recode diab_control 4=3
(diab_control: 5839 changes made)

. 
. * Delete unneeded variables
. drop hba1c_pct hba1c_percentage hba1c_mmol_per_mol

. 
. /* Rheumatoid/osteoarthritis/both for cohort 2 */
. gen arthritis_type=1 if rheumatoid == 1 & osteoarthritis == 0
(2,433,410 missing values generated)

. replace arthritis_type=2 if rheumatoid == 0 & osteoarthritis == 1
(510,838 real changes made)

. replace arthritis_type=3 if rheumatoid == 1 & osteoarthritis == 1
(19,821 real changes made)

. replace arthritis_type=0 if arthritis_type==.
(1,902,751 real changes made)

. 
. label define arthcat    1 "Rheumatoid arthritis"                        ///
>                                                 2 "Osteoarthritis"              ///
>                                                 3 "Both RA & OA"        ///
>                                                 0 "None"

.                                                 
. label values arthritis_type arthcat

. 
. 
. /* LABEL VARIABLES============================================================*/
. *  Label variables you are intending to keep, drop the rest 
. 
. * Demographics
. label var patient_id                            "Patient ID"

. label var age                                           "Age (years)"

. label var agegroup                                      "Grouped age"

. label var age70                                         "70 years and older"

. label var sex                                           "Sex"

. label var male                                          "Male"

. label var bmi                                           "Body Mass Index (BMI, kg/m2)"

. label var bmicat                                        "Grouped BMI"

. label var bmi_measured_date             "Body Mass Index (BMI, kg/m2), date measured"

. label var obese4cat                                     "Evidence of obesity (4 categories)"

. label var smoke                                         "Smoking status"

. label var smoke_nomiss                          "Smoking status (missing set to non)"

. label var imd                                           "Index of Multiple Deprivation (IMD)"

. label var ethnicity                                     "Ethnicity"

. label var stp                                           "Sustainability and Transformation Partnership"

. 
. label var age1                                          "Age spline 1"

. label var age2                                          "Age spline 2"

. label var age3                                          "Age spline 3"

. 
. * Treatment variables (date)
. label var nsaid_last_three_years_date "latest date of exposure to NSAIDs in past 3 years"

. label var nsaid_after_march           "Earliest date of exposure to NSAIDs after cohort entry"

. label var nsaid_last_four_months_date "latest date of exposure to NSAIDs in past 4 months"

. label var nsaid_last_two_months_date  "latest date of exposure to NSAIDs in past 2 months"

. label var nsaid_last_month_date       "latest date of exposure to NSAIDs in the past month"

. label var recent_stop_nsaid_date      "latest date of exposure to NSAIDs in past 2 years but not current exposure window"
note: label truncated to 80 characters

. label var naproxen_high_date          "latest date of exposure to high Dose naproxen"

. label var naproxen_low_date               "latest date of exposure to low Dose naproxen"

. label var naproxen_other_date             "latest date of exposure to naproxen other doses"

. label var cox_medication_date             "latest date of exposure to Cox-specific NSAIDs"

. label var indometacin_date                "latest date of exposure to indometacin"

. label var ibuprofen_date              "latest date of exposure to ibuprofen"

. 
. * Comorbidities/medications of interest
. label var ckd                                                   "Chronic kidney disease" 

. label var egfr_cat                                              "Calculated eGFR"

. label var hypertension                              "Diagnosed hypertension"

. label var heart_failure                             "Heart Failure"

. label var other_respiratory                     "Other Respiratory Diseases"

. label var other_heart_disease                   "Other Heart Diseases"

. label var copd                                                  "COPD"

. label var diabetes                                              "Diabetes"

. label var cancer                                        "Cancer"

. label var immunodef_any                                 "Immunosuppressed (combination algorithm)"

. label var diabcat                                               "Diabetes Severity"

. label var diab_control                  "Diabetes Severity: group no Hb1AC with uncontrolled DM"

. label var rheumatoid                    "Rheumatoid arthritis"

. label var osteoarthritis                "Osteoarthritis"

. label var arthritis_type                "Rheumatoid arthritis/osteoarthritis/both"

. 
. label var statin                                                "Recent Statin"

. label var ppi                                               "Recent PPIs"

. label var steroid_prednisolone          "Recent oral prednisolone"

. label var hydroxychloroquine            "Recent hydroxychloroquine"

. label var dmards_primary_care           "Recent Other DMARDs use"

. label var indometacin                   "Indometacin use in past 4 months"

. label var aspirin_ever                  "Aspirin ever use"

. label var flu_vaccine                                   "Flu vaccine"

. label var pneumococcal_vaccine                  "Pneumococcal Vaccine"

. label var gp_consult                                    "GP consultation in last year (binary)"

. label var gp_consult_count                              "GP consultation count"

. label var aande_attendance_last_year    "A&E attendance rate in last year (binary)"

. label var aande_attendance_count        "A&E attendance count"

. 
. label var ckd_date                                      "Chronic kidney disease Date" 

. label var hypertension_date                         "Diagnosed hypertension Date"

. label var heart_failure_date                    "Heart Failure Date"

. label var other_respiratory_date                "Other Respiratory Diseases Date"

. label var other_heart_disease_date              "Other Heart Diseases Date"

. label var copd_date                                     "COPD Date"

. label var diabetes_date                                 "Diabetes Date"

. label var cancer_date                           "Cancer Date"

. label var rheumatoid_date                       "Rheumatoid arthritis Date"

. label var osteoarthritis_date               "Osteoarthritis Date"

. 
. label var statin_date                                   "Recent Statin Date"

. label var ppi_date                                      "Recent PPI Date"

. label var steroid_prednisolone_date     "Recent oral prednisolone Date"

. label var hydroxychloroquine_date       "Recent hydroxychloroquine Date"

. label var dmards_primary_care_date      "Recent other DMARDs Date"

. 
. *Exclusion criteria related variables
. label var mi                           "Myocardial infarction Date"

. label var stroke                       "Stroke Date"

. label var gi_bleed_ulcer               "Gastrointestinal bleeding Date"

. label var asthma                                "Asthma date"

. label var saba_single                  "Asthma treatment (saba_single) date"

. label var aspirin_ever_date            "Any aspirin Date"

. 
. *Useful outcome variables
. label var died_date_ons                 "ONS death date (any cause)"

. label var died_ons_covid_flag_any       "Binary indicator: ONS any covid"

. label var died_ons_covid_flag_underlying "Binary indicator: ONS underlying covid (subset of any)"

. 
. *label var aande_attendance_with_covid   "AE attendance due to Covid-19"
. 
. /* TIDY DATA==================================================================*/
. *  Drop variables that are needed (those labelled)
. ds, not(varlabel)
aande_atte~d  rural_urban   smoking_st~e  hb1ac_perc~e  temp_immun~e  creatinine~d  flu_vacci~le  pneumococ~le  has_consul~y  SCr_adj       temp1_ckd_~e
aspirin_te~s  ethnicity_~e  smoking_st~d  perm_immun~e  creatinine    esrf_date     flu_vaccin~d  pneumococc~d  bmi_time      min           temp2_ckd_~e
msoa          bmi_measured  hba1c_mmol~e  aplastic_a~e  creatinine~e  esrf          flu_vaccin~l  pneumococc~l  bmi_age       max           hba1ccat

. drop `r(varlist)'

.         
. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\nsaids-covid-research\analysis\nsaid_log_sens9\00a_cr_create_analysis_dataset.log
  log type:  text
 closed on:   8 Oct 2020, 00:02:31
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
