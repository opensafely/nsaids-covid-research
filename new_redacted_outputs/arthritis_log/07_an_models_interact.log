------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\caroline\nsaids-covid-research\analysis\arthritis_log\07_an_models_interact.log
  log type:  text
 opened on:  27 Jul 2020, 14:45:22

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Age Interaction============================================================*/ 
. 
. /* Check Counts */ 
. 
. bysort age70: safetab exposure $outcome, row

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> age70 = 0
23

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use |   840,244        255 |   840,499 
                      |     99.97       0.03 |    100.00 
----------------------+----------------------+----------
    current NSAID use |   122,629         40 |   122,669 
                      |     99.97       0.03 |    100.00 
----------------------+----------------------+----------
                Total |   962,873        295 |   963,168 
                      |     99.97       0.03 |    100.00 

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> age70 = 1
23

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use |   692,736      2,186 |   694,922 
                      |     99.69       0.31 |    100.00 
----------------------+----------------------+----------
    current NSAID use |    52,879         83 |    52,962 
                      |     99.84       0.16 |    100.00 
----------------------+----------------------+----------
                Total |   745,615      2,269 |   747,884 
                      |     99.70       0.30 |    100.00 

. 
. /* Univariable model */ 
. 
. stcox i.exposure i.age70

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -36758.737
Iteration 1:   log likelihood =     -35645
Iteration 2:   log likelihood = -35610.004
Iteration 3:   log likelihood = -35609.302
Iteration 4:   log likelihood = -35609.301
Refining estimates:
Iteration 0:   log likelihood = -35609.301

Cox regression -- Breslow method for ties

No. of subjects =    1,711,052                  Number of obs    =   1,711,052
No. of failures =        2,564
Time at risk    =    176820188
                                                LR chi2(2)       =     2298.87
Log likelihood  =   -35609.301                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   .5922759   .0548174    -5.66   0.000     .4940173    .7100778
           1.age70 |   9.652526    .598333    36.58   0.000     8.548253    10.89945
------------------------------------------------------------------------------------

. estimates store A

. 
. stcox i.exposure##i.age70

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -36758.737
Iteration 1:   log likelihood = -35636.394
Iteration 2:   log likelihood = -35603.683
Iteration 3:   log likelihood = -35602.838
Iteration 4:   log likelihood = -35602.837
Refining estimates:
Iteration 0:   log likelihood = -35602.837

Cox regression -- Breslow method for ties

No. of subjects =    1,711,052                  Number of obs    =   1,711,052
No. of failures =        2,564
Time at risk    =    176820188
                                                LR chi2(3)       =     2311.80
Log likelihood  =   -35602.837                  Prob > chi2      =      0.0000

--------------------------------------------------------------------------------------
                  _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
---------------------+----------------------------------------------------------------
            exposure |
  current NSAID use  |   1.055509   .1795035     0.32   0.751     .7563165    1.473059
             1.age70 |   10.33959    .684214    35.30   0.000     9.081878    11.77147
                     |
      exposure#age70 |
current NSAID use#1  |   .4663342   .0949162    -3.75   0.000     .3129295    .6949413
--------------------------------------------------------------------------------------

. estimates store B

. estimates save ./$tempdir/univar_int, replace 
file ./arthritis_tempdata/univar_int.ster saved

. 
. lrtest A B

Likelihood-ratio test                                 LR chi2(1)  =     12.93
(Assumption: A nested in B)                           Prob > chi2 =    0.0003

. local univar_p = round(r(p),0.001)

. 
. /* Multivariable models */ 
. 
. * Age and Gender 
. 
. stcox i.exposure i.age70 i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -36758.737
Iteration 1:   log likelihood =  -34954.88
Iteration 2:   log likelihood = -34476.708
Iteration 3:   log likelihood = -34466.027
Iteration 4:   log likelihood = -34465.765
Iteration 5:   log likelihood = -34465.764
Iteration 6:   log likelihood = -34465.764
Refining estimates:
Iteration 0:   log likelihood = -34465.764

Cox regression -- Breslow method for ties

No. of subjects =    1,711,052                  Number of obs    =   1,711,052
No. of failures =        2,564
Time at risk    =    176820188
                                                LR chi2(6)       =     4585.94
Log likelihood  =   -34465.764                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   .8352464   .0779073    -1.93   0.054     .6956954     1.00279
           1.age70 |   .9362292   .1415488    -0.44   0.663     .6961273    1.259145
            1.male |   1.666131   .0671833    12.66   0.000     1.539523    1.803151
              age1 |    1.07426   .0215354     3.57   0.000      1.03287    1.117309
              age2 |   1.058993   .0519935     1.17   0.243     .9618375    1.165963
              age3 |   .9012751   .1578357    -0.59   0.553     .6394266    1.270352
------------------------------------------------------------------------------------

. estimates store A

. 
. stcox i.exposure##i.age70 i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -36758.737
Iteration 1:   log likelihood = -34950.969
Iteration 2:   log likelihood = -34474.784
Iteration 3:   log likelihood = -34464.112
Iteration 4:   log likelihood = -34463.847
Iteration 5:   log likelihood = -34463.846
Iteration 6:   log likelihood = -34463.846
Refining estimates:
Iteration 0:   log likelihood = -34463.846

Cox regression -- Breslow method for ties

No. of subjects =    1,711,052                  Number of obs    =   1,711,052
No. of failures =        2,564
Time at risk    =    176820188
                                                LR chi2(7)       =     4589.78
Log likelihood  =   -34463.846                  Prob > chi2      =      0.0000

--------------------------------------------------------------------------------------
                  _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
---------------------+----------------------------------------------------------------
            exposure |
  current NSAID use  |   1.124155   .1912487     0.69   0.492     .8054047    1.569055
             1.age70 |   .9750388   .1491379    -0.17   0.869     .7224797    1.315886
                     |
      exposure#age70 |
current NSAID use#1  |   .6652288   .1356345    -2.00   0.046     .4460857    .9920276
                     |
              1.male |   1.666594   .0672004    12.67   0.000     1.539954    1.803649
                age1 |    1.07461   .0215821     3.58   0.000     1.033132    1.117754
                age2 |   1.058923   .0520617     1.16   0.244     .9616464     1.16604
                age3 |   .9001718   .1578339    -0.60   0.549     .6383778    1.269325
--------------------------------------------------------------------------------------

. estimates store B

. estimates save ./$tempdir/multivar1_int, replace 
file ./arthritis_tempdata/multivar1_int.ster saved

. 
. lrtest A B

Likelihood-ratio test                                 LR chi2(1)  =      3.84
(Assumption: A nested in B)                           Prob > chi2 =    0.0501

. local multivar1_p = round(r(p),0.001)

. 
. * Age, Gender and Comorbidities 
. stcox i.exposure i.age70 i.male age1 age2 age3 $varlist, strata(stp)            

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -28512.712
Iteration 1:   log likelihood = -26349.634
Iteration 2:   log likelihood = -25764.706
Iteration 3:   log likelihood = -25748.964
Iteration 4:   log likelihood = -25748.751
Iteration 5:   log likelihood = -25748.751
Iteration 6:   log likelihood = -25748.751
Refining estimates:
Iteration 0:   log likelihood = -25748.751

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    1,711,052                  Number of obs    =   1,711,052
No. of failures =        2,564
Time at risk    =    176820188
                                                LR chi2(34)      =     5527.92
Log likelihood  =   -25748.751                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
    current NSAID use  |    .779126   .0750059    -2.59   0.010     .6451536     .940919
               1.age70 |   .9920407   .1514079    -0.05   0.958     .7355579    1.337957
                1.male |   1.659174   .0689063    12.19   0.000     1.529471    1.799877
                  age1 |   1.084506   .0222981     3.95   0.000     1.041671    1.129102
                  age2 |   1.034668   .0517689     0.68   0.496      .938019    1.141275
                  age3 |   .9605233   .1711754    -0.23   0.821     .6773527    1.362075
                       |
             obese4cat |
    Obese I (30-34.9)  |   .9840872    .055431    -0.28   0.776     .8812267    1.098954
   Obese II (35-39.9)  |   1.356232    .108527     3.81   0.000     1.159364    1.586529
      Obese III (40+)  |   1.992632   .2073899     6.62   0.000     1.624933    2.443537
                       |
          smoke_nomiss |
               Former  |   1.173021   .0508293     3.68   0.000     1.077511    1.276998
              Current  |   1.072336   .1019073     0.73   0.462     .8900996    1.291883
                       |
                   imd |
                    2  |   1.207367   .0820205     2.77   0.006     1.056852    1.379318
                    3  |   1.289593    .087577     3.75   0.000     1.128878    1.473188
                    4  |   1.536901   .1021876     6.46   0.000     1.349118    1.750821
      5 most deprived  |   1.916269   .1273993     9.78   0.000     1.682155    2.182965
                       |
                   ckd |
                  CKD  |   1.238602   .0568806     4.66   0.000     1.131988    1.355257
        1.hypertension |   1.062759   .0467847     1.38   0.167     .9749068    1.158527
       1.heart_failure |   1.446055   .0979053     5.45   0.000     1.266351     1.65126
 1.other_heart_disease |    1.10726   .0803913     1.40   0.161     .9603934    1.276586
                       |
          diab_control |
  Controlled diabetes  |   1.391894   .0733406     6.28   0.000     1.255322    1.543324
Uncontrolled diabetes  |   2.131814   .1605719    10.05   0.000     1.839227    2.470946
                       |
                1.copd |   1.183079   .0791582     2.51   0.012     1.037675    1.348859
   1.other_respiratory |   1.856685   .1355209     8.48   0.000     1.609194     2.14224
       1.immunodef_any |   1.593854   .3430153     2.17   0.030     1.045347     2.43017
              1.cancer |   1.297844    .062702     5.40   0.000      1.18059    1.426745
                       |
        arthritis_type |
       Osteoarthritis  |   .6352938   .0772938    -3.73   0.000     .5005093     .806375
         Both RA & OA  |   .8383715   .1186404    -1.25   0.213     .6353024     1.10635
                       |
              1.statin |    .648304   .0310148    -9.06   0.000     .5902789    .7120329
                 1.ppi |   1.254241   .0537803     5.28   0.000     1.153141    1.364204
1.steroid_prednisolone |   1.526927   .1061228     6.09   0.000     1.332475    1.749756
  1.hydroxychloroquine |   1.205895   .2227877     1.01   0.311     .8395586     1.73208
 1.dmards_primary_care |   1.189395     .14487     1.42   0.154     .9368035    1.510093
         1.flu_vaccine |   .9898552   .0485637    -0.21   0.835     .8991052    1.089765
1.pneumococcal_vaccine |    1.03799   .0731049     0.53   0.597     .9041568    1.191634
----------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates store A

. 
. stcox i.exposure##i.age70 i.male age1 age2 age3 $varlist, strata(stp)           

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -28512.712
Iteration 1:   log likelihood = -26348.305
Iteration 2:   log likelihood = -25763.926
Iteration 3:   log likelihood = -25748.193
Iteration 4:   log likelihood = -25747.977
Iteration 5:   log likelihood = -25747.976
Iteration 6:   log likelihood = -25747.976
Refining estimates:
Iteration 0:   log likelihood = -25747.976

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    1,711,052                  Number of obs    =   1,711,052
No. of failures =        2,564
Time at risk    =    176820188
                                                LR chi2(35)      =     5529.47
Log likelihood  =   -25747.976                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
    current NSAID use  |   .9369307   .1610528    -0.38   0.705     .6689458    1.312272
               1.age70 |   1.018161   .1570737     0.12   0.907     .7524886    1.377631
                       |
        exposure#age70 |
  current NSAID use#1  |   .7732285   .1578439    -1.26   0.208     .5182589    1.153636
                       |
                1.male |   1.659559   .0689226    12.20   0.000     1.529825    1.800295
                  age1 |   1.084968    .022346     3.96   0.000     1.042043    1.129661
                  age2 |   1.034374   .0518154     0.67   0.500     .9376443    1.141083
                  age3 |   .9602186   .1712941    -0.23   0.820     .6768987    1.362124
                       |
             obese4cat |
    Obese I (30-34.9)  |   .9839167   .0554231    -0.29   0.773      .881071    1.098767
   Obese II (35-39.9)  |   1.355338   .1084649     3.80   0.000     1.158585    1.585505
      Obese III (40+)  |   1.988823   .2070426     6.60   0.000     1.621748    2.438983
                       |
          smoke_nomiss |
               Former  |   1.172905   .0508243     3.68   0.000     1.077404    1.276871
              Current  |   1.071968   .1018762     0.73   0.465     .8897878    1.291448
                       |
                   imd |
                    2  |   1.207192   .0820088     2.77   0.006     1.056699    1.379118
                    3  |   1.289179   .0875498     3.74   0.000     1.128515    1.472718
                    4  |   1.536168   .1021411     6.46   0.000     1.348471    1.749991
      5 most deprived  |   1.914754   .1273049     9.77   0.000     1.680814    2.181254
                       |
                   ckd |
                  CKD  |   1.238517   .0568786     4.66   0.000     1.131907    1.355168
        1.hypertension |   1.062625   .0467775     1.38   0.168     .9747866    1.158379
       1.heart_failure |   1.444922   .0978303     5.44   0.000     1.265356     1.64997
 1.other_heart_disease |   1.106696   .0803513     1.40   0.163     .9599023    1.275938
                       |
          diab_control |
  Controlled diabetes  |   1.391551   .0733217     6.27   0.000     1.255014    1.542941
Uncontrolled diabetes  |    2.13106   .1605114    10.05   0.000     1.838583    2.470064
                       |
                1.copd |   1.182984    .079154     2.51   0.012     1.037588    1.348756
   1.other_respiratory |   1.856392   .1355022     8.48   0.000     1.608935    2.141908
       1.immunodef_any |   1.594787   .3432136     2.17   0.030     1.045962    2.431585
              1.cancer |   1.297757    .062699     5.39   0.000     1.180508    1.426652
                       |
        arthritis_type |
       Osteoarthritis  |   .6358142    .077371    -3.72   0.000     .5008979    .8070702
         Both RA & OA  |   .8395298   .1188123    -1.24   0.216     .6361683    1.107899
                       |
              1.statin |    .648195   .0310086    -9.06   0.000     .5901814    .7119111
                 1.ppi |   1.253898   .0537543     5.28   0.000     1.152846    1.363807
1.steroid_prednisolone |   1.526997   .1061244     6.09   0.000     1.332541    1.749829
  1.hydroxychloroquine |   1.204189   .2224784     1.01   0.315     .8383628    1.729646
 1.dmards_primary_care |    1.18831   .1447341     1.42   0.157     .9359547    1.508706
         1.flu_vaccine |   .9895988   .0485427    -0.21   0.831     .8988874    1.089464
1.pneumococcal_vaccine |   1.038157   .0731182     0.53   0.595      .904299    1.191828
----------------------------------------------------------------------------------------
                                                             Stratified by stp

. estimates store B

. estimates save ./$tempdir/multivar2_int, replace 
file ./arthritis_tempdata/multivar2_int.ster saved

. 
. lrtest A B

Likelihood-ratio test                                 LR chi2(1)  =      1.55
(Assumption: A nested in B)                           Prob > chi2 =    0.2133

. local multivar2_p = round(r(p),0.001)

. 
. /* Print interaction table====================================================*/ 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table3.txt, write text replace
(note: file ./arthritis_output/table3.txt not found)

. 
. * Column headings 
. file write tablecontent ("Table 3: Current NSAID use and $outcome, Age Interaction - $population Population") _n

. file write tablecontent  _tab ("Number of events") _tab ("Total person-weeks") _tab ("Rate per 1,000") _tab ("Univariable") _tab _tab _tab ("Age/Sex Adjusted") _tab _tab _tab  ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _tab _tab _n

. file write tablecontent _tab _tab _tab _tab ("HR") _tab ("95% CI") _tab ("p (interaction)") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("p (interaction)") _tab ("HR") _tab ("95% CI") _tab ("p (interaction)") _tab _n

. 
. * Overall p-values 
. file write tablecontent ("Agegroup") _tab _tab _tab _tab _tab _tab ("`univar_p'") ///
>                                                 _tab _tab _tab ("`multivar1_p'") /// 
>                                                 _tab _tab _tab ("`multivar2_p'") _n

. 
.                                                 
. * Generic program to print model for a level of another variable 
. cap prog drop printinteraction

. prog define printinteraction 
  1. syntax, variable(varname) min(real) max(real) 
  2. 
.         forvalues varlevel = `min'/`max'{ 
  3. 
.                 * Row headings 
.                 file write tablecontent ("`varlevel'") _n       
  4. 
.                 local lab0: label exposure 0
  5.                 local lab1: label exposure 1
  6.                  
.                 /* Counts */
.                         
.                 * First row, exposure = 0 (reference)
.                 
.         file write tablecontent ("`lab0'") _tab
  7. 
.                         safecount if exposure == 0  & `variable' == `varlevel' & $outcome == 1
  8.             local event = r(N)
  9.                     bysort exposure `variable': egen total_follow_up = total(_t)
 10.             su total_follow_up if exposure == 0 & `variable' == `varlevel'
 11.             local person_week = r(mean)/7
 12.             local rate = 1000*(`event'/`person_week')
 13. 
.                         
.                 file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab
 14.         file write tablecontent ("1.00 (ref)") _tab _tab _tab ("1.00 (ref)") _tab _tab _tab ("1.00 (ref)") _n
 15. 
.                         
.                 * Second row, exposure = 1 (NSAID)
. 
.                 file write tablecontent ("`lab1'") _tab  
 16. 
. 
.                         safecount if exposure == 1 & `variable' == `varlevel' & $outcome == 1
 17.                 local event = r(N)
 18.             su total_follow_up if exposure == 1 & `variable' == `varlevel'
 19.             local person_week = r(mean)/7
 20.             local rate = 1000*(`event'/`person_week')
 21.             file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab
 22. 
.                 * Print models 
.                 estimates use ./$tempdir/univar_int 
 23.                 qui lincom 1.exposure + 1.exposure#`varlevel'.`variable', eform
 24.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab _tab
 25. 
.                 estimates use ./$tempdir/multivar1_int
 26.                 qui lincom 1.exposure + 1.exposure#`varlevel'.`variable', eform
 27.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab _tab
 28. 
.                 estimates use ./$tempdir/multivar2_int
 29.                 qui lincom 1.exposure + 1.exposure#`varlevel'.`variable', eform
 30.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab _n 
 31. 
.                 drop total_follow_up
 32.         } 
 33.                 
. end

. 
. printinteraction, variable(age70) min(0) max(1) 
  255

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    840,499    8.66e+07           0   8.66e+07   8.66e+07
  40

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    122,669    1.29e+07           0   1.29e+07   1.29e+07
  2,186

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    694,922    7.18e+07           0   7.18e+07   7.18e+07
  83

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |     52,962     5538445           0    5538445    5538445

. 
. file write tablecontent _n

. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\caroline\nsaids-covid-research\analysis\arthritis_log\07_an_models_interact.log
  log type:  text
 closed on:  27 Jul 2020, 14:56:43
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
