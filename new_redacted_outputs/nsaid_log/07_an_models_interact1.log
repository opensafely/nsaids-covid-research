------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\caroline\nsaids-covid-research\analysis\nsaid_log\07_an_models_interact1.log
  log type:  text
 opened on:  27 Jul 2020, 10:59:43

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Age Interaction============================================================*/ 
. 
. /* Check Counts */ 
. 
. bysort age70: safetab exposure $outcome, row

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> age70 = 0
23

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use | 1,699,841        224 | 1,700,065 
                      |     99.99       0.01 |    100.00 
----------------------+----------------------+----------
    current NSAID use |   457,238         96 |   457,334 
                      |     99.98       0.02 |    100.00 
----------------------+----------------------+----------
                Total | 2,157,079        320 | 2,157,399 
                      |     99.99       0.01 |    100.00 

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> age70 = 1
23

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use |   223,643        387 |   224,030 
                      |     99.83       0.17 |    100.00 
----------------------+----------------------+----------
    current NSAID use |    78,063        122 |    78,185 
                      |     99.84       0.16 |    100.00 
----------------------+----------------------+----------
                Total |   301,706        509 |   302,215 
                      |     99.83       0.17 |    100.00 

. 
. /* Univariable model */ 
. 
. stcox i.exposure i.age70

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -12180.875
Iteration 1:   log likelihood = -11962.018
Iteration 2:   log likelihood = -11633.589
Iteration 3:   log likelihood = -11622.547
Iteration 4:   log likelihood = -11622.543
Refining estimates:
Iteration 0:   log likelihood = -11622.543

Cox regression -- Breslow method for ties

No. of subjects =    2,459,614                  Number of obs    =   2,459,614
No. of failures =          829
Time at risk    =    252524169
                                                LR chi2(2)       =     1116.66
Log likelihood  =   -11622.543                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   1.095403   .0865502     1.15   0.249     .9382501    1.278878
           1.age70 |   11.34418   .8105495    33.99   0.000     9.861758    13.04945
------------------------------------------------------------------------------------

. estimates store A

. 
. stcox i.exposure##i.age70

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -12180.875
Iteration 1:   log likelihood = -11976.051
Iteration 2:   log likelihood = -11646.156
Iteration 3:   log likelihood = -11617.257
Iteration 4:   log likelihood = -11616.321
Iteration 5:   log likelihood =  -11616.32
Refining estimates:
Iteration 0:   log likelihood =  -11616.32

Cox regression -- Breslow method for ties

No. of subjects =    2,459,614                  Number of obs    =   2,459,614
No. of failures =          829
Time at risk    =    252524169
                                                LR chi2(3)       =     1129.11
Log likelihood  =    -11616.32                  Prob > chi2      =      0.0000

--------------------------------------------------------------------------------------
                  _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
---------------------+----------------------------------------------------------------
            exposure |
  current NSAID use  |   1.551322   .1892424     3.60   0.000     1.221422    1.970327
             1.age70 |   13.17864   1.106399    30.71   0.000     11.17915    15.53576
                     |
      exposure#age70 |
current NSAID use#1  |   .5660907   .0906835    -3.55   0.000     .4135518    .7748938
--------------------------------------------------------------------------------------

. estimates store B

. estimates save ./$tempdir/univar_int, replace 
file ./nsaid_tempdata/univar_int.ster saved

. 
. lrtest A B

Likelihood-ratio test                                 LR chi2(1)  =     12.44
(Assumption: A nested in B)                           Prob > chi2 =    0.0004

. local univar_p = round(r(p),0.001)

. 
. /* Multivariable models */ 
. 
. * Age and Gender 
. 
. stcox i.exposure i.age70 i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -12180.875
Iteration 1:   log likelihood = -12007.184
Iteration 2:   log likelihood = -11649.711
Iteration 3:   log likelihood = -11389.339
Iteration 4:   log likelihood = -11243.591
Iteration 5:   log likelihood = -11225.897
Iteration 6:   log likelihood = -11223.144
Iteration 7:   log likelihood = -11222.808
Iteration 8:   log likelihood = -11222.801
Iteration 9:   log likelihood = -11222.801
Refining estimates:
Iteration 0:   log likelihood = -11222.801

Cox regression -- Breslow method for ties

No. of subjects =    2,459,614                  Number of obs    =   2,459,614
No. of failures =          829
Time at risk    =    252524169
                                                LR chi2(6)       =     1916.15
Log likelihood  =   -11222.801                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   1.087866   .0860553     1.06   0.287     .9316251    1.270309
           1.age70 |    .705208   .0901161    -2.73   0.006     .5489656    .9059189
            1.male |   2.124676    .150742    10.62   0.000     1.848849    2.441653
              age1 |   1.162064   .0517259     3.37   0.001      1.06498    1.267999
              age2 |   .8726998   .0741285    -1.60   0.109     .7388605    1.030783
              age3 |   1.623806   .3933345     2.00   0.045     1.010061    2.610482
------------------------------------------------------------------------------------

. estimates store A

. 
. stcox i.exposure##i.age70 i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -12180.875
Iteration 1:   log likelihood = -12010.371
Iteration 2:   log likelihood = -11684.514
Iteration 3:   log likelihood = -11429.982
Iteration 4:   log likelihood = -11257.026
Iteration 5:   log likelihood = -11225.413
Iteration 6:   log likelihood =   -11222.1
Iteration 7:   log likelihood = -11221.654
Iteration 8:   log likelihood = -11221.642
Iteration 9:   log likelihood = -11221.642
Refining estimates:
Iteration 0:   log likelihood = -11221.642

Cox regression -- Breslow method for ties

No. of subjects =    2,459,614                  Number of obs    =   2,459,614
No. of failures =          829
Time at risk    =    252524169
                                                LR chi2(7)       =     1918.47
Log likelihood  =   -11221.642                  Prob > chi2      =      0.0000

--------------------------------------------------------------------------------------
                  _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
---------------------+----------------------------------------------------------------
            exposure |
  current NSAID use  |   1.258148   .1538885     1.88   0.060     .9899612    1.598988
             1.age70 |   .7614281   .1047651    -1.98   0.048     .5814493    .9971167
                     |
      exposure#age70 |
current NSAID use#1  |   .7826242   .1257024    -1.53   0.127     .5712632    1.072187
                     |
              1.male |    2.12629   .1508525    10.63   0.000      1.85026    2.443499
                age1 |   1.161472   .0516873     3.36   0.001     1.064459    1.267327
                age2 |    .872569   .0741014    -1.61   0.108     .7387763    1.030592
                age3 |   1.625024   .3935558     2.00   0.045     1.010909    2.612208
--------------------------------------------------------------------------------------

. estimates store B

. estimates save ./$tempdir/multivar1_int, replace 
file ./nsaid_tempdata/multivar1_int.ster saved

. 
. lrtest A B

Likelihood-ratio test                                 LR chi2(1)  =      2.32
(Assumption: A nested in B)                           Prob > chi2 =    0.1279

. local multivar1_p = round(r(p),0.001)

. 
. * Age, Gender and Comorbidities 
. stcox i.exposure i.age70 i.male age1 age2 age3 $varlist, strata(stp)            

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -9513.8021
Iteration 1:   log likelihood = -8589.9276
Iteration 2:   log likelihood = -8333.8364
Iteration 3:   log likelihood = -8314.9665
Iteration 4:   log likelihood = -8312.0629
Iteration 5:   log likelihood = -8311.6943
Iteration 6:   log likelihood = -8311.6857
Iteration 7:   log likelihood = -8311.6857
Refining estimates:
Iteration 0:   log likelihood = -8311.6857

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    2,459,614                  Number of obs    =   2,459,614
No. of failures =          829
Time at risk    =    252524169
                                                LR chi2(34)      =     2404.23
Log likelihood  =   -8311.6857                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
    current NSAID use  |   .9504957   .0838839    -0.58   0.565     .7995198    1.129981
               1.age70 |   .7121336   .0933051    -2.59   0.010     .5508527    .9206352
                1.male |   2.163864   .1574553    10.61   0.000     1.876254    2.495561
                  age1 |     1.1499   .0510442     3.15   0.002     1.054084    1.254426
                  age2 |   .8881211   .0759815    -1.39   0.165     .7510161    1.050256
                  age3 |   1.521084   .3734279     1.71   0.088     .9401181    2.461072
                       |
             obese4cat |
    Obese I (30-34.9)  |   1.100961   .1005219     1.05   0.292     .9205643     1.31671
   Obese II (35-39.9)  |   1.557062   .1923693     3.58   0.000     1.222202    1.983667
      Obese III (40+)  |   1.622267   .2887023     2.72   0.007     1.144565    2.299345
                       |
          smoke_nomiss |
               Former  |   1.052653    .080794     0.67   0.504     .9056349    1.223537
              Current  |   .8112568   .1112329    -1.53   0.127     .6200811    1.061373
                       |
                   imd |
                    2  |   1.504886    .169173     3.64   0.000       1.2073    1.875825
                    3  |   1.533206   .1784395     3.67   0.000     1.220492    1.926044
                    4  |   1.833058   .2163687     5.13   0.000     1.454464      2.3102
      5 most deprived  |   2.357254   .2875044     7.03   0.000     1.856046    2.993807
                       |
                   ckd |
                  CKD  |   1.419258    .135066     3.68   0.000     1.177756    1.710281
        1.hypertension |   1.044451   .0806072     0.56   0.573     .8978319    1.215013
       1.heart_failure |   1.603405    .269595     2.81   0.005     1.153249    2.229274
 1.other_heart_disease |   1.124651   .1871932     0.71   0.480     .8115945    1.558463
                       |
          diab_control |
  Controlled diabetes  |   1.467061   .1409271     3.99   0.000     1.215293    1.770986
Uncontrolled diabetes  |   2.221687   .2947211     6.02   0.000     1.713032    2.881378
                       |
                1.copd |   1.321206   .1638432     2.25   0.025     1.036126    1.684722
   1.other_respiratory |   2.400502   .3233049     6.50   0.000     1.843573    3.125675
       1.immunodef_any |   2.422389   .7097469     3.02   0.003     1.364101    4.301712
              1.cancer |   2.020485   .1689144     8.41   0.000     1.715119    2.380218
          1.rheumatoid |   1.253689   .2422657     1.17   0.242     .8584233    1.830956
      1.osteoarthritis |   .8597647   .0648458    -2.00   0.045     .7416169    .9967348
              1.statin |   .6930824    .058705    -4.33   0.000      .587066    .8182439
                 1.ppi |   1.422184   .1136418     4.41   0.000     1.216016    1.663307
1.steroid_prednisolone |   1.513215   .1934059     3.24   0.001     1.177897    1.943989
  1.hydroxychloroquine |   1.378704   .4084856     1.08   0.278     .7713919    2.464149
 1.dmards_primary_care |     1.5669   .3370263     2.09   0.037     1.027911    2.388511
         1.flu_vaccine |   1.068425   .0934394     0.76   0.449     .9001237    1.268196
1.pneumococcal_vaccine |   1.040344   .1122611     0.37   0.714     .8420267     1.28537
----------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates store A

. 
. stcox i.exposure##i.age70 i.male age1 age2 age3 $varlist, strata(stp)           

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -9513.8021
Iteration 1:   log likelihood = -8590.2176
Iteration 2:   log likelihood = -8333.4111
Iteration 3:   log likelihood = -8314.5175
Iteration 4:   log likelihood = -8311.6222
Iteration 5:   log likelihood = -8311.2554
Iteration 6:   log likelihood = -8311.2469
Iteration 7:   log likelihood = -8311.2468
Refining estimates:
Iteration 0:   log likelihood = -8311.2468

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    2,459,614                  Number of obs    =   2,459,614
No. of failures =          829
Time at risk    =    252524169
                                                LR chi2(35)      =     2405.11
Log likelihood  =   -8311.2468                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
    current NSAID use  |   1.039505   .1342079     0.30   0.764     .8071054    1.338823
               1.age70 |   .7474879   .1053873    -2.06   0.039     .5670149     .985403
                       |
        exposure#age70 |
  current NSAID use#1  |   .8598724   .1383974    -0.94   0.348     .6272377    1.178788
                       |
                1.male |   2.164646   .1575121    10.61   0.000     1.876933    2.496464
                  age1 |   1.149253   .0509909     3.14   0.002     1.053535    1.253668
                  age2 |   .8886653   .0759942    -1.38   0.168     .7515325    1.050821
                  age3 |   1.518279   .3725945     1.70   0.089     .9385591    2.456073
                       |
             obese4cat |
    Obese I (30-34.9)  |   1.100557   .1004879     1.05   0.294     .9202213    1.316232
   Obese II (35-39.9)  |   1.555312   .1921787     3.57   0.000     1.220789    1.981501
      Obese III (40+)  |   1.617611   .2879437     2.70   0.007     1.141184     2.29294
                       |
          smoke_nomiss |
               Former  |   1.052465   .0807783     0.67   0.505     .9054755    1.223316
              Current  |   .8109884   .1112017    -1.53   0.127     .6198676    1.061037
                       |
                   imd |
                    2  |   1.504504   .1691323     3.63   0.000      1.20699    1.875354
                    3  |   1.532739   .1783882     3.67   0.000     1.220115    1.925465
                    4  |   1.831737   .2162224     5.13   0.000     1.453401    2.308558
      5 most deprived  |   2.354747   .2872092     7.02   0.000     1.854057     2.99065
                       |
                   ckd |
                  CKD  |   1.418756   .1350479     3.67   0.000     1.177291    1.709745
        1.hypertension |   1.044418   .0805999     0.56   0.573     .8978123    1.214964
       1.heart_failure |   1.597108   .2686428     2.78   0.005     1.148569    2.220809
 1.other_heart_disease |    1.12392    .187082     0.70   0.483      .811052    1.557478
                       |
          diab_control |
  Controlled diabetes  |   1.466615   .1408842     3.99   0.000     1.214923    1.770448
Uncontrolled diabetes  |   2.219512   .2944331     6.01   0.000     1.711354    2.878559
                       |
                1.copd |   1.320774   .1637925     2.24   0.025     1.035783    1.684178
   1.other_respiratory |    2.40012   .3232428     6.50   0.000     1.843296     3.12515
       1.immunodef_any |   2.424046   .7101939     3.02   0.003     1.365077    4.304521
              1.cancer |   2.019762   .1688632     8.41   0.000      1.71449    2.379388
          1.rheumatoid |    1.25597    .242552     1.18   0.238     .8601925    1.833845
      1.osteoarthritis |    .859212   .0647718    -2.01   0.044     .7411947    .9960205
              1.statin |   .6930701   .0587019    -4.33   0.000     .5870591    .8182245
                 1.ppi |   1.419679   .1132928     4.39   0.000     1.214124    1.660036
1.steroid_prednisolone |   1.513162   .1933619     3.24   0.001     1.177913    1.943827
  1.hydroxychloroquine |   1.377266   .4080307     1.08   0.280     .7706189    2.461478
 1.dmards_primary_care |   1.563013    .336032     2.08   0.038     1.025565    2.382113
         1.flu_vaccine |   1.067684   .0933393     0.75   0.454     .8995572    1.267233
1.pneumococcal_vaccine |   1.040107   .1122284     0.36   0.716     .8418456    1.285059
----------------------------------------------------------------------------------------
                                                             Stratified by stp

. estimates store B

. estimates save ./$tempdir/multivar2_int, replace 
file ./nsaid_tempdata/multivar2_int.ster saved

. 
. lrtest A B

Likelihood-ratio test                                 LR chi2(1)  =      0.88
(Assumption: A nested in B)                           Prob > chi2 =    0.3488

. local multivar2_p = round(r(p),0.001)

. 
. /* Print interaction table====================================================*/ 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table3.txt, write text replace
(note: file ./nsaid_output/table3.txt not found)

. 
. * Column headings 
. file write tablecontent ("Table 3: Current NSAID use and $outcome, Age Interaction - $population Population") _n

. file write tablecontent  _tab ("Number of events") _tab ("Total person-weeks") _tab ("Rate per 1,000") _tab ("Univariable") _tab _tab _tab ("Age/Sex Adjusted") _tab _tab _tab  ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _tab _tab _n

. file write tablecontent _tab _tab _tab _tab ("HR") _tab ("95% CI") _tab ("p (interaction)") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("p (interaction)") _tab ("HR") _tab ("95% CI") _tab ("p (interaction)") _tab _n

. 
. * Overall p-values 
. file write tablecontent ("Agegroup") _tab _tab _tab _tab _tab _tab ("`univar_p'") ///
>                                                 _tab _tab _tab ("`multivar1_p'") /// 
>                                                 _tab _tab _tab ("`multivar2_p'") _n

. 
.                                                 
. * Generic program to print model for a level of another variable 
. cap prog drop printinteraction

. prog define printinteraction 
  1. syntax, variable(varname) min(real) max(real) 
  2. 
.         forvalues varlevel = `min'/`max'{ 
  3. 
.                 * Row headings 
.                 file write tablecontent ("`varlevel'") _n       
  4. 
.                 local lab0: label exposure 0
  5.                 local lab1: label exposure 1
  6.                  
.                 /* Counts */
.                         
.                 * First row, exposure = 0 (reference)
.                 
.         file write tablecontent ("`lab0'") _tab
  7. 
.                         safecount if exposure == 0  & `variable' == `varlevel' & $outcome == 1
  8.             local event = r(N)
  9.                     bysort exposure `variable': egen total_follow_up = total(_t)
 10.             su total_follow_up if exposure == 0 & `variable' == `varlevel'
 11.             local person_week = r(mean)/7
 12.             local rate = 1000*(`event'/`person_week')
 13. 
.                         
.                 file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab
 14.         file write tablecontent ("1.00 (ref)") _tab _tab _tab ("1.00 (ref)") _tab _tab _tab ("1.00 (ref)") _n
 15. 
.                         
.                 * Second row, exposure = 1 (NSAID)
. 
.                 file write tablecontent ("`lab1'") _tab  
 16. 
. 
.                         safecount if exposure == 1 & `variable' == `varlevel' & $outcome == 1
 17.                 local event = r(N)
 18.             su total_follow_up if exposure == 1 & `variable' == `varlevel'
 19.             local person_week = r(mean)/7
 20.             local rate = 1000*(`event'/`person_week')
 21.             file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab
 22. 
.                 * Print models 
.                 estimates use ./$tempdir/univar_int 
 23.                 qui lincom 1.exposure + 1.exposure#`varlevel'.`variable', eform
 24.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab _tab
 25. 
.                 estimates use ./$tempdir/multivar1_int
 26.                 qui lincom 1.exposure + 1.exposure#`varlevel'.`variable', eform
 27.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab _tab
 28. 
.                 estimates use ./$tempdir/multivar2_int
 29.                 qui lincom 1.exposure + 1.exposure#`varlevel'.`variable', eform
 30.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab _n 
 31. 
.                 drop total_follow_up
 32.         } 
 33.                 
. end

. 
. printinteraction, variable(age70) min(0) max(1) 
  224

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |  1,700,065    1.74e+08           0   1.74e+08   1.74e+08
  96

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    457,334    4.80e+07           0   4.80e+07   4.80e+07
  387

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    224,030    2.28e+07           0   2.28e+07   2.28e+07
  122

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |     78,185     8173623           0    8173623    8173623

. 
. file write tablecontent _n

. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\caroline\nsaids-covid-research\analysis\nsaid_log\07_an_models_interact1.log
  log type:  text
 closed on:  27 Jul 2020, 11:18:26
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
