------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\caroline\nsaids-covid-research\analysis\nsaid_log\12_an_models_adj_survival_curve.log
  log type:  text
 opened on:  27 Jul 2020, 11:18:26

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /*==============================================================================*/
. * Fit the stpm2 model 
. xi i.exposure i.male $varlist
i.exposure        _Iexposure_0-1      (naturally coded; _Iexposure_0 omitted)
i.male            _Imale_0-1          (naturally coded; _Imale_0 omitted)
i.obese4cat       _Iobese4cat_1-4     (naturally coded; _Iobese4cat_1 omitted)
i.smoke_nomiss    _Ismoke_nom_1-3     (naturally coded; _Ismoke_nom_1 omitted)
i.imd             _Iimd_1-5           (naturally coded; _Iimd_1 omitted)
i.ckd             _Ickd_0-1           (naturally coded; _Ickd_0 omitted)
i.hypertension    _Ihypertens_0-1     (naturally coded; _Ihypertens_0 omitted)
i.heart_failure   _Iheart_fai_0-1     (naturally coded; _Iheart_fai_0 omitted)
i.other_hear~se   _Iother_hea_0-1     (naturally coded; _Iother_hea_0 omitted)
i.diab_control    _Idiab_cont_1-3     (naturally coded; _Idiab_cont_1 omitted)
i.copd            _Icopd_0-1          (naturally coded; _Icopd_0 omitted)
i.other_respi~y   _Iother_res_0-1     (naturally coded; _Iother_res_0 omitted)
i.immunodef_any   _Iimmunodef_0-1     (naturally coded; _Iimmunodef_0 omitted)
i.cancer          _Icancer_0-1        (naturally coded; _Icancer_0 omitted)
i.rheumatoid      _Irheumatoi_0-1     (naturally coded; _Irheumatoi_0 omitted)
i.osteoarthri~s   _Iosteoarth_0-1     (naturally coded; _Iosteoarth_0 omitted)
i.statin          _Istatin_0-1        (naturally coded; _Istatin_0 omitted)
i.ppi             _Ippi_0-1           (naturally coded; _Ippi_0 omitted)
i.steroid_pr~ne   _Isteroid_p_0-1     (naturally coded; _Isteroid_p_0 omitted)
i.hydroxychl~ne   _Ihydroxych_0-1     (naturally coded; _Ihydroxych_0 omitted)
i.dmards_pri~re   _Idmards_pr_0-1     (naturally coded; _Idmards_pr_0 omitted)
i.flu_vaccine     _Iflu_vacci_0-1     (naturally coded; _Iflu_vacci_0 omitted)
i.pneumococca~e   _Ipneumococ_0-1     (naturally coded; _Ipneumococ_0 omitted)

. stpm2 _I* age1 age2 age3, scale(hazard) df($df) eform nolog

Log likelihood = -6579.8832                     Number of obs     =  2,459,614

-------------------------------------------------------------------------------
              |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
--------------+----------------------------------------------------------------
xb            |
 _Iexposure_1 |   .9235322    .081434    -0.90   0.367     .7769552    1.097762
     _Imale_1 |   2.139313   .1555054    10.46   0.000     1.855244    2.466878
_Iobese4cat_2 |    1.07503   .0980952     0.79   0.428     .8989788    1.285558
_Iobese4cat_3 |    1.50385   .1856378     3.31   0.001     1.180676    1.915483
_Iobese4cat_4 |    1.56077     .27764     2.50   0.012      1.10134    2.211853
_Ismoke_nom_2 |   1.001592     .07662     0.02   0.983     .8621352    1.163607
_Ismoke_nom_3 |   .7830532   .1074059    -1.78   0.075     .5984639    1.024577
      _Iimd_2 |     1.4713   .1645645     3.45   0.001     1.181666    1.831926
      _Iimd_3 |   1.470067   .1691746     3.35   0.001     1.173225    1.842014
      _Iimd_4 |   1.845197   .2133549     5.30   0.000     1.471027     2.31454
      _Iimd_5 |   2.471783   .2892341     7.73   0.000     1.965204    3.108946
      _Ickd_1 |   1.381829   .1303509     3.43   0.001     1.148573    1.662456
_Ihypertens_1 |   1.071901   .0827063     0.90   0.368     .9214614    1.246901
_Iheart_fai_1 |   1.592777   .2669659     2.78   0.005     1.146793    2.212204
_Iother_hea_1 |   1.111763   .1845446     0.64   0.523     .8030061    1.539237
_Idiab_cont_2 |   1.646954   .1549371     5.30   0.000     1.369634    1.980424
_Idiab_cont_3 |   2.325013   .3077888     6.37   0.000     1.793668     3.01376
     _Icopd_1 |   1.324773   .1640757     2.27   0.023     1.039247    1.688746
_Iother_res_1 |   2.454198   .3298001     6.68   0.000     1.885921    3.193712
_Iimmunodef_1 |   2.412066   .7070548     3.00   0.003     1.357921    4.284538
   _Icancer_1 |   1.985721   .1655395     8.23   0.000      1.68639    2.338184
_Irheumatoi_1 |   1.252416   .2424361     1.16   0.245     .8569933    1.830289
_Iosteoarth_1 |   .8500983   .0637384    -2.17   0.030     .7339187    .9846691
   _Istatin_1 |   .7110632   .0600235    -4.04   0.000      .602636    .8389988
      _Ippi_1 |   1.402924   .1119631     4.24   0.000     1.199782    1.640462
_Isteroid_p_1 |   1.480864   .1889313     3.08   0.002     1.153234    1.901573
_Ihydroxych_1 |   1.424084   .4218553     1.19   0.233     .7968652    2.544992
_Idmards_pr_1 |   1.521744   .3277215     1.95   0.051     .9977631    2.320895
_Iflu_vacci_1 |   1.007612   .0872923     0.09   0.930     .8502591    1.194085
_Ipneumococ_1 |   1.049846   .1127755     0.45   0.651     .8505279    1.295873
         age1 |   1.166814   .0529026     3.40   0.001     1.067601    1.275248
         age2 |   .8537717   .0741179    -1.82   0.069     .7201898    1.012131
         age3 |   1.673033   .4170368     2.06   0.039     1.026421    2.726989
        _rcs1 |   4.232335    .412489    14.80   0.000     3.496398    5.123176
        _rcs2 |    1.57053   .0654461    10.83   0.000     1.447356    1.704186
        _rcs3 |   .9886753   .0055421    -2.03   0.042     .9778725    .9995974
        _cons |   3.76e-08   6.40e-08   -10.04   0.000     1.33e-09    1.06e-06
-------------------------------------------------------------------------------
Note: Estimates are transformed only in the first equation.

. 
. * set timevar for time points to be plotted
. summ _t

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          _t |  2,459,614    102.6682    12.97384          1        105

. local tmax=r(max)

. local tmaxplus1=r(max)+1

. 
. range timevar 0 `tmax' `tmaxplus1'
(2,459,508 missing values generated)

. 
. * Run stpm2 
. stpm2_standsurv, at1(_Iexposure 0) at2(_Iexposure 1) timevar(timevar) ci contrast(difference) fail

. 
. * list the standardized curves for longest follow-up, followed by their difference.
. list _at1* if timevar==`tmax', noobs

  +-----------------------------------+
  |      _at1    _at1_lci    _at1_uci |
  |-----------------------------------|
  | .00035382   .00032599   .00038401 |
  +-----------------------------------+

. list _at2* if timevar==`tmax', noobs

  +-----------------------------------+
  |      _at2    _at2_lci    _at2_uci |
  |-----------------------------------|
  | .00032682   .00028308   .00037733 |
  +-----------------------------------+

. list _contrast* if timevar==`tmax', noobs ab(16)

  +----------------------------------------------------+
  | _contrast2_1   _contrast2_1_lci   _contrast2_1_uci |
  |----------------------------------------------------|
  |   -.00002699          -.0000846          .00003062 |
  +----------------------------------------------------+

. 
. * Convert them to be expressed in %
. for var _at1 _at2 _at1_lci _at1_uci _at2_lci _at2_uci ///
> _contrast2_1 _contrast2_1_lci _contrast2_1_uci: replace X=100*X

->  replace _at1=100*_at1
(105 real changes made)

->  replace _at2=100*_at2
(105 real changes made)

->  replace _at1_lci=100*_at1_lci
(105 real changes made)

->  replace _at1_uci=100*_at1_uci
(105 real changes made)

->  replace _at2_lci=100*_at2_lci
(105 real changes made)

->  replace _at2_uci=100*_at2_uci
(105 real changes made)

->  replace _contrast2_1=100*_contrast2_1
(105 real changes made)

->  replace _contrast2_1_lci=100*_contrast2_1_lci
(105 real changes made)

->  replace _contrast2_1_uci=100*_contrast2_1_uci
(105 real changes made)

. 
. * Plot the survival curves
. twoway  (rarea _at1_lci _at1_uci timevar, color(red%25)) ///
>                 (rarea _at2_lci _at2_uci timevar, color(blue%25)) ///
>                  (line _at1 timevar, sort lcolor(red)) ///
>                  (line _at2  timevar, sort lcolor(blue)) ///
>                  , legend(order(1 "Non-current NSAID use" 2 "Current NSAID use") ///
>                                  ring(0) cols(1) pos(1)) ///
>                  ylabel(0 (0.05) $cum_death_ymax ,angle(h) format(%4.2f)) ///
>                  ytitle("Cumulative mortality (%)") ///
>                  xtitle("Days from 1 March 2020") ///
>                                  saving(Adj_survival_curves, replace)
(note: file Adj_survival_curves.gph not found)
(file Adj_survival_curves.gph saved)

.                                  
. graph export "$outdir/Adj_survival_curves.svg", as(svg) replace
(note: file nsaid_output/Adj_survival_curves.svg not found)
(file nsaid_output/Adj_survival_curves.svg written in SVG format)

. 
. * Close window 
. graph close

. 
. * Delete unneeded graphs
. erase Adj_survival_curves.gph

. 
. * Plot the difference in curves
. twoway  (rarea _contrast2_1_lci _contrast2_1_uci timevar, color(red%25)) ///
>                  (line _contrast2_1 timevar, sort lcolor(red)) ///
>                  , legend(off) ///
>                  ylabel(,angle(h) format(%4.2f)) ///
>                  ytitle("Difference in curves (%)") ///
>                  xtitle("Days from 1 March 2020") ///
>                                  saving(difference_survival_curves, replace)
(note: file difference_survival_curves.gph not found)
(file difference_survival_curves.gph saved)

.                                  
. graph export "$outdir/difference_survival_curves.svg", as(svg) replace
(note: file nsaid_output/difference_survival_curves.svg not found)
(file nsaid_output/difference_survival_curves.svg written in SVG format)

. 
. * Close window 
. graph close

. 
. * Delete unneeded graphs
. erase difference_survival_curves.gph             

.                                  
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\caroline\nsaids-covid-research\analysis\nsaid_log\12_an_models_adj_survival_curve.log
  log type:  text
 closed on:  27 Jul 2020, 11:46:19
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
