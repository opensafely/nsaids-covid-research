------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\caroline\nsaids-covid-research\analysis\arthritis_log_DAG\posthoc_01_an_models_DAG.log
  log type:  text
 opened on:  27 Jul 2020, 15:18:27

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Full cohort============================================================*/ 
. 
. safetab exposure $outcome, missing row
23

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use | 1,532,980      2,441 | 1,535,421 
                      |     99.84       0.16 |    100.00 
----------------------+----------------------+----------
    current NSAID use |   175,508        123 |   175,631 
                      |     99.93       0.07 |    100.00 
----------------------+----------------------+----------
                Total | 1,708,488      2,564 | 1,711,052 
                      |     99.85       0.15 |    100.00 

. 
. * DAG approach in full cohort 
. 
. stcox i.exposure i.male age1 age2 age3 $varlist, strata(stp)    

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -28512.712
Iteration 1:   log likelihood = -26182.694
Iteration 2:   log likelihood =  -25596.03
Iteration 3:   log likelihood = -25587.208
Iteration 4:   log likelihood = -25586.978
Iteration 5:   log likelihood = -25586.977
Iteration 6:   log likelihood = -25586.977
Refining estimates:
Iteration 0:   log likelihood = -25586.977

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    1,711,052                  Number of obs    =   1,711,052
No. of failures =        2,564
Time at risk    =    176820188
                                                LR chi2(30)      =     5851.47
Log likelihood  =   -25586.977                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------------
                          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------------+----------------------------------------------------------------
                    exposure |
          current NSAID use  |   .8598572   .0807492    -1.61   0.108      .715303    1.033624
                      1.male |   1.632195    .067627    11.82   0.000     1.504888    1.770272
                        age1 |   1.090123   .0213123     4.41   0.000     1.049142    1.132705
                        age2 |   1.014443    .038192     0.38   0.703     .9422834    1.092129
                        age3 |   1.031129   .1272836     0.25   0.804     .8095424    1.313367
                             |
                   obese4cat |
          Obese I (30-34.9)  |   .9831459   .0553592    -0.30   0.763     .8804169    1.097862
         Obese II (35-39.9)  |   1.348785    .107909     3.74   0.000     1.153036    1.577767
            Obese III (40+)  |   1.963965   .2043709     6.49   0.000     1.601612    2.408297
                             |
                smoke_nomiss |
                     Former  |   1.155686   .0500792     3.34   0.001     1.061586    1.258128
                    Current  |   1.035878   .0984193     0.37   0.711     .8598751    1.247905
                             |
                         imd |
                          2  |   1.192899   .0810267     2.60   0.009     1.044206    1.362764
                          3  |   1.269629   .0861873     3.52   0.000      1.11146    1.450306
                          4  |   1.499494   .0996326     6.10   0.000     1.316399    1.708056
            5 most deprived  |   1.820559   .1208373     9.03   0.000     1.598481    2.073491
                             |
                         ckd |
                        CKD  |   1.208815   .0552998     4.15   0.000     1.105146    1.322208
              1.hypertension |   1.000625   .0433945     0.01   0.989     .9190873    1.089396
             1.heart_failure |   1.326705   .0898646     4.17   0.000     1.161764    1.515063
       1.other_heart_disease |   1.026879   .0742681     0.37   0.714      .891163    1.183264
                             |
                diab_control |
        Controlled diabetes  |   1.269327   .0658666     4.60   0.000     1.146578    1.405216
      Uncontrolled diabetes  |   1.846873    .137253     8.26   0.000     1.596536    2.136463
                             |
                      1.copd |   1.140669   .0763946     1.97   0.049     1.000349    1.300671
         1.other_respiratory |    1.80982   .1318752     8.14   0.000     1.568958    2.087658
             1.immunodef_any |   1.549721    .332638     2.04   0.041     1.017533    2.360254
                    1.cancer |   1.266227   .0611627     4.89   0.000      1.15185    1.391962
                             |
              arthritis_type |
             Osteoarthritis  |   .6321389   .0769123    -3.77   0.000     .4980201    .8023764
               Both RA & OA  |   .8150795   .1153104    -1.45   0.148     .6177024    1.075525
                             |
      1.steroid_prednisolone |   1.479322   .1022649     5.66   0.000     1.291872    1.693971
        1.hydroxychloroquine |   1.238524   .2289111     1.16   0.247     .8621454    1.779215
1.aande_attendance_last_year |   2.434165   .1010167    21.44   0.000     2.244014    2.640429
       1.dmards_primary_care |   1.207753   .1473454     1.55   0.122     .9508934    1.533997
----------------------------------------------------------------------------------------------
                                                             Stratified by stp

. 
. estimates save ./$tempdir/multivar1_full, replace 
(note: file ./arthritis_tempdata/multivar1_full.ster not found)
file ./arthritis_tempdata/multivar1_full.ster saved

. 
. /* Restrict population  (Complete case cohort)===========================*/ 
. 
. preserve 

. drop if ethnicity == .u
(400,236 observations deleted)

. 
. /* Sense check outcomes=======================================================*/ 
. 
. safetab exposure $outcome, missing row
23

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use | 1,173,467      1,809 | 1,175,276 
                      |     99.85       0.15 |    100.00 
----------------------+----------------------+----------
    current NSAID use |   135,454         86 |   135,540 
                      |     99.94       0.06 |    100.00 
----------------------+----------------------+----------
                Total | 1,308,921      1,895 | 1,310,816 
                      |     99.86       0.14 |    100.00 

. 
. /* Main Model=================================================================*/
. 
. * DAG approach in complete case cohort WITHOUT ethnicity
. 
. stcox i.exposure i.male age1 age2 age3 $varlist, strata(stp)    

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -20621.262
Iteration 1:   log likelihood = -18993.624
Iteration 2:   log likelihood = -18391.592
Iteration 3:   log likelihood =  -18381.85
Iteration 4:   log likelihood = -18381.768
Iteration 5:   log likelihood = -18381.768
Refining estimates:
Iteration 0:   log likelihood = -18381.768

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    1,310,816                  Number of obs    =   1,310,816
No. of failures =        1,895
Time at risk    =    135453064
                                                LR chi2(30)      =     4478.99
Log likelihood  =   -18381.768                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------------
                          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------------+----------------------------------------------------------------
                    exposure |
          current NSAID use  |   .7986269   .0895321    -2.01   0.045     .6410882    .9948786
                      1.male |    1.56739   .0756848     9.31   0.000     1.425854    1.722976
                        age1 |   1.101035   .0249254     4.25   0.000      1.05325    1.150988
                        age2 |   .9893927   .0429379    -0.25   0.806     .9087158    1.077232
                        age3 |   1.129139   .1603584     0.86   0.392     .8547932    1.491535
                             |
                   obese4cat |
          Obese I (30-34.9)  |   .9992913   .0641944    -0.01   0.991     .8810712    1.133374
         Obese II (35-39.9)  |   1.351441   .1238221     3.29   0.001     1.129297    1.617283
            Obese III (40+)  |   2.019474   .2368317     5.99   0.000     1.604776    2.541336
                             |
                smoke_nomiss |
                     Former  |   1.148036   .0581396     2.73   0.006     1.039558    1.267835
                    Current  |    1.03755   .1131669     0.34   0.735     .8378523    1.284845
                             |
                         imd |
                          2  |   1.252305   .1025105     2.75   0.006     1.066677    1.470237
                          3  |   1.302529   .1068513     3.22   0.001     1.109073     1.52973
                          4  |    1.62407    .128539     6.13   0.000     1.390706    1.896593
            5 most deprived  |   1.930354   .1520606     8.35   0.000     1.654188    2.252626
                             |
                         ckd |
                        CKD  |   1.287891   .0686709     4.75   0.000     1.160092    1.429768
              1.hypertension |   1.005238   .0511556     0.10   0.918     .9098131    1.110672
             1.heart_failure |   1.264824   .1009854     2.94   0.003     1.081606    1.479079
       1.other_heart_disease |   .9863138   .0827723    -0.16   0.870     .8367227    1.162649
                             |
                diab_control |
        Controlled diabetes  |   1.307543   .0772101     4.54   0.000     1.164642    1.467977
      Uncontrolled diabetes  |   1.798883   .1545738     6.83   0.000     1.520061    2.128848
                             |
                      1.copd |   1.168413    .089187     2.04   0.041     1.006057     1.35697
         1.other_respiratory |   1.832731   .1528665     7.26   0.000     1.556327    2.158225
             1.immunodef_any |   1.473094   .3706765     1.54   0.124     .8995839    2.412234
                    1.cancer |   1.262928   .0712672     4.14   0.000     1.130694    1.410626
                             |
              arthritis_type |
             Osteoarthritis  |   .6343801   .0903234    -3.20   0.001     .4799046    .8385792
               Both RA & OA  |   .7710979   .1281657    -1.56   0.118     .5567107    1.068045
                             |
      1.steroid_prednisolone |    1.42165   .1150033     4.35   0.000     1.213208    1.665904
        1.hydroxychloroquine |   1.293212    .274017     1.21   0.225     .8537085    1.958979
1.aande_attendance_last_year |   2.512293   .1210548    19.12   0.000     2.285889    2.761121
       1.dmards_primary_care |   1.226789   .1755395     1.43   0.153     .9267714    1.623929
----------------------------------------------------------------------------------------------
                                                             Stratified by stp

. 
. estimates save ./$tempdir/multivar2_completecase, replace 
(note: file ./arthritis_tempdata/multivar2_completecase.ster not found)
file ./arthritis_tempdata/multivar2_completecase.ster saved

. 
. * DAG approach in complete case cohort WITH ethnicity
. 
. stcox i.exposure i.male age1 age2 age3 i.ethnicity $varlist, strata(stp)                

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -20621.262
Iteration 1:   log likelihood = -18992.093
Iteration 2:   log likelihood = -18387.821
Iteration 3:   log likelihood = -18377.874
Iteration 4:   log likelihood = -18377.791
Iteration 5:   log likelihood = -18377.791
Refining estimates:
Iteration 0:   log likelihood = -18377.791

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    1,310,816                  Number of obs    =   1,310,816
No. of failures =        1,895
Time at risk    =    135453064
                                                LR chi2(34)      =     4486.94
Log likelihood  =   -18377.791                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------------
                          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------------+----------------------------------------------------------------
                    exposure |
          current NSAID use  |   .7969577   .0893438    -2.02   0.043     .6397502    .9927962
                      1.male |   1.563549   .0755404     9.25   0.000     1.422286    1.718842
                        age1 |   1.102081   .0249195     4.30   0.000     1.054306    1.152021
                        age2 |   .9892699   .0428792    -0.25   0.803     .9086992    1.076985
                        age3 |   1.127723   .1599812     0.85   0.397     .8539832    1.489209
                             |
                   ethnicity |
                      Mixed  |   1.605272   .4682839     1.62   0.105     .9062321    2.843531
     Asian or Asian British  |   1.302947   .1568341     2.20   0.028     1.029126    1.649623
                      Black  |   .9210656   .1871031    -0.40   0.686     .6185567    1.371518
                      Other  |   1.330423   .3285596     1.16   0.248     .8199324    2.158745
                             |
                   obese4cat |
          Obese I (30-34.9)  |   1.002917   .0644294     0.05   0.964     .8842642    1.137491
         Obese II (35-39.9)  |   1.361895    .124824     3.37   0.001      1.13796    1.629897
            Obese III (40+)  |   2.042195   .2396328     6.09   0.000     1.622619    2.570265
                             |
                smoke_nomiss |
                     Former  |   1.164794   .0596795     2.98   0.003     1.053506    1.287839
                    Current  |   1.054906   .1153889     0.49   0.625     .8513469    1.307136
                             |
                         imd |
                          2  |   1.251686   .1024603     2.74   0.006     1.066149    1.469511
                          3  |   1.297462   .1064751     3.17   0.002     1.104693     1.52387
                          4  |   1.608465   .1275324     5.99   0.000      1.37696    1.878892
            5 most deprived  |   1.904976   .1507946     8.14   0.000      1.63121    2.224689
                             |
                         ckd |
                        CKD  |   1.290298   .0688024     4.78   0.000     1.162256    1.432447
              1.hypertension |   1.004204   .0511141     0.08   0.934     .9088574    1.109553
             1.heart_failure |   1.267706   .1012207     2.97   0.003     1.084061    1.482461
       1.other_heart_disease |   .9870245   .0828403    -0.16   0.876     .8373117    1.163506
                             |
                diab_control |
        Controlled diabetes  |   1.289121   .0766543     4.27   0.000     1.147305    1.448466
      Uncontrolled diabetes  |   1.768376   .1526311     6.60   0.000      1.49316     2.09432
                             |
                      1.copd |   1.173059   .0895532     2.09   0.037     1.010038    1.362392
         1.other_respiratory |   1.831192   .1527017     7.25   0.000      1.55508    2.156328
             1.immunodef_any |   1.473687   .3709567     1.54   0.123     .8997891    2.413625
                    1.cancer |   1.269127   .0716801     4.22   0.000     1.136133    1.417688
                             |
              arthritis_type |
             Osteoarthritis  |   .6347251   .0903734    -3.19   0.001     .4801644    .8390375
               Both RA & OA  |   .7705027   .1280721    -1.57   0.117     .5562734    1.067235
                             |
      1.steroid_prednisolone |    1.42314   .1151372     4.36   0.000     1.214457     1.66768
        1.hydroxychloroquine |   1.289549   .2732399     1.20   0.230     .8512916    1.953427
1.aande_attendance_last_year |   2.514849   .1211762    19.14   0.000     2.288218    2.763926
       1.dmards_primary_care |   1.228309   .1757623     1.44   0.151      .927912    1.625955
----------------------------------------------------------------------------------------------
                                                             Stratified by stp

. 
. estimates save ./$tempdir/multivar3_completecase_ethn, replace 
(note: file ./arthritis_tempdata/multivar3_completecase_ethn.ster not found)
file ./arthritis_tempdata/multivar3_completecase_ethn.ster saved

. 
. /* Print table================================================================*/ 
. *  Print the results for the main model 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table1.txt, write text replace
(note: file ./arthritis_output_DAG/table1.txt not found)

. 
. * Column headings 
. file write tablecontent ("Table 1: Association between current NSAID use and death - $population Population, using DAG approach") _n

. file write tablecontent _tab ("Number of events") _tab ("Total person-weeks") _tab ("Rate per 1,000") _tab ("DAG - Full cohort without ethnicity") ///
>                                                 _tab _tab ("DAG - Complete case cohort without ethnicity") ///
>                                                 _tab _tab ("DAG - Complete case cohort with ethnicity") _tab _tab _n

. file write tablecontent _tab _tab _tab _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("HR") _tab ("95% CI") _n

. file write tablecontent ("Post-hoc Analysis") _n                                        

. 
. * Row headings 
. local lab0: label exposure 0

. local lab1: label exposure 1

.  
. * First row, exposure = 0 (reference)
. 
.         safecount if exposure == 0 & $outcome == 1
  1,809

.         local event = r(N)

.     bysort exposure: egen total_follow_up = total(_t)

.         su total_follow_up if exposure == 0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |  1,175,276    1.21e+08           0   1.21e+08   1.21e+08

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         
.         file write tablecontent ("`lab0'") _tab

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

.         file write tablecontent ("1.00 (ref)") _tab _tab ("1.00 (ref)") _tab _tab ("1.00 (ref)") _n

.         
. * Second row, exposure = 1 (NSAID)
. 
. file write tablecontent ("`lab1'") _tab  

. 
.         safecount if exposure == 1 & $outcome == 1
  86

.         local event = r(N)

.         su total_follow_up if exposure == 1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    135,540    1.42e+07           0   1.42e+07   1.42e+07

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

. 
. /* Main Model */ 
. estimates use ./$tempdir/multivar1_full 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .8598572   .0807492    -1.61   0.108      .715303    1.033624
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar2_completecase

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .7986269   .0895321    -2.01   0.045     .6410882    .9948786
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar3_completecase_ethn

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .7969577   .0893438    -2.02   0.043     .6397502    .9927962
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _n 

. 
. 
. file write tablecontent _n

. file close tablecontent

. 
. restore 

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\caroline\nsaids-covid-research\analysis\arthritis_log_DAG\posthoc_01_an_models_DAG.log
  log type:  text
 closed on:  27 Jul 2020, 15:25:41
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
