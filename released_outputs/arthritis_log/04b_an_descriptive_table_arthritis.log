---------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\arthritis_log\04b_an_descriptive_table_arthritis.log
  log type:  text
 opened on:   3 Jul 2020, 20:05:01

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset, clear

. 
. /*==============================================================================*/
. 
. /* PROGRAMS TO AUTOMATE TABULATIONS===========================================*/ 
. 
. ********************************************************************************
. * All below code from K Baskharan 
. * Generic code to output one row of table
. 
. cap prog drop generaterow

. program define generaterow
  1. syntax, variable(varname) condition(string) 
  2.         
.         cou
  3.         local overalldenom=r(N)
  4.         
.         qui sum `variable' if `variable' `condition'
  5.         file write tablecontent (r(max)) _tab
  6.         
.         cou if `variable' `condition'
  7.         local rowdenom = r(N)
  8.         local colpct = 100*(r(N)/`overalldenom')
  9.         file write tablecontent %9.0gc (`rowdenom')  (" (") %3.1f (`colpct') (")") _tab
 10. 
.         cou if exposure == 0 
 11.         local rowdenom = r(N)
 12.         cou if exposure == 0 & `variable' `condition'
 13.         local pct = 100*(r(N)/`rowdenom') 
 14.         file write tablecontent %9.0gc (r(N)) (" (") %3.1f (`pct') (")") _tab
 15. 
.         cou if exposure == 1 
 16.         local rowdenom = r(N)
 17.         cou if exposure == 1 & `variable' `condition'
 18.         local pct = 100*(r(N)/`rowdenom')
 19.         file write tablecontent %9.0gc (r(N)) (" (") %3.1f  (`pct') (")") _n
 20.         
. end

. 
. /* Explanatory Notes 
> 
> defines a program (SAS macro/R function equivalent), generate row
> the syntax row specifies two inputs for the program: 
> 
>         a VARNAME which is your variable 
>         a CONDITION which is a string of some condition you impose 
>         
> the program counts if variable and condition and returns the counts
> column percentages are then automatically generated
> this is then written to the text file 'tablecontent' 
> the number followed by space, brackets, formatted pct, end bracket and then tab
> 
> the format %3.1f specifies length of 3, followed by 1 dp. 
> 
> */ 
. 
. ********************************************************************************
. * Generic code to output one section (varible) within table (calls above)
. 
. cap prog drop tabulatevariable

. prog define tabulatevariable
  1. syntax, variable(varname) min(real) max(real) [missing]
  2. 
.         local lab: variable label `variable'
  3.         file write tablecontent ("`lab'") _n 
  4. 
.         forvalues varlevel = `min'/`max'{ 
  5.                 generaterow, variable(`variable') condition("==`varlevel'")
  6.         }
  7.         
.         if "`missing'"!="" generaterow, variable(`variable') condition(">=.")
  8. 
. end

. 
. ********************************************************************************
. 
. /* Explanatory Notes 
> 
> defines program tabulate variable 
> syntax is : 
> 
>         - a VARNAME which you stick in variable 
>         - a numeric minimum 
>         - a numeric maximum 
>         - optional missing option, default value is . 
> 
> forvalues lowest to highest of the variable, manually set for each var
> run the generate row program for the level of the variable 
> if there is a missing specified, then run the generate row for missing vals
> 
> */ 
. 
. ********************************************************************************
. * Generic code to summarise a continuous variable 
. 
. cap prog drop summarizevariable 

. prog define summarizevariable
  1. syntax, variable(varname) 
  2. 
.         local lab: variable label `variable'
  3.         file write tablecontent ("`lab'") _n 
  4.         
.         qui summarize `variable', d
  5.         file write tablecontent ("Median (IQR)") _tab 
  6.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _tab
  7.                                                         
.         qui summarize `variable' if exposure == 0, d
  8.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _tab
  9. 
.         qui summarize `variable' if exposure == 1, d
 10.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _n
 11.         
.         qui summarize `variable', d
 12.         file write tablecontent ("Min, Max") _tab 
 13.         file write tablecontent (r(min)) (", ") (r(max)) ("") _tab
 14.                                                         
.         qui summarize `variable' if exposure == 0, d
 15.         file write tablecontent (r(min)) (", ") (r(max)) ("") _tab
 16. 
.         qui summarize `variable' if exposure == 1, d
 17.         file write tablecontent (r(min)) (", ") (r(max)) ("") _n
 18.         
. end

. 
. /* QUESTION FOR STATA REVIEWER - I WROTE THIS CONTINOUS VAR SUMMARY PROGRAM
> but I don't quite understand why I seem to need ("") on the last row for the 
> maxium value to display properly? Otherwise it seems to just be missing. 
> 
> Please check this extra carefully as well
> 
> */ 
. 
. /* INVOKE PROGRAMS FOR TABLE 1================================================*/ 
. 
. *Set up output file
. cap file close tablecontent

. file open tablecontent using ./$outdir/table1.txt, write text replace

. 
. file write tablecontent ("Table 1: Demographic and Clinical Characteristics - $population") _n

. 
. * Exposure labelled columns
. 
. local lab0: label exposure 0

. local lab1: label exposure 1

. 
. file write tablecontent _tab ("Total")                                                    _tab ///
>                                                          ("`lab0'")                                                   _tab ///
>                                                          ("`lab1'")                                               _n

. 
. * DEMOGRAPHICS (more than one level, potentially missing) 
. 
. gen byte cons=1

. tabulatevariable, variable(cons) min(1) max(1) 
  561,840
  561,840
  386,232
  386,232
  175,608
  175,608

. file write tablecontent _n 

. 
. tabulatevariable, variable(agegroup) min(1) max(6) 
  561,840
  15,857
  386,232
  11,460
  175,608
  4,397
  561,840
  50,552
  386,232
  34,747
  175,608
  15,805
  561,840
  140,011
  386,232
  94,590
  175,608
  45,421
  561,840
  171,894
  386,232
  114,867
  175,608
  57,027
  561,840
  135,845
  386,232
  94,462
  175,608
  41,383
  561,840
  47,681
  386,232
  36,106
  175,608
  11,575

. file write tablecontent _n 

. 
. tabulatevariable, variable(male) min(0) max(1) 
  561,840
  349,824
  386,232
  239,185
  175,608
  110,639
  561,840
  212,016
  386,232
  147,047
  175,608
  64,969

. file write tablecontent _n 

. 
. tabulatevariable, variable(bmicat) min(1) max(6) missing
  561,840
  4,383
  386,232
  3,173
  175,608
  1,210
  561,840
  112,731
  386,232
  81,373
  175,608
  31,358
  561,840
  186,524
  386,232
  131,090
  175,608
  55,434
  561,840
  125,123
  386,232
  84,553
  175,608
  40,570
  561,840
  56,541
  386,232
  36,383
  175,608
  20,158
  561,840
  30,766
  386,232
  18,436
  175,608
  12,330
  561,840
  45,772
  386,232
  31,224
  175,608
  14,548

. file write tablecontent _n 

. 
. tabulatevariable, variable(smoke) min(1) max(3) missing 
  561,840
  234,265
  386,232
  164,025
  175,608
  70,240
  561,840
  252,716
  386,232
  171,577
  175,608
  81,139
  561,840
  73,882
  386,232
  49,954
  175,608
  23,928
  561,840
  977
  386,232
  676
  175,608
  301

. file write tablecontent _n 

. 
. tabulatevariable, variable(smoke_nomiss) min(1) max(3) missing 
  561,840
  235,242
  386,232
  164,701
  175,608
  70,541
  561,840
  252,716
  386,232
  171,577
  175,608
  81,139
  561,840
  73,882
  386,232
  49,954
  175,608
  23,928
  561,840
  0
  386,232
  0
  175,608
  0

. file write tablecontent _n 

. 
. tabulatevariable, variable(ethnicity) min(1) max(5) missing 
  561,840
  394,382
  386,232
  270,045
  175,608
  124,337
  561,840
  2,969
  386,232
  2,143
  175,608
  826
  561,840
  26,934
  386,232
  19,933
  175,608
  7,001
  561,840
  8,323
  386,232
  6,225
  175,608
  2,098
  561,840
  4,703
  386,232
  3,464
  175,608
  1,239
  561,840
  124,529
  386,232
  84,422
  175,608
  40,107

. file write tablecontent _n 

. 
. tabulatevariable, variable(imd) min(1) max(5) missing
  561,840
  113,676
  386,232
  79,361
  175,608
  34,315
  561,840
  112,360
  386,232
  77,545
  175,608
  34,815
  561,840
  112,815
  386,232
  77,316
  175,608
  35,499
  561,840
  111,059
  386,232
  75,989
  175,608
  35,070
  561,840
  111,930
  386,232
  76,021
  175,608
  35,909
  561,840
  0
  386,232
  0
  175,608
  0

. file write tablecontent _n 

. 
. tabulatevariable, variable(diabcat) min(1) max(4) missing
  561,840
  476,659
  386,232
  327,223
  175,608
  149,436
  561,840
  63,149
  386,232
  43,688
  175,608
  19,461
  561,840
  20,732
  386,232
  14,435
  175,608
  6,297
  561,840
  1,300
  386,232
  886
  175,608
  414
  561,840
  0
  386,232
  0
  175,608
  0

. file write tablecontent _n 

. 
. tabulatevariable, variable(arthritis_type) min(0) max(3) missing
  561,840
  0
  386,232
  0
  175,608
  0
  561,840
  30,211
  386,232
  17,486
  175,608
  12,725
  561,840
  511,796
  386,232
  357,616
  175,608
  154,180
  561,840
  19,833
  386,232
  11,130
  175,608
  8,703
  561,840
  0
  386,232
  0
  175,608
  0

. file write tablecontent _n 

. 
. file write tablecontent _n _n

. 
. ** COMORBIDITIES (categorical and continous)
. 
. ** COMORBIDITIES (binary)
. 
. foreach comorb of varlist       hypertension                                    ///
>                                                         heart_failure                                   ///
>                                                         other_heart_disease                             ///
>                                                         diabetes                                                ///
>                                                         copd                                                    ///
>                                                         other_respiratory                   ///
>                                                         cancer                                          ///
>                                                         immunodef_any                                   ///
>                                                         ckd                                                             ///
>                             osteoarthritis                  ///                                                 
>                                                         rheumatoid                      ///
>                                                         flu_vaccine                                     ///
>                                                         pneumococcal_vaccine                    ///
>                                                         statin                                                  ///
>                                                         ppi                                                     ///
>                                                         steroid_prednisolone            ///
>                                                         hydroxychloroquine              ///
>                                                         dmards_primary_care             ///
>                                                         gp_consult                      ///
>                                                         aande_attendance_last_year   {
  2. 
. local lab: variable label `comorb'
  3. file write tablecontent ("`lab'") _n 
  4.                                                         
. generaterow, variable(`comorb') condition("==1")
  5. file write tablecontent _n
  6. 
. }
  561,840
  208,187
  386,232
  141,971
  175,608
  66,216
  561,840
  6,428
  386,232
  5,020
  175,608
  1,408
  561,840
  14,524
  386,232
  10,316
  175,608
  4,208
  561,840
  85,181
  386,232
  59,009
  175,608
  26,172
  561,840
  27,370
  386,232
  18,973
  175,608
  8,397
  561,840
  11,199
  386,232
  7,769
  175,608
  3,430
  561,840
  53,890
  386,232
  37,908
  175,608
  15,982
  561,840
  6,129
  386,232
  4,167
  175,608
  1,962
  561,840
  39,417
  386,232
  28,246
  175,608
  11,171
  561,840
  531,629
  386,232
  368,746
  175,608
  162,883
  561,840
  50,044
  386,232
  28,616
  175,608
  21,428
  561,840
  269,442
  386,232
  182,887
  175,608
  86,555
  561,840
  75,116
  386,232
  50,417
  175,608
  24,699
  561,840
  144,320
  386,232
  97,163
  175,608
  47,157
  561,840
  240,652
  386,232
  103,240
  175,608
  137,412
  561,840
  24,281
  386,232
  16,046
  175,608
  8,235
  561,840
  10,933
  386,232
  5,830
  175,608
  5,103
  561,840
  27,132
  386,232
  14,433
  175,608
  12,699
  561,840
  540,525
  386,232
  368,334
  175,608
  172,191
  561,840
  104,708
  386,232
  71,744
  175,608
  32,964

. 
. * COMORBIDITIES (continuous)
. 
. summarizevariable, variable(gp_consult_count)

. summarizevariable, variable(age)

. summarizevariable, variable(aande_attendance_count)

. summarizevariable, variable(follow_up_ons)

. *summarizevariable, variable(follow_up_ecds)
. 
. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\arthritis_log\04b_an_descriptive_table_arthritis.log
  log type:  text
 closed on:   3 Jul 2020, 20:05:23
---------------------------------------------------------------------------------------------------------------------------------
