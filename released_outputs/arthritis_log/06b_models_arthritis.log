------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\arthritis_log\06b_models_arthritis.log
  log type:  text
 opened on:   3 Jul 2020, 11:10:08

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Sense check outcomes=======================================================*/ 
. 
. tab exposure $outcome, missing row

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
    current NSAID use |   561,414        435 |   561,849 
                      |     99.92       0.08 |    100.00 
----------------------+----------------------+----------
                Total |   561,414        435 |   561,849 
                      |     99.92       0.08 |    100.00 

. 
. /* Main Model=================================================================*/
. 
. /* Univariable model */ 
. 
. stcox i.exposure 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

note: 1.exposure omitted because of collinearity
Iteration 0:   log likelihood = -5758.1458
Refining estimates:
Iteration 0:   log likelihood = -5758.1458

Cox regression -- Breslow method for ties

No. of subjects =      561,849                  Number of obs    =     561,849
No. of failures =          435
Time at risk    =     65600525
                                                LR chi2(0)       =        0.00
Log likelihood  =   -5758.1458                  Prob > chi2      =           .

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |          1  (omitted)
------------------------------------------------------------------------------------

. estimates save ./$tempdir/univar, replace 
(note: file ./arthritis_tempdata/univar.ster not found)
file ./arthritis_tempdata/univar.ster saved

. 
. /* Multivariable models */ 
. 
. * Age and Gender 
. * Age fit as spline in first instance, categorical below 
. 
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

note: 1.exposure omitted because of collinearity
Iteration 0:   log likelihood = -5758.1458
Iteration 1:   log likelihood = -5497.5581
Iteration 2:   log likelihood = -5418.2102
Iteration 3:   log likelihood = -5416.9216
Iteration 4:   log likelihood = -5416.8827
Iteration 5:   log likelihood = -5416.8825
Refining estimates:
Iteration 0:   log likelihood = -5416.8825

Cox regression -- Breslow method for ties

No. of subjects =      561,849                  Number of obs    =     561,849
No. of failures =          435
Time at risk    =     65600525
                                                LR chi2(4)       =      682.53
Log likelihood  =   -5416.8825                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |          1  (omitted)
            1.male |   2.178335   .2106515     8.05   0.000     1.802233    2.632925
              age1 |   1.125157   .0505256     2.63   0.009     1.030361    1.228674
              age2 |   .9112374   .0750374    -1.13   0.259     .7754217    1.070841
              age3 |   1.533113   .3984514     1.64   0.100     .9211906    2.551519
------------------------------------------------------------------------------------

. estimates save ./$tempdir/multivar1, replace 
(note: file ./arthritis_tempdata/multivar1.ster not found)
file ./arthritis_tempdata/multivar1.ster saved

. 
. * Age, Gender and Comorbidities 
. stcox i.exposure i.male age1 age2 age3  i.obese4cat                                     ///
>                                                                                 i.smoke_nomiss                          ///
>                                                                                 i.imd                                           ///
>                                                                                 i.ckd                                           ///           
>   
>                                                                                 i.hypertension                          ///             
>                                                                                 i.heart_failure                         ///             
>                                                                                 i.other_heart_disease           ///             
>                                                                                 i.diabcat                                       ///     
>                                                                                 i.copd                      ///
>                                                                                 i.other_respiratory         ///
>                                                                                 i.immunodef_any                         ///
>                                                                                 i.cancer                                ///     
>                                                                             i.arthritis_type                    ///     
>                                                                                 i.statin                                        ///     
>                                                                                 i.ppi                       ///
>                                                                                 i.steroid_prednisolone      ///
>                                                                                 i.hydroxychloroquine        ///
>                                                                                 i.dmards_primary_care       ///
>                                                                                 i.flu_vaccine                           ///     
>                                                                                 i.pneumococcal_vaccine          ///     
>                                                                                 i.gp_consult                ///
>                                                                                 i.aande_attendance_last_year, strata(stp)                     
>           

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

note: 1.exposure omitted because of collinearity
Iteration 0:   log likelihood = -4356.2883
Iteration 1:   log likelihood = -4005.9386
Iteration 2:   log likelihood = -3873.1976
Iteration 3:   log likelihood = -3868.8478
Iteration 4:   log likelihood = -3868.6997
Iteration 5:   log likelihood = -3868.6649
Iteration 6:   log likelihood = -3868.6521
Iteration 7:   log likelihood = -3868.6474
Iteration 8:   log likelihood = -3868.6457
Iteration 9:   log likelihood =  -3868.645
Iteration 10:  log likelihood = -3868.6448
Iteration 11:  log likelihood = -3868.6447
Iteration 12:  log likelihood = -3868.6447
Iteration 13:  log likelihood = -3868.6447
Iteration 14:  log likelihood = -3868.6447
Iteration 15:  log likelihood = -3868.6447
Iteration 16:  log likelihood = -3868.6447
Iteration 17:  log likelihood = -3868.6447
Iteration 18:  log likelihood = -3868.6447
Iteration 19:  log likelihood = -3868.6447
Iteration 20:  log likelihood = -3868.6447
Iteration 21:  log likelihood = -3868.6447
Iteration 22:  log likelihood = -3868.6447
Iteration 23:  log likelihood = -3868.6447
Iteration 24:  log likelihood = -3868.6447
Iteration 25:  log likelihood = -3868.6447
Iteration 26:  log likelihood = -3868.6447
Iteration 27:  log likelihood = -3868.6447
Iteration 28:  log likelihood = -3868.6447
Iteration 29:  log likelihood = -3868.6447
Iteration 30:  log likelihood = -3868.6447
Iteration 31:  log likelihood = -3868.6447
Iteration 32:  log likelihood = -3868.6447
Refining estimates:
Iteration 0:   log likelihood = -3868.6447
Iteration 1:   log likelihood = -3868.6447

Stratified Cox regr. -- Breslow method for ties

No. of subjects =      561,849                  Number of obs    =     561,849
No. of failures =          435
Time at risk    =     65600525
                                                LR chi2(35)      =      975.29
Log likelihood  =   -3868.6447                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------------
                          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------------+----------------------------------------------------------------
                    exposure |
          current NSAID use  |          1  (omitted)
                      1.male |   2.234049    .221686     8.10   0.000     1.839193    2.713675
                        age1 |   1.132116   .0505882     2.78   0.005     1.037183    1.235739
                        age2 |   .9125251    .075474    -1.11   0.268     .7759663    1.073116
                        age3 |   1.450734   .3812188     1.42   0.157     .8667863    2.428083
                             |
                   obese4cat |
          Obese I (30-34.9)  |   .9600532   .1224272    -0.32   0.749     .7477372    1.232655
         Obese II (35-39.9)  |   1.218293   .2173252     1.11   0.268     .8588362    1.728198
            Obese III (40+)  |   1.204951   .3188646     0.70   0.481     .7173266    2.024052
                             |
                smoke_nomiss |
                     Former  |   1.103277   .1166075     0.93   0.352     .8968496    1.357219
                    Current  |   .7641503   .1680721    -1.22   0.221     .4965467    1.175974
                             |
                         imd |
                          2  |   1.209042   .1967552     1.17   0.243     .8788608    1.663271
                          3  |    1.45029   .2318321     2.33   0.020     1.060201    1.983907
                          4  |   1.747013    .279953     3.48   0.000     1.276127    2.391654
            5 most deprived  |    2.03172   .3339583     4.31   0.000     1.472143    2.803998
                             |
                         ckd |
                        CKD  |   1.311675   .1593947     2.23   0.026     1.033685    1.664425
              1.hypertension |   1.204005    .126163     1.77   0.076     .9804702    1.478504
             1.heart_failure |   1.366163   .2907988     1.47   0.143     .9001555    2.073422
       1.other_heart_disease |   1.012879   .2266635     0.06   0.954     .6532429     1.57051
                             |
                     diabcat |
        Controlled diabetes  |   1.317727   .1744447     2.08   0.037     1.016578    1.708087
      Uncontrolled diabetes  |   2.157508   .4222216     3.93   0.000     1.470189     3.16615
 Diabetes, no hba1c measure  |   1.00e-14   8.46e-08    -0.00   1.000            0           .
                             |
                      1.copd |   1.202204   .1982208     1.12   0.264     .8702235     1.66083
         1.other_respiratory |   1.863098   .3366894     3.44   0.001     1.307407    2.654974
             1.immunodef_any |   1.491614   .6748216     0.88   0.377     .6145595    3.620336
                    1.cancer |    1.79075   .1999919     5.22   0.000     1.438707    2.228936
                             |
              arthritis_type |
             Osteoarthritis  |   .5416228   .1336997    -2.48   0.013     .3338702    .8786505
               Both RA & OA  |   .5939805   .1650069    -1.88   0.061     .3445955    1.023846
                             |
                    1.statin |   .6118611   .0705823    -4.26   0.000     .4880464     .767087
                       1.ppi |   1.143182   .1124959     1.36   0.174     .9426532    1.386368
      1.steroid_prednisolone |   1.438026   .2342026     2.23   0.026     1.045049    1.978777
        1.hydroxychloroquine |   1.615103    .488592     1.58   0.113     .8926875     2.92214
       1.dmards_primary_care |     1.5058    .365199     1.69   0.091     .9361102    2.422187
               1.flu_vaccine |   1.052447   .1273391     0.42   0.673     .8302533    1.334105
      1.pneumococcal_vaccine |   1.115002    .163802     0.74   0.459     .8360414    1.487042
                1.gp_consult |   .6230632   .1673025    -1.76   0.078     .3681042    1.054614
1.aande_attendance_last_year |   2.407832   .2433776     8.69   0.000     1.975099    2.935375
----------------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates save ./$tempdir/multivar2, replace 
(note: file ./arthritis_tempdata/multivar2.ster not found)
file ./arthritis_tempdata/multivar2.ster saved

. 
. * Age, Gender and Comorbidities + Ethnicity (complete case)
. stcox i.exposure i.male age1 age2 age3  i.obese4cat                                     ///
>                                                                                 i.smoke_nomiss                          ///
>                                                                                 i.imd                                           ///
>                                                                                 i.ckd                                           ///           
>   
>                                                                                 i.hypertension                          ///             
>                                                                                 i.heart_failure                         ///             
>                                                                                 i.other_heart_disease           ///             
>                                                                                 i.diabcat                                       ///     
>                                                                                 i.copd                      ///
>                                                                                 i.other_respiratory         ///
>                                                                                 i.immunodef_any                         ///
>                                                                                 i.cancer                                ///     
>                                                                             i.arthritis_type                    ///             
>                                                                                 i.statin                                        ///     
>                                                                                 i.ppi                       ///
>                                                                                 i.steroid_prednisolone      ///
>                                                                                 i.hydroxychloroquine        ///
>                                                                                 i.dmards_primary_care       ///
>                                                                                 i.flu_vaccine                           ///     
>                                                                                 i.pneumococcal_vaccine          ///
>                                                                                 i.ethnicity                 ///
>                                                                                 i.gp_consult                ///
>                                                                                 i.aande_attendance_last_year, strata(stp)               

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

note: 1.exposure omitted because of collinearity
Iteration 0:   log likelihood = -3214.7544
Iteration 1:   log likelihood = -2983.0704
Iteration 2:   log likelihood = -2835.8042
Iteration 3:   log likelihood = -2829.4572
Iteration 4:   log likelihood =  -2829.239
Iteration 5:   log likelihood =  -2829.206
Iteration 6:   log likelihood = -2829.1939
Iteration 7:   log likelihood = -2829.1894
Iteration 8:   log likelihood = -2829.1878
Iteration 9:   log likelihood = -2829.1872
Iteration 10:  log likelihood =  -2829.187
Iteration 11:  log likelihood = -2829.1869
Iteration 12:  log likelihood = -2829.1869
Iteration 13:  log likelihood = -2829.1869
Iteration 14:  log likelihood = -2829.1869
Iteration 15:  log likelihood = -2829.1869
Iteration 16:  log likelihood = -2829.1868
Iteration 17:  log likelihood = -2829.1868
Iteration 18:  log likelihood = -2829.1868
Iteration 19:  log likelihood = -2829.1868
Iteration 20:  log likelihood = -2829.1868
Iteration 21:  log likelihood = -2829.1868
Iteration 22:  log likelihood = -2829.1868
Iteration 23:  log likelihood = -2829.1868
Iteration 24:  log likelihood = -2829.1868
Iteration 25:  log likelihood = -2829.1868
Iteration 26:  log likelihood = -2829.1868
Iteration 27:  log likelihood = -2829.1868
Iteration 28:  log likelihood = -2829.1868
Iteration 29:  log likelihood = -2829.1868
Iteration 30:  log likelihood = -2829.1868
Iteration 31:  log likelihood = -2829.1868
Iteration 32:  log likelihood = -2829.1868
Refining estimates:
Iteration 0:   log likelihood = -2829.1868
Iteration 1:   log likelihood = -2829.1868
Iteration 2:   log likelihood = -2829.1868
Iteration 3:   log likelihood = -2829.1868
Iteration 4:   log likelihood = -2829.1868
Iteration 5:   log likelihood = -2829.1868

Stratified Cox regr. -- Breslow method for ties

No. of subjects =      437,318                  Number of obs    =     437,318
No. of failures =          328
Time at risk    =     51067477
                                                LR chi2(39)      =      771.14
Log likelihood  =   -2829.1868                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------------
                          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------------+----------------------------------------------------------------
                    exposure |
          current NSAID use  |          1  (omitted)
                      1.male |   2.083778   .2375609     6.44   0.000     1.666519    2.605509
                        age1 |    1.18798   .0709055     2.89   0.004     1.056828    1.335407
                        age2 |   .8543944   .0908089    -1.48   0.139     .6937273    1.052272
                        age3 |   1.694844   .5606403     1.59   0.111     .8862563    3.241157
                             |
                   obese4cat |
          Obese I (30-34.9)  |   1.007075   .1453573     0.05   0.961     .7589315    1.336352
         Obese II (35-39.9)  |   1.232957   .2521944     1.02   0.306     .8257325    1.841011
            Obese III (40+)  |   1.411788   .4025486     1.21   0.226     .8073526    2.468743
                             |
                smoke_nomiss |
                     Former  |   1.102624   .1368892     0.79   0.431     .8644745    1.406381
                    Current  |   .8415123   .2081447    -0.70   0.485      .518226    1.366475
                             |
                         imd |
                          2  |   1.352251   .2604813     1.57   0.117     .9270264    1.972525
                          3  |   1.494369   .2869453     2.09   0.036      1.02568    2.177227
                          4  |   1.885442   .3583894     3.34   0.001     1.299017    2.736602
            5 most deprived  |   2.011778   .3958843     3.55   0.000     1.367973    2.958573
                             |
                         ckd |
                        CKD  |   1.539675   .2130771     3.12   0.002     1.173898    2.019424
              1.hypertension |    1.22821   .1492736     1.69   0.091     .9678757    1.558567
             1.heart_failure |   1.436729   .3437113     1.51   0.130     .8989595    2.296198
       1.other_heart_disease |   .9961814   .2545026    -0.01   0.988     .6037749    1.643622
                             |
                     diabcat |
        Controlled diabetes  |   1.201753    .187079     1.18   0.238     .8857415    1.630509
      Uncontrolled diabetes  |   2.313194   .4874382     3.98   0.000     1.530545    3.496053
 Diabetes, no hba1c measure  |   2.06e-16   1.32e-08    -0.00   1.000            0           .
                             |
                      1.copd |   1.168875   .2189263     0.83   0.405     .8097311    1.687311
         1.other_respiratory |   2.135418   .4219089     3.84   0.000     1.449791    3.145289
             1.immunodef_any |   1.970393   .8959425     1.49   0.136     .8081825    4.803925
                    1.cancer |   1.819849   .2346951     4.64   0.000     1.413386    2.343202
                             |
              arthritis_type |
             Osteoarthritis  |    .476276   .1322515    -2.67   0.008     .2763749     .820765
               Both RA & OA  |   .4606273   .1488552    -2.40   0.016     .2444993    .8678045
                             |
                    1.statin |   .5923469   .0783445    -3.96   0.000     .4570831    .7676391
                       1.ppi |   .9796936   .1111464    -0.18   0.856     .7843705    1.223656
      1.steroid_prednisolone |   1.569921   .2883409     2.46   0.014     1.095321    2.250166
        1.hydroxychloroquine |   1.309173   .4836984     0.73   0.466     .6346072    2.700781
       1.dmards_primary_care |   1.572757   .4379693     1.63   0.104     .9112245    2.714549
               1.flu_vaccine |   1.184824   .1683788     1.19   0.233     .8967827    1.565383
      1.pneumococcal_vaccine |   1.022539   .1704759     0.13   0.894     .7375119    1.417721
                             |
                   ethnicity |
                      Mixed  |    2.73392   1.394907     1.97   0.049     1.005735    7.431692
     Asian or Asian British  |   1.717048   .3974698     2.34   0.020     1.090794    2.702852
                      Black  |   1.200329   .4767929     0.46   0.646     .5510452    2.614648
                      Other  |   .7318517   .5239926    -0.44   0.663     .1798781    2.977611
                             |
                1.gp_consult |   .5833326   .1830993    -1.72   0.086     .3153094    1.079184
1.aande_attendance_last_year |   2.516522   .2924147     7.94   0.000     2.003977    3.160156
----------------------------------------------------------------------------------------------
                                                             Stratified by stp

. 
. estimates save ./$tempdir/multivar3, replace 
(note: file ./arthritis_tempdata/multivar3.ster not found)
file ./arthritis_tempdata/multivar3.ster saved

. 
. /* Print table================================================================*/ 
. *  Print the results for the main model 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table2.txt, write text replace
(note: file ./arthritis_output/table2.txt not found)

. 
. * Column headings 
. file write tablecontent ("Table 2: Association between current NSAID use and $tableoutcome - $population Population") _n

. file write tablecontent _tab ("Number of events") _tab ("Total person-weeks") _tab ("Rate per 1,000") _tab ("Univariable") _tab _tab ("Age/Sex
>  Adjusted") _tab _tab ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _tab ///
>                                                 ("Age/Sex and Comorbidity + Ethnicity Adjusted") _tab _tab _n

. file write tablecontent _tab _tab _tab _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ("95% CI") _n

. file write tablecontent ("Main Analysis") _n                                    

. 
. * Row headings 
. local lab0: label exposure 0

. local lab1: label exposure 1

.  
. /* Counts */
.  
. * First row, exposure = 0 (reference)
. 
.         cou if exposure == 0 & $outcome == 1
  0

.         local event = r(N)

.     bysort exposure: egen total_follow_up = total(_t)

.         su total_follow_up if exposure == 0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |          0

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         
.         file write tablecontent ("`lab0'") _tab

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

.         file write tablecontent ("1.00 (ref)") _tab _tab ("1.00 (ref)") _tab _tab ("1.00 (ref)") _n

.         
. * Second row, exposure = 1 (NSAID)
. 
. file write tablecontent ("`lab1'") _tab  

. 
.         cou if exposure == 1 & $outcome == 1
  435

.         local event = r(N)

.         su total_follow_up if exposure == 1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    561,849    6.56e+07           0   6.56e+07   6.56e+07

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

. 
. /* Main Model */ 
. estimates use ./$tempdir/univar 

. lincom 1.exposure, eform

 ( 1)  1o.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |          1  (omitted)
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar1 

. lincom 1.exposure, eform

 ( 1)  1o.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |          1  (omitted)
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar2  

. lincom 1.exposure, eform

 ( 1)  1o.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |          1  (omitted)
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar3

. lincom 1.exposure, eform

 ( 1)  1o.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |          1  (omitted)
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _n 

. 
. file write tablecontent _n

. file close tablecontent

. 
. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\arthritis_log\06b_models_arthritis.log
  log type:  text
 closed on:   3 Jul 2020, 11:18:03
------------------------------------------------------------------------------------------------------------------------------------------------
