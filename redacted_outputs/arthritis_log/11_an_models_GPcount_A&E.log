----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\arthritis_log\11_an_models_GPcount_A&E.log
  log type:  text
 opened on:  15 Jul 2020, 10:17:12

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Sense check outcomes=======================================================*/ 
. 
. safetab exposure $outcome, missing row
23

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use | 1,532,980      2,441 | 1,535,421 
                      |     99.84       0.16 |    100.00 
----------------------+----------------------+----------
    current NSAID use |   175,508        123 |   175,631 
                      |     99.93       0.07 |    100.00 
----------------------+----------------------+----------
                Total | 1,708,488      2,564 | 1,711,052 
                      |     99.85       0.15 |    100.00 

. 
. /* Main Model=================================================================*/
. 
. * Age, Gender and Comorbidities 
. stcox i.exposure i.male age1 age2 age3  $varlist                 ///
>                                                                                 i.gp_consult             ///
>                                                                                 i.aande_attendance_last_year, strata(stp)               

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -28512.712
Iteration 1:   log likelihood = -26143.948
Iteration 2:   log likelihood = -25522.739
Iteration 3:   log likelihood = -25514.043
Iteration 4:   log likelihood = -25513.859
Iteration 5:   log likelihood = -25513.858
Iteration 6:   log likelihood = -25513.858
Refining estimates:
Iteration 0:   log likelihood = -25513.858

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    1,711,052                  Number of obs    =   1,711,052
No. of failures =        2,564
Time at risk    =    176820188
                                                LR chi2(35)      =     5997.71
Log likelihood  =   -25513.858                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------------
                          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------------+----------------------------------------------------------------
                    exposure |
          current NSAID use  |   .8077206   .0777792    -2.22   0.027      .668798    .9755002
                      1.male |    1.67137   .0694063    12.37   0.000     1.540725    1.813093
                        age1 |    1.08852   .0211717     4.36   0.000     1.047806    1.130817
                        age2 |   1.031883   .0388439     0.83   0.404     .9584915    1.110895
                        age3 |   .9418077   .1166308    -0.48   0.628     .7388424    1.200529
                             |
                   obese4cat |
          Obese I (30-34.9)  |   .9967802   .0561643    -0.06   0.954     .8925608    1.113169
         Obese II (35-39.9)  |   1.369522   .1096084     3.93   0.000     1.170695    1.602116
            Obese III (40+)  |   1.985028   .2065253     6.59   0.000     1.618849    2.434035
                             |
                smoke_nomiss |
                     Former  |   1.169802   .0507409     3.62   0.000     1.074462    1.273602
                    Current  |   1.050767   .0999231     0.52   0.603     .8720898    1.266053
                             |
                         imd |
                          2  |   1.189438   .0807941     2.55   0.011     1.041173    1.358816
                          3  |   1.264113   .0858347     3.45   0.001     1.106594    1.444054
                          4  |   1.492411   .0992506     6.02   0.000     1.310027    1.700185
            5 most deprived  |   1.819452   .1209381     9.00   0.000     1.597208    2.072619
                             |
                         ckd |
                        CKD  |   1.244002   .0572836     4.74   0.000     1.136645    1.361498
              1.hypertension |   1.071765    .047252     1.57   0.116     .9830411    1.168496
             1.heart_failure |   1.318098   .0894277     4.07   0.000     1.153977    1.505561
       1.other_heart_disease |   1.058732   .0768594     0.79   0.432     .9183163    1.220617
                             |
                diab_control |
        Controlled diabetes  |   1.379668   .0727542     6.10   0.000     1.244194    1.529894
      Uncontrolled diabetes  |    2.05474   .1548862     9.55   0.000     1.772529    2.381882
                             |
                      1.copd |   1.149566   .0770463     2.08   0.038     1.008056    1.310941
         1.other_respiratory |   1.761604   .1286511     7.75   0.000     1.526668    2.032695
             1.immunodef_any |   1.516489   .3263656     1.93   0.053      .994606    2.312211
                    1.cancer |   1.264899   .0611909     4.86   0.000     1.150478    1.390701
                             |
              arthritis_type |
             Osteoarthritis  |   .6389692   .0774625    -3.69   0.000     .5038351    .8103478
               Both RA & OA  |   .8162017   .1154764    -1.44   0.151     .6185421    1.077025
                             |
                    1.statin |   .6684136   .0320214    -8.41   0.000     .6085092    .7342154
                       1.ppi |   1.196332   .0515919     4.16   0.000     1.099369    1.301846
      1.steroid_prednisolone |   1.430322   .0997504     5.13   0.000     1.247588    1.639821
        1.hydroxychloroquine |    1.24502   .2301384     1.19   0.236     .8666313    1.788622
       1.dmards_primary_care |   1.226286   .1492001     1.68   0.094     .9661125    1.556525
               1.flu_vaccine |   1.058448     .05281     1.14   0.255     .9598417    1.167183
      1.pneumococcal_vaccine |   1.035743   .0728358     0.50   0.617      .902389    1.188805
                1.gp_consult |   .5363498   .0413637    -8.08   0.000     .4611082     .623869
1.aande_attendance_last_year |   2.442798   .1021244    21.36   0.000     2.250619    2.651388
----------------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates save ./$tempdir/multivar_gp_ae, replace 
file ./arthritis_tempdata/multivar_gp_ae.ster saved

. 
. /* Print table================================================================*/ 
. *  Print the results for the main model 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table7.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 7: Association between current NSAID use and death - $population Population, additionally adjusted for GP count and A&E count") _n

. file write tablecontent _tab ("Number of events") _tab ("Total person-weeks") _tab ("Rate per 1,000") _tab ("Univariable") _tab _tab ("Age/Sex Adjusted") _tab _tab ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _tab _n

. file write tablecontent _tab _tab _tab _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("HR") _tab ("95% CI") _n

. file write tablecontent ("Sensitivity Analysis") _n                                     

. 
. * Row headings 
. local lab0: label exposure 0

. local lab1: label exposure 1

.  
. * First row, exposure = 0 (reference)
. 
.         safecount if exposure == 0 & $outcome == 1
  2,441

.         local event = r(N)

.     bysort exposure: egen total_follow_up = total(_t)

.         su total_follow_up if exposure == 0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |  1,535,421    1.58e+08           0   1.58e+08   1.58e+08

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         
.         file write tablecontent ("`lab0'") _tab

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

.         file write tablecontent ("1.00 (ref)") _tab _tab ("1.00 (ref)") _tab _tab ("1.00 (ref)") _n

.         
. * Second row, exposure = 1 (NSAID)
. 
. file write tablecontent ("`lab1'") _tab  

. 
.         safecount if exposure == 1 & $outcome == 1
  123

.         local event = r(N)

.         su total_follow_up if exposure == 1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    175,631    1.84e+07           0   1.84e+07   1.84e+07

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

. 
. /* Main Model */ 
. estimates use ./$tempdir/multivar_gp_ae

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .8077206   .0777792    -2.22   0.027      .668798    .9755002
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _n 

. 
. 
. file write tablecontent _n

. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\arthritis_log\11_an_models_GPcount_A&E.log
  log type:  text
 closed on:  15 Jul 2020, 10:20:54
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
