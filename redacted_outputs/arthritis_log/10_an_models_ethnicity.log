----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\arthritis_log\10_an_models_ethnicity.log
  log type:  text
 opened on:  15 Jul 2020, 10:13:40

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Restrict population========================================================*/ 
. 
. preserve 

. drop if ethnicity == .u
(400,236 observations deleted)

. 
. /* Sense check outcomes=======================================================*/ 
. 
. safetab exposure $outcome, missing row
23

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use | 1,173,467      1,809 | 1,175,276 
                      |     99.85       0.15 |    100.00 
----------------------+----------------------+----------
    current NSAID use |   135,454         86 |   135,540 
                      |     99.94       0.06 |    100.00 
----------------------+----------------------+----------
                Total | 1,308,921      1,895 | 1,310,816 
                      |     99.86       0.14 |    100.00 

. 
. /* Main Model=================================================================*/
. 
. /* Univariable model */ 
. 
. stcox i.exposure 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -26662.709
Iteration 1:   log likelihood = -26621.528
Iteration 2:   log likelihood = -26618.355
Iteration 3:   log likelihood = -26618.318
Iteration 4:   log likelihood = -26618.318
Refining estimates:
Iteration 0:   log likelihood = -26618.318

Cox regression -- Breslow method for ties

No. of subjects =    1,310,816                  Number of obs    =   1,310,816
No. of failures =        1,895
Time at risk    =    135453064
                                                LR chi2(1)       =       88.78
Log likelihood  =   -26618.318                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   .4056755   .0447729    -8.17   0.000     .3267645    .5036429
------------------------------------------------------------------------------------

. estimates save ./$tempdir/univar_ethn, replace 
file ./arthritis_tempdata/univar_ethn.ster saved

. 
. /* Multivariable models */ 
. 
. * Age and Gender 
. * Age fit as spline in first instance, categorical below 
. 
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -26662.709
Iteration 1:   log likelihood = -25446.843
Iteration 2:   log likelihood = -24914.543
Iteration 3:   log likelihood = -24912.165
Iteration 4:   log likelihood = -24912.147
Iteration 5:   log likelihood = -24912.147
Refining estimates:
Iteration 0:   log likelihood = -24912.147

Cox regression -- Breslow method for ties

No. of subjects =    1,310,816                  Number of obs    =   1,310,816
No. of failures =        1,895
Time at risk    =    135453064
                                                LR chi2(5)       =     3501.12
Log likelihood  =   -24912.147                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   .7836226   .0872863    -2.19   0.029     .6299313    .9748117
            1.male |   1.600007   .0752665     9.99   0.000     1.459084    1.754541
              age1 |   1.085838   .0239316     3.74   0.000     1.039931    1.133771
              age2 |     1.0236   .0434791     0.55   0.583     .9418333    1.112465
              age3 |   1.031186   .1437184     0.22   0.826     .7846997    1.355098
------------------------------------------------------------------------------------

. estimates save ./$tempdir/multivar1_ethn, replace 
file ./arthritis_tempdata/multivar1_ethn.ster saved

. 
. * Age, Gender and Comorbidities 
. stcox i.exposure i.male age1 age2 age3  $varlist   ///
>                                                                                 i.ethnicity, strata(stp)                

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -20621.262
Iteration 1:   log likelihood = -19135.845
Iteration 2:   log likelihood = -18519.149
Iteration 3:   log likelihood = -18509.483
Iteration 4:   log likelihood = -18509.413
Iteration 5:   log likelihood = -18509.413
Refining estimates:
Iteration 0:   log likelihood = -18509.413

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    1,310,816                  Number of obs    =   1,310,816
No. of failures =        1,895
Time at risk    =    135453064
                                                LR chi2(37)      =     4223.70
Log likelihood  =   -18509.413                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------
                     _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------+----------------------------------------------------------------
               exposure |
     current NSAID use  |   .7294695   .0836966    -2.75   0.006     .5825638    .9134205
                 1.male |   1.590404   .0770566     9.58   0.000     1.446325    1.748836
                   age1 |   1.096265   .0247027     4.08   0.000     1.048902    1.145767
                   age2 |   1.007645   .0437119     0.18   0.861     .9255127    1.097067
                   age3 |   1.057324   .1505555     0.39   0.695     .7998399    1.397698
                        |
              obese4cat |
     Obese I (30-34.9)  |   1.004198   .0645442     0.07   0.948     .8853378    1.139016
    Obese II (35-39.9)  |   1.370259   .1255872     3.44   0.001     1.144954    1.639899
       Obese III (40+)  |    2.07162   .2431656     6.20   0.000     1.645874    2.607496
                        |
           smoke_nomiss |
                Former  |   1.179223   .0604265     3.22   0.001     1.066542    1.303808
               Current  |   1.089449   .1191789     0.78   0.434     .8792061    1.349967
                        |
                    imd |
                     2  |   1.270407   .1040082     2.92   0.003      1.08207    1.491526
                     3  |    1.32238   .1085687     3.40   0.001     1.125828    1.553248
                     4  |   1.655389   .1313398     6.35   0.000     1.416984    1.933904
       5 most deprived  |   2.018144   .1601105     8.85   0.000     1.727514    2.357668
                        |
                    ckd |
                   CKD  |   1.321594   .0707689     5.21   0.000      1.18992    1.467839
         1.hypertension |     1.0721   .0554176     1.35   0.178     .9688041    1.186409
        1.heart_failure |   1.382494   .1103873     4.06   0.000     1.182219    1.616697
  1.other_heart_disease |   1.060602   .0893802     0.70   0.485     .8991227    1.251082
                        |
           diab_control |
   Controlled diabetes  |   1.419583    .085686     5.80   0.000     1.261195    1.597862
 Uncontrolled diabetes  |   2.044804   .1786594     8.19   0.000      1.72298     2.42674
                        |
                 1.copd |   1.220072   .0929857     2.61   0.009     1.050782    1.416636
    1.other_respiratory |   1.885833   .1572861     7.61   0.000     1.601436    2.220736
        1.immunodef_any |   1.517117   .3828881     1.65   0.099     .9251114    2.487965
               1.cancer |    1.30123   .0735251     4.66   0.000     1.164816    1.453619
                        |
         arthritis_type |
        Osteoarthritis  |   .6379007   .0909129    -3.15   0.002     .4824372    .8434619
          Both RA & OA  |   .7944361   .1320929    -1.38   0.166     .5734922    1.100501
                        |
               1.statin |   .6437278    .035424    -8.00   0.000     .5779113      .71704
                  1.ppi |   1.238701   .0616218     4.30   0.000     1.123625    1.365561
 1.steroid_prednisolone |   1.479759   .1203409     4.82   0.000     1.261733    1.735461
   1.hydroxychloroquine |   1.262612   .2675489     1.10   0.271     .8334883    1.912672
  1.dmards_primary_care |   1.203993   .1722509     1.30   0.194     .9095902    1.593684
          1.flu_vaccine |    1.00089    .057819     0.02   0.988     .8937464    1.120877
 1.pneumococcal_vaccine |   1.029549   .0820213     0.37   0.715     .8807121    1.203538
                        |
              ethnicity |
                 Mixed  |   1.575316   .4597861     1.56   0.119     .8890542    2.791304
Asian or Asian British  |   1.294442   .1558185     2.14   0.032     1.022396    1.638876
                 Black  |   .8886943   .1806625    -0.58   0.562     .5966392    1.323711
                 Other  |   1.280701   .3161938     1.00   0.316      .789394    2.077792
-----------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates save ./$tempdir/multivar2_ethn, replace 
file ./arthritis_tempdata/multivar2_ethn.ster saved

. 
. /* Print table================================================================*/ 
. *  Print the results for the main model 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table6.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 6: Association between current NSAID use and death - $population Population, restrict to known ethnicity") _n

. file write tablecontent _tab ("Number of events") _tab ("Total person-weeks") _tab ("Rate per 1,000") _tab ("Univariable") _tab _tab ("Age/Sex Adjusted") _tab _tab ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _tab _n

. file write tablecontent _tab _tab _tab _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("HR") _tab ("95% CI") _n

. file write tablecontent ("Main Analysis") _n                                    

. 
. * Row headings 
. local lab0: label exposure 0

. local lab1: label exposure 1

.  
. * First row, exposure = 0 (reference)
. 
.         safecount if exposure == 0 & $outcome == 1
  1,809

.         local event = r(N)

.     bysort exposure: egen total_follow_up = total(_t)

.         su total_follow_up if exposure == 0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |  1,175,276    1.21e+08           0   1.21e+08   1.21e+08

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         
.         file write tablecontent ("`lab0'") _tab

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

.         file write tablecontent ("1.00 (ref)") _tab _tab ("1.00 (ref)") _tab _tab ("1.00 (ref)") _n

.         
. * Second row, exposure = 1 (NSAID)
. 
. file write tablecontent ("`lab1'") _tab  

. 
.         safecount if exposure == 1 & $outcome == 1
  86

.         local event = r(N)

.         su total_follow_up if exposure == 1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    135,540    1.42e+07           0   1.42e+07   1.42e+07

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

. 
. /* Main Model */ 
. estimates use ./$tempdir/univar_ethn 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .4056755   .0447729    -8.17   0.000     .3267645    .5036429
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar1_ethn

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .7836226   .0872863    -2.19   0.029     .6299313    .9748117
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar2_ethn

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .7294695   .0836966    -2.75   0.006     .5825638    .9134205
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _n 

. 
. 
. file write tablecontent _n

. file close tablecontent

. 
. restore 

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\arthritis_log\10_an_models_ethnicity.log
  log type:  text
 closed on:  15 Jul 2020, 10:17:12
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
