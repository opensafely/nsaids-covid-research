----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\arthritis_log\07_an_models_interact.log
  log type:  text
 opened on:  15 Jul 2020, 09:24:16

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Age Interaction============================================================*/ 
. 
. /* Check Counts */ 
. 
. bysort age70: tab exposure $outcome, row

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> age70 = 0

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use |   840,244        255 |   840,499 
                      |     99.97       0.03 |    100.00 
----------------------+----------------------+----------
    current NSAID use |   122,629         40 |   122,669 
                      |     99.97       0.03 |    100.00 
----------------------+----------------------+----------
                Total |   962,873        295 |   963,168 
                      |     99.97       0.03 |    100.00 

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> age70 = 1

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use |   692,736      2,186 |   694,922 
                      |     99.69       0.31 |    100.00 
----------------------+----------------------+----------
    current NSAID use |    52,879         83 |    52,962 
                      |     99.84       0.16 |    100.00 
----------------------+----------------------+----------
                Total |   745,615      2,269 |   747,884 
                      |     99.70       0.30 |    100.00 


. 
. /* Univariable model */ 
. 
. stcox i.exposure i.age70

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -36758.737
Iteration 1:   log likelihood =     -35645
Iteration 2:   log likelihood = -35610.004
Iteration 3:   log likelihood = -35609.302
Iteration 4:   log likelihood = -35609.301
Refining estimates:
Iteration 0:   log likelihood = -35609.301

Cox regression -- Breslow method for ties

No. of subjects =    1,711,052                  Number of obs    =   1,711,052
No. of failures =        2,564
Time at risk    =    176820188
                                                LR chi2(2)       =     2298.87
Log likelihood  =   -35609.301                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   .5922759   .0548174    -5.66   0.000     .4940173    .7100778
           1.age70 |   9.652526    .598333    36.58   0.000     8.548253    10.89945
------------------------------------------------------------------------------------

. estimates store A

. 
. stcox i.exposure##i.age70

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -36758.737
Iteration 1:   log likelihood = -35636.394
Iteration 2:   log likelihood = -35603.683
Iteration 3:   log likelihood = -35602.838
Iteration 4:   log likelihood = -35602.837
Refining estimates:
Iteration 0:   log likelihood = -35602.837

Cox regression -- Breslow method for ties

No. of subjects =    1,711,052                  Number of obs    =   1,711,052
No. of failures =        2,564
Time at risk    =    176820188
                                                LR chi2(3)       =     2311.80
Log likelihood  =   -35602.837                  Prob > chi2      =      0.0000

--------------------------------------------------------------------------------------
                  _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
---------------------+----------------------------------------------------------------
            exposure |
  current NSAID use  |   1.055509   .1795035     0.32   0.751     .7563165    1.473059
             1.age70 |   10.33959    .684214    35.30   0.000     9.081878    11.77147
                     |
      exposure#age70 |
current NSAID use#1  |   .4663342   .0949162    -3.75   0.000     .3129295    .6949413
--------------------------------------------------------------------------------------

. estimates store B

. estimates save ./$tempdir/univar_int, replace 
file ./arthritis_tempdata/univar_int.ster saved

. 
. lrtest A B

Likelihood-ratio test                                 LR chi2(1)  =     12.93
(Assumption: A nested in B)                           Prob > chi2 =    0.0003

. local univar_p = round(r(p),0.001)

. 
. /* Multivariable models */ 
. 
. * Age and Gender 
. 
. stcox i.exposure i.age70 i.male

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -36758.737
Iteration 1:   log likelihood = -35612.484
Iteration 2:   log likelihood = -35577.112
Iteration 3:   log likelihood = -35576.399
Iteration 4:   log likelihood = -35576.399
Refining estimates:
Iteration 0:   log likelihood = -35576.399

Cox regression -- Breslow method for ties

No. of subjects =    1,711,052                  Number of obs    =   1,711,052
No. of failures =        2,564
Time at risk    =    176820188
                                                LR chi2(3)       =     2364.68
Log likelihood  =   -35576.399                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   .5904886   .0546468    -5.69   0.000     .4925349    .7079231
           1.age70 |   9.846048   .6107555    36.87   0.000     8.718895    11.11891
            1.male |   1.386789   .0553622     8.19   0.000     1.282418    1.499655
------------------------------------------------------------------------------------

. estimates store A

. 
. stcox i.exposure##i.age70 i.male

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -36758.737
Iteration 1:   log likelihood = -35603.279
Iteration 2:   log likelihood = -35570.483
Iteration 3:   log likelihood = -35569.636
Iteration 4:   log likelihood = -35569.635
Refining estimates:
Iteration 0:   log likelihood = -35569.635

Cox regression -- Breslow method for ties

No. of subjects =    1,711,052                  Number of obs    =   1,711,052
No. of failures =        2,564
Time at risk    =    176820188
                                                LR chi2(4)       =     2378.20
Log likelihood  =   -35569.635                  Prob > chi2      =      0.0000

--------------------------------------------------------------------------------------
                  _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
---------------------+----------------------------------------------------------------
            exposure |
  current NSAID use  |   1.068214   .1816711     0.39   0.698     .7654107    1.490809
             1.age70 |   10.56219   .6995042    35.59   0.000     9.276435    12.02615
                     |
      exposure#age70 |
current NSAID use#1  |   .4578111   .0931873    -3.84   0.000     .3072023    .6822572
                     |
              1.male |    1.38888    .055446     8.23   0.000     1.284351    1.501917
--------------------------------------------------------------------------------------

. estimates store B

. estimates save ./$tempdir/multivar1_int, replace 
file ./arthritis_tempdata/multivar1_int.ster saved

. 
. lrtest A B

Likelihood-ratio test                                 LR chi2(1)  =     13.53
(Assumption: A nested in B)                           Prob > chi2 =    0.0002

. local multivar1_p = round(r(p),0.001)

. 
. * Age, Gender and Comorbidities 
. stcox i.exposure i.age70 i.male $varlist, strata(stp)           

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -28512.712
Iteration 1:   log likelihood = -26956.678
Iteration 2:   log likelihood = -26586.561
Iteration 3:   log likelihood = -26575.224
Iteration 4:   log likelihood = -26575.132
Iteration 5:   log likelihood = -26575.132
Refining estimates:
Iteration 0:   log likelihood = -26575.132

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    1,711,052                  Number of obs    =   1,711,052
No. of failures =        2,564
Time at risk    =    176820188
                                                LR chi2(31)      =     3875.16
Log likelihood  =   -26575.132                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
    current NSAID use  |   .6078355   .0581018    -5.21   0.000     .5039894    .7330789
               1.age70 |   7.043866    .484326    28.39   0.000     6.155789    8.060064
                1.male |   1.453209   .0596418     9.11   0.000     1.340891    1.574935
                       |
             obese4cat |
    Obese I (30-34.9)  |   .7414048   .0412558    -5.38   0.000     .6647982    .8268389
   Obese II (35-39.9)  |   .8867122   .0699988    -1.52   0.128     .7596039     1.03509
      Obese III (40+)  |     1.1272   .1155517     1.17   0.243     .9220248    1.378033
                       |
          smoke_nomiss |
               Former  |   1.134321    .049111     2.91   0.004     1.042036    1.234779
              Current  |   .7821096   .0737525    -2.61   0.009     .6501293    .9408826
                       |
                   imd |
                    2  |   1.207531   .0820404     2.78   0.006     1.056981    1.379524
                    3  |   1.299204   .0882684     3.85   0.000     1.137225    1.484255
                    4  |   1.556833   .1037078     6.64   0.000      1.36628    1.773963
      5 most deprived  |   1.978619   .1318619    10.24   0.000     1.736341    2.254702
                       |
                   ckd |
                  CKD  |   1.966322   .0884319    15.03   0.000     1.800418    2.147513
        1.hypertension |   1.338516   .0591033     6.60   0.000     1.227546    1.459517
       1.heart_failure |   1.928091   .1318305     9.60   0.000     1.686273    2.204587
 1.other_heart_disease |   1.180825   .0866681     2.26   0.024     1.022611    1.363517
                       |
          diab_control |
  Controlled diabetes  |   1.436485   .0759976     6.85   0.000     1.294995    1.593434
Uncontrolled diabetes  |   2.063426   .1557366     9.60   0.000     1.779692    2.392397
                       |
                1.copd |   1.174414   .0785677     2.40   0.016     1.030093    1.338956
   1.other_respiratory |   2.037556   .1478292     9.81   0.000     1.767474    2.348908
       1.immunodef_any |   1.374402   .2956395     1.48   0.139     .9016064    2.095129
              1.cancer |   1.365222   .0660059     6.44   0.000     1.241794     1.50092
                       |
        arthritis_type |
       Osteoarthritis  |   .7595099   .0911555    -2.29   0.022     .6003067    .9609343
         Both RA & OA  |   .9884486   .1398306    -0.08   0.935     .7490988    1.304275
                       |
              1.statin |   .4919684    .023063   -15.13   0.000     .4487803    .5393127
                 1.ppi |   1.255738   .0540564     5.29   0.000     1.154136    1.366285
1.steroid_prednisolone |   1.473306   .1031065     5.54   0.000     1.284468    1.689906
  1.hydroxychloroquine |   1.026838   .1887606     0.14   0.885     .7161896     1.47223
 1.dmards_primary_care |   1.045503   .1250627     0.37   0.710     .8269985    1.321739
         1.flu_vaccine |   1.147404   .0572736     2.75   0.006     1.040466    1.265332
1.pneumococcal_vaccine |   .7475098   .0514277    -4.23   0.000     .6532139     .855418
----------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates store A

. 
. stcox i.exposure##i.age70 i.male $varlist, strata(stp)          

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -28512.712
Iteration 1:   log likelihood = -26946.707
Iteration 2:   log likelihood = -26582.504
Iteration 3:   log likelihood = -26571.448
Iteration 4:   log likelihood = -26571.358
Iteration 5:   log likelihood = -26571.358
Refining estimates:
Iteration 0:   log likelihood = -26571.358

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    1,711,052                  Number of obs    =   1,711,052
No. of failures =        2,564
Time at risk    =    176820188
                                                LR chi2(32)      =     3882.71
Log likelihood  =   -26571.358                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
    current NSAID use  |   .9334305   .1603462    -0.40   0.688     .6665938    1.307082
               1.age70 |   7.444025   .5402377    27.66   0.000     6.457037    8.581878
                       |
        exposure#age70 |
  current NSAID use#1  |   .5616983   .1144289    -2.83   0.005     .3767877    .8373548
                       |
                1.male |   1.454988   .0597188     9.14   0.000     1.342525    1.576871
                       |
             obese4cat |
    Obese I (30-34.9)  |   .7415546   .0412655    -5.37   0.000     .6649302    .8270088
   Obese II (35-39.9)  |    .886303   .0699739    -1.53   0.126     .7592409    1.034629
      Obese III (40+)  |   1.124417   .1152973     1.14   0.253     .9196988    1.374705
                       |
          smoke_nomiss |
               Former  |   1.134101   .0491005     2.91   0.004     1.041836    1.234537
              Current  |   .7815682    .073707    -2.61   0.009     .6496703    .9402443
                       |
                   imd |
                    2  |   1.207312   .0820261     2.77   0.006     1.056788    1.379275
                    3  |   1.298442    .088218     3.84   0.000     1.136556    1.483387
                    4  |   1.555387   .1036147     6.63   0.000     1.365005    1.772322
      5 most deprived  |   1.974934   .1316288    10.21   0.000     1.733087    2.250531
                       |
                   ckd |
                  CKD  |   1.964115    .088344    15.01   0.000     1.798377    2.145128
        1.hypertension |   1.337663   .0590605     6.59   0.000     1.226774    1.458576
       1.heart_failure |   1.923251   .1314982     9.57   0.000     1.682042     2.19905
 1.other_heart_disease |   1.179428   .0865645     2.25   0.025     1.021403    1.361901
                       |
          diab_control |
  Controlled diabetes  |   1.435457   .0759407     6.83   0.000     1.294072    1.592288
Uncontrolled diabetes  |   2.061383   .1555725     9.58   0.000     1.777945    2.390005
                       |
                1.copd |    1.17438   .0785694     2.40   0.016     1.030056    1.338926
   1.other_respiratory |   2.037351   .1478208     9.81   0.000     1.767285    2.348687
       1.immunodef_any |   1.376926   .2961772     1.49   0.137     .9032683     2.09896
              1.cancer |   1.364797   .0659888     6.43   0.000       1.2414    1.500459
                       |
        arthritis_type |
       Osteoarthritis  |   .7614078   .0914256    -2.27   0.023     .6017412    .9634405
         Both RA & OA  |   .9923857   .1404044    -0.05   0.957     .7520575    1.309513
                       |
              1.statin |   .4923003   .0230781   -15.12   0.000     .4490837    .5396757
                 1.ppi |   1.255067   .0539832     5.28   0.000     1.153599     1.36546
1.steroid_prednisolone |   1.473317    .103099     5.54   0.000     1.284492      1.6899
  1.hydroxychloroquine |   1.024163   .1882771     0.13   0.897     .7143126    1.468418
 1.dmards_primary_care |   1.044252   .1248992     0.36   0.717     .8260311    1.320123
         1.flu_vaccine |   1.146374   .0571987     2.74   0.006     1.039574    1.264146
1.pneumococcal_vaccine |   .7484753   .0514955    -4.21   0.000     .6540551     .856526
----------------------------------------------------------------------------------------
                                                             Stratified by stp

. estimates store B

. estimates save ./$tempdir/multivar2_int, replace 
file ./arthritis_tempdata/multivar2_int.ster saved

. 
. lrtest A B

Likelihood-ratio test                                 LR chi2(1)  =      7.55
(Assumption: A nested in B)                           Prob > chi2 =    0.0060

. local multivar2_p = round(r(p),0.001)

. 
. /* Print interaction table====================================================*/ 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table3.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 3: Current NSAID use and $outcome, Age Interaction - $population Population") _n

. file write tablecontent  _tab ("Number of events") _tab ("Total person-weeks") _tab ("Rate per 1,000") _tab ("Univariable") _tab _tab _tab ("Age/Sex Adjusted") _tab _tab 
> _tab  ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _tab _tab _n

. file write tablecontent _tab _tab _tab _tab ("HR") _tab ("95% CI") _tab ("p (interaction)") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("p (interaction)") _tab ("HR") _tab ("95% CI") _tab ("p (interaction)") _tab _n

. 
. * Overall p-values 
. file write tablecontent ("Agegroup") _tab _tab _tab _tab _tab _tab ("`univar_p'") ///
>                                                 _tab _tab _tab ("`multivar1_p'") /// 
>                                                 _tab _tab _tab ("`multivar2_p'") _n

. 
.                                                 
. * Generic program to print model for a level of another variable 
. cap prog drop printinteraction

. prog define printinteraction 
  1. syntax, variable(varname) min(real) max(real) 
  2. 
.         forvalues varlevel = `min'/`max'{ 
  3. 
.                 * Row headings 
.                 file write tablecontent ("`varlevel'") _n       
  4. 
.                 local lab0: label exposure 0
  5.                 local lab1: label exposure 1
  6.                  
.                 /* Counts */
.                         
.                 * First row, exposure = 0 (reference)
.                 
.         file write tablecontent ("`lab0'") _tab
  7. 
.                         safecount if exposure == 0  & `variable' == `varlevel' & $outcome == 1
  8.             local event = r(N)
  9.                     bysort exposure `variable': egen total_follow_up = total(_t)
 10.             su total_follow_up if exposure == 0 & `variable' == `varlevel'
 11.             local person_week = r(mean)/7
 12.             local rate = 1000*(`event'/`person_week')
 13. 
.                         
.                 file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab
 14.         file write tablecontent ("1.00 (ref)") _tab _tab ("1.00 (ref)") _tab _tab ("1.00 (ref)") _n
 15. 
.                         
.                 * Second row, exposure = 1 (NSAID)
. 
.                 file write tablecontent ("`lab1'") _tab  
 16. 
. 
.                         safecount if exposure == 1 & `variable' == `varlevel' & $outcome == 1
 17.                 local event = r(N)
 18.             su total_follow_up if exposure == 1 & `variable' == `varlevel'
 19.             local person_week = r(mean)/7
 20.             local rate = 1000*(`event'/`person_week')
 21.             file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab
 22. 
.                 * Print models 
.                 estimates use ./$tempdir/univar_int 
 23.                 qui lincom 1.exposure + 1.exposure#`varlevel'.`variable', eform
 24.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab _tab
 25. 
.                 estimates use ./$tempdir/multivar1_int
 26.                 qui lincom 1.exposure + 1.exposure#`varlevel'.`variable', eform
 27.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab _tab
 28. 
.                 estimates use ./$tempdir/multivar2_int
 29.                 qui lincom 1.exposure + 1.exposure#`varlevel'.`variable', eform
 30.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab _n 
 31. 
.                 drop total_follow_up
 32.         } 
 33.                 
. end

. 
. printinteraction, variable(age70) min(0) max(1) 
  255

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    840,499    8.66e+07           0   8.66e+07   8.66e+07
  40

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    122,669    1.29e+07           0   1.29e+07   1.29e+07
  2,186

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    694,922    7.18e+07           0   7.18e+07   7.18e+07
  83

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |     52,962     5538445           0    5538445    5538445

. 
. file write tablecontent _n

. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\arthritis_log\07_an_models_interact.log
  log type:  text
 closed on:  15 Jul 2020, 09:34:21
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
