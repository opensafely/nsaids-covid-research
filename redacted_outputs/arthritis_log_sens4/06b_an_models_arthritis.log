----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\arthritis_log_sens4\06b_an_models_arthritis.log
  log type:  text
 opened on:  15 Jul 2020, 14:17:35

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Sense check outcomes=======================================================*/ 
. 
. tab exposure $outcome, missing row

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use | 1,532,980      2,441 | 1,535,421 
                      |     99.84       0.16 |    100.00 
----------------------+----------------------+----------
    current NSAID use |   173,959        122 |   174,081 
                      |     99.93       0.07 |    100.00 
----------------------+----------------------+----------
                Total | 1,706,939      2,563 | 1,709,502 
                      |     99.85       0.15 |    100.00 

. 
. /* Main Model=================================================================*/
. 
. /* Univariable model */ 
. 
. stcox i.exposure 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -36742.039
Iteration 1:   log likelihood = -36692.882
Iteration 2:   log likelihood = -36689.505
Iteration 3:   log likelihood = -36689.475
Iteration 4:   log likelihood = -36689.475
Refining estimates:
Iteration 0:   log likelihood = -36689.475

Cox regression -- Breslow method for ties

No. of subjects =    1,709,502                  Number of obs    =   1,709,502
No. of failures =        2,563
Time at risk    =    176657648
                                                LR chi2(1)       =      105.13
Log likelihood  =   -36689.475                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   .4338921   .0402525    -9.00   0.000     .3617555    .5204132
------------------------------------------------------------------------------------

. estimates save ./$tempdir/univar, replace 
file ./arthritis_tempdata_sens4/univar.ster saved

. 
. /* Multivariable models */ 
. 
. * Age and Gender 
. * Age fit as spline in first instance, categorical below 
. 
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -36742.039
Iteration 1:   log likelihood = -34937.709
Iteration 2:   log likelihood =  -34456.09
Iteration 3:   log likelihood = -34451.421
Iteration 4:   log likelihood = -34451.118
Iteration 5:   log likelihood = -34451.115
Iteration 6:   log likelihood = -34451.115
Refining estimates:
Iteration 0:   log likelihood = -34451.115

Cox regression -- Breslow method for ties

No. of subjects =    1,709,502                  Number of obs    =   1,709,502
No. of failures =        2,563
Time at risk    =    176657648
                                                LR chi2(5)       =     4581.85
Log likelihood  =   -34451.115                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   .8373691   .0784043    -1.90   0.058     .6969755    1.006043
            1.male |   1.665921   .0671905    12.65   0.000       1.5393    1.802957
              age1 |   1.077468   .0206128     3.90   0.000     1.037815    1.118635
              age2 |   1.043571   .0386101     1.15   0.249     .9705749    1.122056
              age3 |   .9541236    .115982    -0.39   0.699     .7518543    1.210809
------------------------------------------------------------------------------------

. estimates save ./$tempdir/multivar1, replace 
file ./arthritis_tempdata_sens4/multivar1.ster saved

. 
. * Age, Gender and Comorbidities (note: diabetes variable is diabcat)
. stcox i.exposure i.male age1 age2 age3  i.obese4cat                                     ///
>                                                                                 i.smoke_nomiss                          ///
>                                                                                 i.imd                                           ///
>                                                                                 i.ckd                                           ///             
>                                                                                 i.hypertension                          ///             
>                                                                                 i.heart_failure                         ///             
>                                                                                 i.other_heart_disease           ///             
>                                                                                 i.diabcat                                       ///     
>                                                                                 i.copd                      ///
>                                                                                 i.other_respiratory         ///
>                                                                                 i.immunodef_any                         ///
>                                                                                 i.cancer                                ///     
>                                                                             i.arthritis_type                    ///     
>                                                                                 i.statin                                        ///     
>                                                                                 i.ppi                       ///
>                                                                                 i.steroid_prednisolone      ///
>                                                                                 i.hydroxychloroquine        ///
>                                                                                 i.dmards_primary_care       ///
>                                                                                 i.flu_vaccine                           ///     
>                                                                                 i.pneumococcal_vaccine, strata(stp)                             

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -28499.386
Iteration 1:   log likelihood =   -26332.5
Iteration 2:   log likelihood =  -25742.64
Iteration 3:   log likelihood = -25734.349
Iteration 4:   log likelihood = -25734.153
Iteration 5:   log likelihood = -25734.152
Iteration 6:   log likelihood = -25734.152
Refining estimates:
Iteration 0:   log likelihood = -25734.152

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    1,709,502                  Number of obs    =   1,709,502
No. of failures =        2,563
Time at risk    =    176657648
                                                LR chi2(34)      =     5530.47
Log likelihood  =   -25734.152                  Prob > chi2      =      0.0000

---------------------------------------------------------------------------------------------
                         _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
----------------------------+----------------------------------------------------------------
                   exposure |
         current NSAID use  |   .7837558   .0757311    -2.52   0.012     .6485338    .9471721
                     1.male |   1.657318   .0688514    12.16   0.000      1.52772    1.797911
                       age1 |   1.085032   .0211768     4.18   0.000      1.04431    1.127341
                       age2 |   1.032452   .0389608     0.85   0.397     .9588462    1.111709
                       age3 |   .9686777   .1201724    -0.26   0.798     .7595927    1.235315
                            |
                  obese4cat |
         Obese I (30-34.9)  |   .9820884   .0553364    -0.32   0.748     .8794052    1.096761
        Obese II (35-39.9)  |    1.35103   .1081482     3.76   0.000     1.154855     1.58053
           Obese III (40+)  |    1.98084    .206234     6.57   0.000     1.615202    2.429247
                            |
               smoke_nomiss |
                    Former  |    1.17109   .0507575     3.64   0.000     1.075716    1.274921
                   Current  |   1.071609   .1018421     0.73   0.467     .8894895    1.291016
                            |
                        imd |
                         2  |   1.203586    .081805     2.73   0.006     1.053472    1.375091
                         3  |    1.28924   .0875535     3.74   0.000     1.128568    1.472786
                         4  |   1.534636   .1020357     6.44   0.000     1.347132    1.748237
           5 most deprived  |   1.913738   .1272333     9.76   0.000     1.679929    2.180087
                            |
                        ckd |
                       CKD  |   1.235772   .0567922     4.61   0.000     1.129327     1.35225
             1.hypertension |   1.063505   .0468343     1.40   0.162     .9755609    1.159376
            1.heart_failure |   1.444389   .0978095     5.43   0.000     1.264863    1.649395
      1.other_heart_disease |   1.107546   .0804119     1.41   0.159     .9606416    1.276915
                            |
                    diabcat |
       Controlled diabetes  |    1.39531   .0735372     6.32   0.000     1.258374    1.547148
     Uncontrolled diabetes  |   2.237371   .1713351    10.52   0.000     1.925547    2.599692
Diabetes, no hba1c measure  |   .8433116   .3453939    -0.42   0.677     .3778877    1.881973
                            |
                     1.copd |   1.182835   .0791635     2.51   0.012     1.037423    1.348629
        1.other_respiratory |   1.860238   .1358009     8.50   0.000     1.612238    2.146386
            1.immunodef_any |   1.594352   .3431349     2.17   0.030     1.045658    2.430967
                   1.cancer |   1.295403   .0626273     5.35   0.000     1.178291    1.424153
                            |
             arthritis_type |
            Osteoarthritis  |   .6377027   .0778581    -3.68   0.000     .5019885    .8101077
              Both RA & OA  |   .8474869   .1202814    -1.17   0.244     .6416887    1.119287
                            |
                   1.statin |   .6459639   .0309359    -9.13   0.000     .5880893    .7095339
                      1.ppi |   1.252753   .0537276     5.25   0.000     1.151753     1.36261
     1.steroid_prednisolone |   1.528422   .1062284     6.10   0.000     1.333777    1.751473
       1.hydroxychloroquine |   1.173099   .2195678     0.85   0.394     .8128608    1.692986
      1.dmards_primary_care |   1.183016   .1445108     1.38   0.169     .9311341    1.503033
              1.flu_vaccine |   .9883006   .0484862    -0.24   0.810     .8976954    1.088051
     1.pneumococcal_vaccine |   1.039733   .0731454     0.55   0.580     .9058152    1.193449
---------------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates save ./$tempdir/multivar2, replace 
file ./arthritis_tempdata_sens4/multivar2.ster saved

. 
. * Age, Gender and Comorbidities (note: changed diabetes category: grouped no HbA1c to uncontrolled DM after first run because diab causing the model not to converge)
. stcox i.exposure i.male age1 age2 age3  $varlist, strata(stp)

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -28499.386
Iteration 1:   log likelihood = -26337.379
Iteration 2:   log likelihood = -25746.483
Iteration 3:   log likelihood = -25738.154
Iteration 4:   log likelihood = -25737.957
Iteration 5:   log likelihood = -25737.957
Iteration 6:   log likelihood = -25737.957
Refining estimates:
Iteration 0:   log likelihood = -25737.957

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    1,709,502                  Number of obs    =   1,709,502
No. of failures =        2,563
Time at risk    =    176657648
                                                LR chi2(33)      =     5522.86
Log likelihood  =   -25737.957                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
    current NSAID use  |   .7828563   .0756459    -2.53   0.011     .6477867    .9460892
                1.male |   1.658995   .0689146    12.19   0.000     1.529277    1.799716
                  age1 |   1.084988   .0211683     4.18   0.000     1.044282    1.127281
                  age2 |   1.032448   .0389503     0.85   0.397     .9588606    1.111682
                  age3 |   .9684733   .1201216    -0.26   0.796     .7594716    1.234991
                       |
             obese4cat |
    Obese I (30-34.9)  |   .9842702   .0554442    -0.28   0.778     .8813855    1.099165
   Obese II (35-39.9)  |   1.356429   .1085445     3.81   0.000      1.15953    1.586764
      Obese III (40+)  |   1.992389   .2073606     6.62   0.000     1.624741    2.443229
                       |
          smoke_nomiss |
               Former  |   1.172492   .0508126     3.67   0.000     1.077014    1.276435
              Current  |    1.07232    .101908     0.73   0.463     .8900825    1.291868
                       |
                   imd |
                    2  |   1.204848   .0818903     2.74   0.006     1.054577    1.376531
                    3  |    1.28998   .0876036     3.75   0.000     1.129216    1.473631
                    4  |   1.536657   .1021726     6.46   0.000     1.348902    1.750546
      5 most deprived  |   1.915402   .1273447     9.78   0.000     1.681389    2.181985
                       |
                   ckd |
                  CKD  |   1.239685   .0569382     4.68   0.000     1.132964    1.356459
        1.hypertension |   1.063958   .0468547     1.41   0.159     .9759763    1.159871
       1.heart_failure |   1.446238   .0979214     5.45   0.000     1.266505    1.651478
 1.other_heart_disease |   1.107275   .0803943     1.40   0.160     .9604032    1.276608
                       |
          diab_control |
  Controlled diabetes  |   1.391917   .0733466     6.28   0.000     1.255335     1.54336
Uncontrolled diabetes  |   2.131151   .1605273    10.05   0.000     1.838646    2.470189
                       |
                1.copd |    1.18296   .0791667     2.51   0.012     1.037542     1.34876
   1.other_respiratory |   1.858428   .1356603     8.49   0.000     1.610684    2.144279
       1.immunodef_any |   1.596002   .3434802     2.17   0.030     1.046753    2.433453
              1.cancer |   1.295349   .0626242     5.35   0.000     1.178244    1.424094
                       |
        arthritis_type |
       Osteoarthritis  |   .6380699   .0778994    -3.68   0.000     .5022829    .8105653
         Both RA & OA  |   .8467362   .1201749    -1.17   0.241     .6411202    1.118296
                       |
              1.statin |   .6485496   .0310303    -9.05   0.000     .5904959    .7123108
                 1.ppi |   1.253774   .0537716     5.27   0.000     1.152692    1.363721
1.steroid_prednisolone |   1.529824     .10633     6.12   0.000     1.334993     1.75309
  1.hydroxychloroquine |   1.172337   .2194193     0.85   0.396     .8123407    1.691869
 1.dmards_primary_care |   1.182529   .1444607     1.37   0.170      .930737    1.502439
         1.flu_vaccine |   .9895962   .0485553    -0.21   0.831     .8988624    1.089489
1.pneumococcal_vaccine |   1.038902   .0730904     0.54   0.587     .9050857    1.192504
----------------------------------------------------------------------------------------
                                                             Stratified by stp

. 
. estimates save ./$tempdir/multivar3, replace 
file ./arthritis_tempdata_sens4/multivar3.ster saved

. 
. /* Print table================================================================*/ 
. *  Print the results for the main model 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table2.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 2: Association between current NSAID use and $tableoutcome - $population Population") _n

. file write tablecontent _tab ("Number of events") _tab ("Total person-weeks") _tab ("Rate per 1,000") _tab ("Univariable") _tab _tab ("Age/Sex Adjusted") _tab _tab ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _tab ///
>                                                 ("Age/Sex and Comorbidity (diabetes regroup)") _tab _tab _n

. file write tablecontent _tab _tab _tab _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ("95% CI") _n

. file write tablecontent ("Main Analysis") _n                                    

. 
. * Row headings 
. local lab0: label exposure 0

. local lab1: label exposure 1

.  
. /* Counts */
.  
. * First row, exposure = 0 (reference)
. 
.         safecount if exposure == 0 & $outcome == 1
  2,441

.         local event = r(N)

.     bysort exposure: egen total_follow_up = total(_t)

.         su total_follow_up if exposure == 0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |  1,535,421    1.58e+08           0   1.58e+08   1.58e+08

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         
.         file write tablecontent ("`lab0'") _tab

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

.         file write tablecontent ("1.00 (ref)") _tab _tab ("1.00 (ref)") _tab _tab ("1.00 (ref)") _n

.         
. * Second row, exposure = 1 (NSAID)
. 
. file write tablecontent ("`lab1'") _tab  

. 
.         safecount if exposure == 1 & $outcome == 1
  122

.         local event = r(N)

.         su total_follow_up if exposure == 1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    174,081    1.82e+07           0   1.82e+07   1.82e+07

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

. 
. /* Main Model */ 
. estimates use ./$tempdir/univar 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .4338921   .0402525    -9.00   0.000     .3617555    .5204132
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar1 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .8373691   .0784043    -1.90   0.058     .6969755    1.006043
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar2  

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .7837558   .0757311    -2.52   0.012     .6485338    .9471721
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar3

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .7828563   .0756459    -2.53   0.011     .6477867    .9460892
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _n 

. 
. file write tablecontent _n

. file close tablecontent

. 
. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\arthritis_log_sens4\06b_an_models_arthritis.log
  log type:  text
 closed on:  15 Jul 2020, 14:25:31
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
