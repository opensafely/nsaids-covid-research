----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\nsaid_log_sens5\06a_an_models_nsaid.log
  log type:  text
 opened on:  15 Jul 2020, 06:37:07

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Sense check outcomes=======================================================*/ 
. 
. safetab exposure $outcome, missing row
23

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use | 1,878,437        564 | 1,879,001 
                      |     99.97       0.03 |    100.00 
----------------------+----------------------+----------
    current NSAID use |   519,753        207 |   519,960 
                      |     99.96       0.04 |    100.00 
----------------------+----------------------+----------
                Total | 2,398,190        771 | 2,398,961 
                      |     99.97       0.03 |    100.00 

. 
. /* Main Model=================================================================*/
. 
. /* Univariable model */ 
. 
. stcox i.exposure 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -11309.583
Iteration 1:   log likelihood = -11304.847
Iteration 2:   log likelihood = -11304.822
Iteration 3:   log likelihood = -11304.822
Refining estimates:
Iteration 0:   log likelihood = -11304.822

Cox regression -- Breslow method for ties

No. of subjects =    2,398,961                  Number of obs    =   2,398,961
No. of failures =          771
Time at risk    =    246318109
                                                LR chi2(1)       =        9.52
Log likelihood  =   -11304.822                  Prob > chi2      =      0.0020

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   1.291717   .1049717     3.15   0.002     1.101524    1.514748
------------------------------------------------------------------------------------

. estimates save ./$tempdir/univar, replace 
file ./nsaid_tempdata_sens5/univar.ster saved

. 
. /* Multivariable models */ 
. 
. * Age and Gender 
. * Age fit as spline in first instance, categorical below 
. 
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -11309.583
Iteration 1:   log likelihood = -10727.476
Iteration 2:   log likelihood = -10420.092
Iteration 3:   log likelihood = -10419.212
Iteration 4:   log likelihood = -10419.173
Iteration 5:   log likelihood = -10419.173
Refining estimates:
Iteration 0:   log likelihood = -10419.173

Cox regression -- Breslow method for ties

No. of subjects =    2,398,961                  Number of obs    =   2,398,961
No. of failures =          771
Time at risk    =    246318109
                                                LR chi2(5)       =     1780.82
Log likelihood  =   -10419.173                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   1.109631   .0903876     1.28   0.202     .9458927    1.301713
            1.male |   2.119517   .1558379    10.22   0.000     1.835068    2.448058
              age1 |   1.176768   .0538473     3.56   0.000     1.075824    1.287185
              age2 |   .8448912   .0734055    -1.94   0.052      .712602    1.001739
              age3 |   1.754511   .4360883     2.26   0.024     1.077923    2.855778
------------------------------------------------------------------------------------

. estimates save ./$tempdir/multivar1, replace 
file ./nsaid_tempdata_sens5/multivar1.ster saved

. 
. * Age, Gender and Comorbidities (note: diabetes variable is diabcat) 
. stcox i.exposure i.male age1 age2 age3  i.obese4cat                                     ///
>                                                                                 i.smoke_nomiss                          ///
>                                                                                 i.imd                                           ///
>                                                                                 i.ckd                                           ///             
>                                                                                 i.hypertension                          ///             
>                                                                                 i.heart_failure                         ///             
>                                                                                 i.other_heart_disease           ///             
>                                                                                 i.diabcat                                       ///     
>                                                                                 i.copd                      ///
>                                                                                 i.other_respiratory         ///
>                                                                                 i.immunodef_any                         ///
>                                                                                 i.cancer                                ///     
>                                                                             i.rheumatoid                                ///     
>                                                                                 i.osteoarthritis                        ///     
>                                                                                 i.statin                                        ///     
>                                                                                 i.ppi                       ///
>                                                                                 i.steroid_prednisolone      ///
>                                                                                 i.hydroxychloroquine        ///
>                                                                                 i.dmards_primary_care       ///
>                                                                                 i.flu_vaccine                           ///     
>                                                                                 i.pneumococcal_vaccine , strata(stp)                            

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -8829.9453
Iteration 1:   log likelihood = -7955.7944
Iteration 2:   log likelihood =  -7729.144
Iteration 3:   log likelihood = -7712.1849
Iteration 4:   log likelihood = -7708.9236
Iteration 5:   log likelihood = -7708.4665
Iteration 6:   log likelihood = -7708.4534
Iteration 7:   log likelihood = -7708.4534
Refining estimates:
Iteration 0:   log likelihood = -7708.4534

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    2,398,961                  Number of obs    =   2,398,961
No. of failures =          771
Time at risk    =    246318109
                                                LR chi2(34)      =     2242.98
Log likelihood  =   -7708.4534                  Prob > chi2      =      0.0000

---------------------------------------------------------------------------------------------
                         _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
----------------------------+----------------------------------------------------------------
                   exposure |
         current NSAID use  |    .974079    .088821    -0.29   0.773     .8146624    1.164691
                     1.male |   2.160469   .1629106    10.22   0.000     1.863644    2.504569
                       age1 |   1.164732   .0532015     3.34   0.001      1.06499    1.273815
                       age2 |   .8591217   .0753607    -1.73   0.083     .7234171    1.020283
                       age3 |   1.648139   .4159161     1.98   0.048     1.005053    2.702706
                            |
                  obese4cat |
         Obese I (30-34.9)  |   1.094921   .1034746     0.96   0.337     .9097894    1.317726
        Obese II (35-39.9)  |   1.512316   .1949816     3.21   0.001     1.174621    1.947095
           Obese III (40+)  |   1.531968   .2881866     2.27   0.023      1.05956       2.215
                            |
               smoke_nomiss |
                    Former  |   1.025013   .0815784     0.31   0.756      .876969    1.198049
                   Current  |   .8348284   .1158935    -1.30   0.193     .6359614    1.095882
                            |
                        imd |
                         2  |   1.507391   .1757639     3.52   0.000     1.199429    1.894424
                         3  |   1.571063   .1890553     3.75   0.000     1.240976     1.98895
                         4  |   1.815154   .2227003     4.86   0.000     1.427184    2.308591
           5 most deprived  |   2.333318   .2958119     6.68   0.000     1.819956    2.991486
                            |
                        ckd |
                       CKD  |   1.485796   .1471017     4.00   0.000     1.223731    1.803984
             1.hypertension |   1.058649   .0844569     0.71   0.475     .9054087    1.237824
            1.heart_failure |   1.635429   .2953904     2.72   0.006     1.147858    2.330104
      1.other_heart_disease |   1.246241   .2239447     1.23   0.221     .8762831    1.772391
                            |
                    diabcat |
       Controlled diabetes  |   1.479462   .1485597     3.90   0.000     1.215152    1.801262
     Uncontrolled diabetes  |   2.330796   .3352804     5.88   0.000     1.758169    3.089925
Diabetes, no hba1c measure  |   .4280339    .429022    -0.85   0.397     .0600222    3.052423
                            |
                     1.copd |   1.330227   .1720738     2.21   0.027     1.032327    1.714093
        1.other_respiratory |   2.462774   .3453051     6.43   0.000     1.871017    3.241689
            1.immunodef_any |   2.371419   .7255989     2.82   0.005     1.301849    4.319725
                   1.cancer |   2.087905   .1804351     8.52   0.000     1.762588    2.473267
               1.rheumatoid |   1.140183   .2363415     0.63   0.527     .7595117     1.71165
           1.osteoarthritis |   .8696665    .067989    -1.79   0.074     .7461177    1.013674
                   1.statin |    .712798   .0625063    -3.86   0.000     .6002379     .846466
                      1.ppi |   1.422053   .1183276     4.23   0.000      1.20806    1.673954
     1.steroid_prednisolone |    1.54475   .2057406     3.27   0.001     1.189842    2.005521
       1.hydroxychloroquine |   1.438103   .4443101     1.18   0.240     .7848858    2.634957
      1.dmards_primary_care |   1.512989   .3457802     1.81   0.070     .9667208    2.367938
              1.flu_vaccine |   1.039722   .0933358     0.43   0.664     .8719771    1.239737
     1.pneumococcal_vaccine |   1.093569   .1193005     0.82   0.412     .8830518    1.354273
---------------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates save ./$tempdir/multivar2, replace 
file ./nsaid_tempdata_sens5/multivar2.ster saved

. 
. * Age, Gender and Comorbidities (note: changed diabetes category: grouped no HbA1c to uncontrolled DM after first run because diab causing the model not to converge)
. stcox i.exposure i.male age1 age2 age3  $varlist, strata(stp)                           

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -8829.9453
Iteration 1:   log likelihood = -7958.1054
Iteration 2:   log likelihood = -7731.7292
Iteration 3:   log likelihood = -7714.7682
Iteration 4:   log likelihood = -7711.4901
Iteration 5:   log likelihood = -7711.0289
Iteration 6:   log likelihood = -7711.0156
Iteration 7:   log likelihood = -7711.0156
Refining estimates:
Iteration 0:   log likelihood = -7711.0156

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    2,398,961                  Number of obs    =   2,398,961
No. of failures =          771
Time at risk    =    246318109
                                                LR chi2(33)      =     2237.86
Log likelihood  =   -7711.0156                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
    current NSAID use  |   .9728984   .0887337    -0.30   0.763     .8136417    1.163327
                1.male |   2.161807   .1629836    10.23   0.000     1.864845    2.506057
                  age1 |   1.165053     .05325     3.34   0.001     1.065223    1.274238
                  age2 |   .8587312   .0753679    -1.74   0.083     .7230198    1.019916
                  age3 |   1.649257   .4164003     1.98   0.048     1.005493    2.705188
                       |
             obese4cat |
    Obese I (30-34.9)  |   1.098682   .1037932     1.00   0.319     .9129744    1.322165
   Obese II (35-39.9)  |   1.520459   .1959592     3.25   0.001     1.181056    1.957397
      Obese III (40+)  |   1.541849   .2899464     2.30   0.021     1.066529    2.229006
                       |
          smoke_nomiss |
               Former  |   1.025885   .0816409     0.32   0.748     .8777264    1.199052
              Current  |   .8352616   .1159559    -1.30   0.195     .6362879    1.096456
                       |
                   imd |
                    2  |   1.510129   .1760889     3.53   0.000     1.201599    1.897879
                    3  |   1.572686   .1892399     3.76   0.000     1.242275    1.990977
                    4  |   1.818118   .2230701     4.87   0.000     1.429505    2.312376
      5 most deprived  |   2.337877   .2963773     6.70   0.000     1.823531    2.997299
                       |
                   ckd |
                  CKD  |   1.489985   .1475222     4.03   0.000     1.227171    1.809084
        1.hypertension |   1.058519   .0844748     0.71   0.476     .9052509    1.237738
       1.heart_failure |    1.64943   .2977137     2.77   0.006     1.157967    2.349478
 1.other_heart_disease |    1.23872   .2225856     1.19   0.234     .8710053    1.761674
                       |
          diab_control |
  Controlled diabetes  |   1.473481    .147942     3.86   0.000     1.210267    1.793939
Uncontrolled diabetes  |    2.15986   .3068309     5.42   0.000     1.634946    2.853302
                       |
                1.copd |   1.326643   .1716747     2.18   0.029     1.029447    1.709637
   1.other_respiratory |   2.462445   .3452746     6.43   0.000     1.870744    3.241297
       1.immunodef_any |   2.366388   .7239926     2.82   0.005     1.299158    4.310322
              1.cancer |   2.086647   .1803313     8.51   0.000     1.761517    2.471788
          1.rheumatoid |   1.141546   .2367524     0.64   0.523     .7602516    1.714073
      1.osteoarthritis |   .8696472   .0679868    -1.79   0.074     .7461022     1.01365
              1.statin |   .7185969   .0628974    -3.78   0.000     .6053149    .8530791
                 1.ppi |   1.423023   .1184506     4.24   0.000     1.208813    1.675193
1.steroid_prednisolone |    1.54414    .205757     3.26   0.001     1.189225    2.004978
  1.hydroxychloroquine |   1.432494   .4426142     1.16   0.245      .781785    2.624813
 1.dmards_primary_care |   1.511747   .3456601     1.81   0.071     .9657222    2.366496
         1.flu_vaccine |   1.044022   .0937545     0.48   0.631     .8755297    1.244941
1.pneumococcal_vaccine |   1.093646   .1193355     0.82   0.412     .8830723    1.354433
----------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates save ./$tempdir/multivar3, replace
file ./nsaid_tempdata_sens5/multivar3.ster saved

. 
. /* Print table================================================================*/ 
. *  Print the results for the main model 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table2.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 2: Association between current NSAID use and $tableoutcome - $population Population") _n

. file write tablecontent _tab ("Number of events") _tab ("Total person-weeks") _tab ("Rate per 1,000") _tab ("Univariable") _tab _tab ("Age/Sex Adjusted") _tab _tab ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _tab ///
>                                                 ("Age/Sex and Comorbidity (diabetes regroup)") _tab _tab _n

. file write tablecontent _tab _tab _tab _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ("95% CI") _n

. file write tablecontent ("Main Analysis") _n                                    

. 
. * Row headings 
. local lab0: label exposure 0

. local lab1: label exposure 1

.  
. /* Counts */
.  
. * First row, exposure = 0 (reference)
. 
.         safecount if exposure == 0 & $outcome == 1
  564

.         local event = r(N)

.     bysort exposure: egen total_follow_up = total(_t)

.         su total_follow_up if exposure == 0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |  1,879,001    1.92e+08           0   1.92e+08   1.92e+08

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         
.         file write tablecontent ("`lab0'") _tab

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

.         file write tablecontent ("1.00 (ref)") _tab _tab ("1.00 (ref)") _tab _tab ("1.00 (ref)") _n

.         
. * Second row, exposure = 1 (NSAID)
. 
. file write tablecontent ("`lab1'") _tab  

. 
.         safecount if exposure == 1 & $outcome == 1
  207

.         local event = r(N)

.         su total_follow_up if exposure == 1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    519,960    5.45e+07           0   5.45e+07   5.45e+07

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

. 
. /* Main Model */ 
. estimates use ./$tempdir/univar 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.291717   .1049717     3.15   0.002     1.101524    1.514748
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar1 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.109631   .0903876     1.28   0.202     .9458927    1.301713
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar2  

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |    .974079    .088821    -0.29   0.773     .8146624    1.164691
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar3

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .9728984   .0887337    -0.30   0.763     .8136417    1.163327
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _n 

. 
. file write tablecontent _n

. file close tablecontent

. 
. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\nsaid_log_sens5\06a_an_models_nsaid.log
  log type:  text
 closed on:  15 Jul 2020, 06:49:51
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
