----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\nsaid_log_sens5\08_an_model_checks.log
  log type:  text
 opened on:  15 Jul 2020, 06:49:51

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Quietly run models, perform test and store results in local macro==========*/
. 
. qui stcox i.exposure 

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |     -0.04331         1.45        1         0.2291
      ------------+---------------------------------------------------
      global test |                      1.45        1         0.2291
      ----------------------------------------------------------------

. local univar_p = round(r(p),0.001)

. di `univar_p'
.229

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Schoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, univariable", position(11) size(medsmall)) 

. 
. graph export "$outdir/schoenplot1.svg", as(svg) replace
(file nsaid_output_sens5/schoenplot1.svg written in SVG format)

. 
. * Close window 
. graph close  

.                           
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -11309.583
Iteration 1:   log likelihood = -10727.476
Iteration 2:   log likelihood = -10420.092
Iteration 3:   log likelihood = -10419.212
Iteration 4:   log likelihood = -10419.173
Iteration 5:   log likelihood = -10419.173
Refining estimates:
Iteration 0:   log likelihood = -10419.173

Cox regression -- Breslow method for ties

No. of subjects =    2,398,961                  Number of obs    =   2,398,961
No. of failures =          771
Time at risk    =    246318109
                                                LR chi2(5)       =     1780.82
Log likelihood  =   -10419.173                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   1.109631   .0903876     1.28   0.202     .9458927    1.301713
            1.male |   2.119517   .1558379    10.22   0.000     1.835068    2.448058
              age1 |   1.176768   .0538473     3.56   0.000     1.075824    1.287185
              age2 |   .8448912   .0734055    -1.94   0.052      .712602    1.001739
              age3 |   1.754511   .4360883     2.26   0.024     1.077923    2.855778
------------------------------------------------------------------------------------

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |     -0.03882         1.16        1         0.2808
      0b.male     |            .            .        1             .
      1.male      |     -0.10452         8.41        1         0.0037
      age1        |      0.00074         0.00        1         0.9841
      age2        |     -0.00981         0.07        1         0.7938
      age3        |      0.01680         0.20        1         0.6538
      ------------+---------------------------------------------------
      global test |                     19.81        5         0.0014
      ----------------------------------------------------------------

. local multivar1_p = round(r(phtest)[2,4],0.001)

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Schoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, age and sex adjusted", position(11) size(medsmall))                          

. 
. graph export "$outdir/schoenplot2.svg", as(svg) replace
(file nsaid_output_sens5/schoenplot2.svg written in SVG format)

. 
. * Close window 
. graph close

.                   
. stcox i.exposure i.male age1 age2 age3 $varlist, strata(stp)

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -8829.9453
Iteration 1:   log likelihood = -7958.1054
Iteration 2:   log likelihood = -7731.7292
Iteration 3:   log likelihood = -7714.7682
Iteration 4:   log likelihood = -7711.4901
Iteration 5:   log likelihood = -7711.0289
Iteration 6:   log likelihood = -7711.0156
Iteration 7:   log likelihood = -7711.0156
Refining estimates:
Iteration 0:   log likelihood = -7711.0156

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    2,398,961                  Number of obs    =   2,398,961
No. of failures =          771
Time at risk    =    246318109
                                                LR chi2(33)      =     2237.86
Log likelihood  =   -7711.0156                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
    current NSAID use  |   .9728984   .0887337    -0.30   0.763     .8136417    1.163327
                1.male |   2.161807   .1629836    10.23   0.000     1.864845    2.506057
                  age1 |   1.165053     .05325     3.34   0.001     1.065223    1.274238
                  age2 |   .8587312   .0753679    -1.74   0.083     .7230198    1.019916
                  age3 |   1.649257   .4164003     1.98   0.048     1.005493    2.705188
                       |
             obese4cat |
    Obese I (30-34.9)  |   1.098682   .1037932     1.00   0.319     .9129744    1.322165
   Obese II (35-39.9)  |   1.520459   .1959592     3.25   0.001     1.181056    1.957397
      Obese III (40+)  |   1.541849   .2899464     2.30   0.021     1.066529    2.229006
                       |
          smoke_nomiss |
               Former  |   1.025885   .0816409     0.32   0.748     .8777264    1.199052
              Current  |   .8352616   .1159559    -1.30   0.195     .6362879    1.096456
                       |
                   imd |
                    2  |   1.510129   .1760889     3.53   0.000     1.201599    1.897879
                    3  |   1.572686   .1892399     3.76   0.000     1.242275    1.990977
                    4  |   1.818118   .2230701     4.87   0.000     1.429505    2.312376
      5 most deprived  |   2.337877   .2963773     6.70   0.000     1.823531    2.997299
                       |
                   ckd |
                  CKD  |   1.489985   .1475222     4.03   0.000     1.227171    1.809084
        1.hypertension |   1.058519   .0844748     0.71   0.476     .9052509    1.237738
       1.heart_failure |    1.64943   .2977137     2.77   0.006     1.157967    2.349478
 1.other_heart_disease |    1.23872   .2225856     1.19   0.234     .8710053    1.761674
                       |
          diab_control |
  Controlled diabetes  |   1.473481    .147942     3.86   0.000     1.210267    1.793939
Uncontrolled diabetes  |    2.15986   .3068309     5.42   0.000     1.634946    2.853302
                       |
                1.copd |   1.326643   .1716747     2.18   0.029     1.029447    1.709637
   1.other_respiratory |   2.462445   .3452746     6.43   0.000     1.870744    3.241297
       1.immunodef_any |   2.366388   .7239926     2.82   0.005     1.299158    4.310322
              1.cancer |   2.086647   .1803313     8.51   0.000     1.761517    2.471788
          1.rheumatoid |   1.141546   .2367524     0.64   0.523     .7602516    1.714073
      1.osteoarthritis |   .8696472   .0679868    -1.79   0.074     .7461022     1.01365
              1.statin |   .7185969   .0628974    -3.78   0.000     .6053149    .8530791
                 1.ppi |   1.423023   .1184506     4.24   0.000     1.208813    1.675193
1.steroid_prednisolone |    1.54414    .205757     3.26   0.001     1.189225    2.004978
  1.hydroxychloroquine |   1.432494   .4426142     1.16   0.245      .781785    2.624813
 1.dmards_primary_care |   1.511747   .3456601     1.81   0.071     .9657222    2.366496
         1.flu_vaccine |   1.044022   .0937545     0.48   0.631     .8755297    1.244941
1.pneumococcal_vaccine |   1.093646   .1193355     0.82   0.412     .8830723    1.354433
----------------------------------------------------------------------------------------
                                                             Stratified by stp

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |     -0.05800         2.64        1         0.1040
      0b.male     |            .            .        1             .
      1.male      |     -0.09517         7.03        1         0.0080
      age1        |     -0.00055         0.00        1         0.9883
      age2        |     -0.00314         0.01        1         0.9329
      age3        |      0.00783         0.04        1         0.8330
      1b.obese4cat|            .            .        1             .
      2.obese4cat |     -0.04625         1.63        1         0.2016
      3.obese4cat |     -0.02663         0.56        1         0.4560
      4.obese4cat |     -0.01128         0.10        1         0.7539
      1b.smoke_n~s|            .            .        1             .
      2.smoke_no~s|     -0.04076         1.30        1         0.2534
      3.smoke_no~s|      0.07556         4.44        1         0.0352
      1b.imd      |            .            .        1             .
      2.imd       |      0.01753         0.24        1         0.6270
      3.imd       |      0.01235         0.12        1         0.7340
      4.imd       |      0.01482         0.17        1         0.6797
      5.imd       |     -0.00233         0.00        1         0.9483
      0b.ckd      |            .            .        1             .
      1.ckd       |     -0.00020         0.00        1         0.9954
      0b.hyperte~n|            .            .        1             .
      1.hyperten~n|     -0.00753         0.04        1         0.8335
      0b.heart_~re|            .            .        1             .
      1.heart_f~re|     -0.05836         2.71        1         0.0996
      0b.other_~se|            .            .        1             .
      1.other_h~se|     -0.02506         0.48        1         0.4872
      1b.diab_co~l|            .            .        1             .
      2.diab_con~l|     -0.00845         0.06        1         0.8142
      3.diab_con~l|     -0.02514         0.47        1         0.4919
      0b.copd     |            .            .        1             .
      1.copd      |     -0.02103         0.34        1         0.5580
      0b.other_r~y|            .            .        1             .
      1.other_re~y|     -0.01675         0.22        1         0.6394
      0b.immunod~y|            .            .        1             .
      1.immunode~y|     -0.01009         0.08        1         0.7792
      0b.cancer   |            .            .        1             .
      1.cancer    |      0.06236         3.34        1         0.0675
      0b.rheumat~d|            .            .        1             .
      1.rheumatoid|     -0.01224         0.13        1         0.7190
      0b.osteoar~s|            .            .        1             .
      1.osteoart~s|     -0.01346         0.14        1         0.7062
      0b.statin   |            .            .        1             .
      1.statin    |     -0.12774        12.27        1         0.0005
      0b.ppi      |            .            .        1             .
      1.ppi       |      0.04375         1.59        1         0.2079
      0b.steroi~ne|            .            .        1             .
      1.steroid~ne|     -0.04311         1.49        1         0.2219
      0b.hydrox~ne|            .            .        1             .
      1.hydroxy~ne|     -0.04347         1.59        1         0.2077
      0b.dmards~re|            .            .        1             .
      1.dmards_~re|      0.02997         0.85        1         0.3567
      0b.flu_vac~e|            .            .        1             .
      1.flu_vacc~e|      0.04802         1.92        1         0.1657
      0b.pneumoc~e|            .            .        1             .
      1.pneumoco~e|     -0.03339         0.87        1         0.3520
      ------------+---------------------------------------------------
      global test |                     66.83       33         0.0004
      ----------------------------------------------------------------

. local multivar2_p = round(r(phtest)[2,4],0.001)

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Schoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, fully adjusted", position(11) size(medsmall))                

.                           
. graph export "$outdir/schoenplot3.svg", as(svg) replace
(file nsaid_output_sens5/schoenplot3.svg written in SVG format)

. 
. * Close window 
. graph close

. 
. * Print table of results======================================================*/        
. 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table4.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 4: Testing the PH assumption - $population Population") _n

. file write tablecontent _tab ("Univariable") _tab ("Age/Sex Adjusted") _tab ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _n

.                                                 
. file write tablecontent _tab ("p-value") _tab ("p-value") _tab ("p-value") _tab _n

. 
. * Row heading and content  
. file write tablecontent ("Treatment Exposure") _tab

. file write tablecontent ("`univar_p'") _tab ("`multivar1_p'") _tab ("`multivar2_p'")

. 
. file write tablecontent _n

. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\nsaid_log_sens5\08_an_model_checks.log
  log type:  text
 closed on:  15 Jul 2020, 07:14:02
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
