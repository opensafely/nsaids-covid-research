----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\nsaid_log_sens4\06a_an_models_nsaid.log
  log type:  text
 opened on:  15 Jul 2020, 05:17:14

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Sense check outcomes=======================================================*/ 
. 
. safetab exposure $outcome, missing row
23

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use | 1,923,484        611 | 1,924,095 
                      |     99.97       0.03 |    100.00 
----------------------+----------------------+----------
    current NSAID use |   530,177        215 |   530,392 
                      |     99.96       0.04 |    100.00 
----------------------+----------------------+----------
                Total | 2,453,661        826 | 2,454,487 
                      |     99.97       0.03 |    100.00 

. 
. /* Main Model=================================================================*/
. 
. /* Univariable model */ 
. 
. stcox i.exposure 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -12135.027
Iteration 1:   log likelihood = -12131.413
Iteration 2:   log likelihood = -12131.399
Iteration 3:   log likelihood = -12131.399
Refining estimates:
Iteration 0:   log likelihood = -12131.399

Cox regression -- Breslow method for ties

No. of subjects =    2,454,487                  Number of obs    =   2,454,487
No. of failures =          826
Time at risk    =    251986285
                                                LR chi2(1)       =        7.26
Log likelihood  =   -12131.399                  Prob > chi2      =      0.0071

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |    1.24291   .0985582     2.74   0.006     1.064002      1.4519
------------------------------------------------------------------------------------

. estimates save ./$tempdir/univar, replace 
file ./nsaid_tempdata_sens4/univar.ster saved

. 
. /* Multivariable models */ 
. 
. * Age and Gender 
. * Age fit as spline in first instance, categorical below 
. 
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -12135.027
Iteration 1:   log likelihood =   -11470.5
Iteration 2:   log likelihood = -11185.077
Iteration 3:   log likelihood =  -11183.51
Iteration 4:   log likelihood = -11183.401
Iteration 5:   log likelihood =   -11183.4
Iteration 6:   log likelihood =   -11183.4
Refining estimates:
Iteration 0:   log likelihood =   -11183.4

Cox regression -- Breslow method for ties

No. of subjects =    2,454,487                  Number of obs    =   2,454,487
No. of failures =          826
Time at risk    =    251986285
                                                LR chi2(5)       =     1903.25
Log likelihood  =     -11183.4                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   1.084484   .0862034     1.02   0.308     .9280315    1.267311
            1.male |   2.113775   .1500591    10.54   0.000     1.839209     2.42933
              age1 |    1.17327   .0530815     3.53   0.000     1.073711     1.28206
              age2 |   .8521275   .0731166    -1.86   0.062     .7202238    1.008188
              age3 |    1.70184   .4173087     2.17   0.030     1.052435     2.75196
------------------------------------------------------------------------------------

. estimates save ./$tempdir/multivar1, replace 
file ./nsaid_tempdata_sens4/multivar1.ster saved

. 
. * Age, Gender and Comorbidities (note: diabetes variable is diabcat) 
. stcox i.exposure i.male age1 age2 age3  i.obese4cat                                     ///
>                                                                                 i.smoke_nomiss                          ///
>                                                                                 i.imd                                           ///
>                                                                                 i.ckd                                           ///             
>                                                                                 i.hypertension                          ///             
>                                                                                 i.heart_failure                         ///             
>                                                                                 i.other_heart_disease           ///             
>                                                                                 i.diabcat                                       ///     
>                                                                                 i.copd                      ///
>                                                                                 i.other_respiratory         ///
>                                                                                 i.immunodef_any                         ///
>                                                                                 i.cancer                                ///     
>                                                                             i.rheumatoid                                ///     
>                                                                                 i.osteoarthritis                        ///     
>                                                                                 i.statin                                        ///     
>                                                                                 i.ppi                       ///
>                                                                                 i.steroid_prednisolone      ///
>                                                                                 i.hydroxychloroquine        ///
>                                                                                 i.dmards_primary_care       ///
>                                                                                 i.flu_vaccine                           ///     
>                                                                                 i.pneumococcal_vaccine , strata(stp)                            

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -9477.8599
Iteration 1:   log likelihood = -8550.2481
Iteration 2:   log likelihood =  -8303.469
Iteration 3:   log likelihood = -8284.6424
Iteration 4:   log likelihood = -8281.1011
Iteration 5:   log likelihood = -8280.5845
Iteration 6:   log likelihood = -8280.5682
Iteration 7:   log likelihood = -8280.5682
Refining estimates:
Iteration 0:   log likelihood = -8280.5682

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    2,454,487                  Number of obs    =   2,454,487
No. of failures =          826
Time at risk    =    251986285
                                                LR chi2(34)      =     2394.58
Log likelihood  =   -8280.5682                  Prob > chi2      =      0.0000

---------------------------------------------------------------------------------------------
                         _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
----------------------------+----------------------------------------------------------------
                   exposure |
         current NSAID use  |   .9529416   .0845116    -0.54   0.587     .8008985    1.133849
                     1.male |   2.157358   .1571768    10.55   0.000     1.870282    2.488499
                       age1 |   1.157899   .0520103     3.26   0.001     1.060319    1.264459
                       age2 |   .8742184   .0753999    -1.56   0.119      .738253    1.035225
                       age3 |   1.556239   .3859657     1.78   0.075     .9571241    2.530372
                            |
                  obese4cat |
         Obese I (30-34.9)  |   1.099635   .1004445     1.04   0.298     .9193837    1.315225
        Obese II (35-39.9)  |   1.558175   .1925416     3.59   0.000     1.223023    1.985172
           Obese III (40+)  |   1.631562   .2904313     2.75   0.006      1.15102    2.312727
                            |
               smoke_nomiss |
                    Former  |   1.038131   .0797889     0.49   0.626     .8929565    1.206907
                   Current  |   .8123077   .1113954    -1.52   0.130     .6208569    1.062795
                            |
                        imd |
                         2  |   1.496221    .168386     3.58   0.000     1.200054    1.865481
                         3  |   1.531557   .1785078     3.66   0.000     1.218774    1.924613
                         4  |   1.831352   .2164499     5.12   0.000     1.452671    2.308748
           5 most deprived  |   2.369851   .2890452     7.07   0.000     1.865959    3.009817
                            |
                        ckd |
                       CKD  |   1.422085   .1351302     3.71   0.000     1.180435    1.713204
             1.hypertension |   1.046371   .0808706     0.59   0.558     .8992888     1.21751
            1.heart_failure |   1.622563    .272705     2.88   0.004     1.167185    2.255607
      1.other_heart_disease |   1.134147   .1888239     0.76   0.450     .8183763    1.571758
                            |
                    diabcat |
       Controlled diabetes  |   1.455871   .1404565     3.89   0.000     1.205043    1.758909
     Uncontrolled diabetes  |   2.400551   .3218904     6.53   0.000     1.845751    3.122114
Diabetes, no hba1c measure  |   .4143049    .415152    -0.88   0.379      .058127    2.952991
                            |
                     1.copd |    1.32094   .1637298     2.25   0.025     1.036041    1.684182
        1.other_respiratory |   2.405982   .3237358     6.52   0.000     1.848244    3.132027
            1.immunodef_any |   2.451851   .7185852     3.06   0.002     1.380464    4.354749
                   1.cancer |   1.996525   .1670045     8.27   0.000     1.694625    2.352207
               1.rheumatoid |   1.248492   .2424771     1.14   0.253      .853235    1.826849
           1.osteoarthritis |   .8587101   .0648366    -2.02   0.044     .7405885    .9956718
                   1.statin |   .6789226   .0573985    -4.58   0.000     .5752501     .801279
                      1.ppi |   1.420149   .1136851     4.38   0.000     1.213931    1.661399
     1.steroid_prednisolone |   1.517254   .1939398     3.26   0.001     1.181014    1.949222
       1.hydroxychloroquine |   1.289263   .3939471     0.83   0.406     .7083508    2.346576
      1.dmards_primary_care |    1.54377   .3350333     2.00   0.045      1.00891    2.362179
              1.flu_vaccine |   1.037594   .0901824     0.42   0.671     .8750753    1.230296
     1.pneumococcal_vaccine |   1.048169   .1130741     0.44   0.663     .8484092    1.294961
---------------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates save ./$tempdir/multivar2, replace 
file ./nsaid_tempdata_sens4/multivar2.ster saved

. 
. * Age, Gender and Comorbidities (note: changed diabetes category: grouped no HbA1c to uncontrolled DM after first run because diab causing the model not to converge)
. stcox i.exposure i.male age1 age2 age3  $varlist, strata(stp)                           

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -9477.8599
Iteration 1:   log likelihood = -8553.0022
Iteration 2:   log likelihood = -8306.3549
Iteration 3:   log likelihood = -8287.5107
Iteration 4:   log likelihood = -8283.9527
Iteration 5:   log likelihood = -8283.4318
Iteration 6:   log likelihood = -8283.4152
Iteration 7:   log likelihood = -8283.4152
Refining estimates:
Iteration 0:   log likelihood = -8283.4152

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    2,454,487                  Number of obs    =   2,454,487
No. of failures =          826
Time at risk    =    251986285
                                                LR chi2(33)      =     2388.89
Log likelihood  =   -8283.4152                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
    current NSAID use  |   .9514555   .0843969    -0.56   0.575     .7996214     1.13212
                1.male |   2.159058   .1572758    10.57   0.000     1.871798    2.490404
                  age1 |   1.158189   .0520547     3.27   0.001     1.060529    1.264843
                  age2 |   .8738605   .0754083    -1.56   0.118     .7378856    1.034892
                  age3 |   1.557124    .386362     1.78   0.074     .9574555    2.532374
                       |
             obese4cat |
    Obese I (30-34.9)  |   1.103412   .1007566     1.08   0.281     .9225952    1.319666
   Obese II (35-39.9)  |   1.566474   .1934997     3.63   0.000      1.22964    1.995577
      Obese III (40+)  |   1.642136   .2922134     2.79   0.005     1.158617    2.327437
                       |
          smoke_nomiss |
               Former  |   1.038875   .0798381     0.50   0.620     .8936101    1.207755
              Current  |   .8128741   .1114739    -1.51   0.131     .6212886    1.063538
                       |
                   imd |
                    2  |   1.497792   .1685668     3.59   0.000     1.201308    1.867449
                    3  |   1.532453   .1786029     3.66   0.000     1.219501    1.925716
                    4  |   1.833026    .216647     5.13   0.000        1.454    2.310857
      5 most deprived  |    2.37349   .2894874     7.09   0.000     1.868826    3.014434
                       |
                   ckd |
                  CKD  |   1.426018   .1354991     3.73   0.000     1.183708     1.71793
        1.hypertension |   1.046953   .0809304     0.59   0.553     .8997636     1.21822
       1.heart_failure |   1.634844   .2746201     2.93   0.003     1.176229    2.272274
 1.other_heart_disease |   1.128804   .1879264     0.73   0.467     .8145322    1.564332
                       |
          diab_control |
  Controlled diabetes  |   1.449814   .1398527     3.85   0.000     1.200061    1.751545
Uncontrolled diabetes  |   2.235325   .2962865     6.07   0.000     1.723917    2.898446
                       |
                1.copd |   1.317903   .1634068     2.23   0.026     1.033577    1.680443
   1.other_respiratory |   2.407013   .3239015     6.53   0.000     1.848996    3.133438
       1.immunodef_any |   2.447617   .7172707     3.05   0.002     1.378161    4.346972
              1.cancer |   1.995908   .1669566     8.26   0.000     1.694096     2.35149
          1.rheumatoid |   1.250117    .242936     1.15   0.251     .8541538    1.829638
      1.osteoarthritis |   .8586162   .0648292    -2.02   0.044     .7405079    .9955624
              1.statin |   .6845522   .0577677    -4.49   0.000     .5801973    .8076764
                 1.ppi |     1.4213   .1138156     4.39   0.000     1.214851    1.662834
1.steroid_prednisolone |   1.516551   .1939135     3.26   0.001      1.18037    1.948479
  1.hydroxychloroquine |   1.283781   .3923077     0.82   0.414     .7053009    2.336726
 1.dmards_primary_care |    1.54208   .3348295     1.99   0.046     1.007597    2.360082
         1.flu_vaccine |   1.041885   .0905823     0.47   0.637     .8786493    1.235446
1.pneumococcal_vaccine |   1.047716   .1130405     0.43   0.666      .848019    1.294439
----------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates save ./$tempdir/multivar3, replace
file ./nsaid_tempdata_sens4/multivar3.ster saved

. 
. /* Print table================================================================*/ 
. *  Print the results for the main model 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table2.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 2: Association between current NSAID use and $tableoutcome - $population Population") _n

. file write tablecontent _tab ("Number of events") _tab ("Total person-weeks") _tab ("Rate per 1,000") _tab ("Univariable") _tab _tab ("Age/Sex Adjusted") _tab _tab ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _tab ///
>                                                 ("Age/Sex and Comorbidity (diabetes regroup)") _tab _tab _n

. file write tablecontent _tab _tab _tab _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ("95% CI") _n

. file write tablecontent ("Main Analysis") _n                                    

. 
. * Row headings 
. local lab0: label exposure 0

. local lab1: label exposure 1

.  
. /* Counts */
.  
. * First row, exposure = 0 (reference)
. 
.         safecount if exposure == 0 & $outcome == 1
  611

.         local event = r(N)

.     bysort exposure: egen total_follow_up = total(_t)

.         su total_follow_up if exposure == 0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |  1,924,095    1.96e+08           0   1.96e+08   1.96e+08

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         
.         file write tablecontent ("`lab0'") _tab

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

.         file write tablecontent ("1.00 (ref)") _tab _tab ("1.00 (ref)") _tab _tab ("1.00 (ref)") _n

.         
. * Second row, exposure = 1 (NSAID)
. 
. file write tablecontent ("`lab1'") _tab  

. 
.         safecount if exposure == 1 & $outcome == 1
  215

.         local event = r(N)

.         su total_follow_up if exposure == 1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    530,392    5.56e+07           0   5.56e+07   5.56e+07

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

. 
. /* Main Model */ 
. estimates use ./$tempdir/univar 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |    1.24291   .0985582     2.74   0.006     1.064002      1.4519
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar1 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.084484   .0862034     1.02   0.308     .9280315    1.267311
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar2  

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .9529416   .0845116    -0.54   0.587     .8008985    1.133849
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. 
. estimates use ./$tempdir/multivar3

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .9514555   .0843969    -0.56   0.575     .7996214     1.13212
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _n 

. 
. file write tablecontent _n

. file close tablecontent

. 
. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\nsaid_log_sens4\06a_an_models_nsaid.log
  log type:  text
 closed on:  15 Jul 2020, 05:30:18
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
