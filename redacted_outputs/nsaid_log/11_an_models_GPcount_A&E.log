----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\nsaid_log\11_an_models_GPcount_A&E.log
  log type:  text
 opened on:  14 Jul 2020, 23:06:03

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Sense check outcomes=======================================================*/ 
. 
. safetab exposure $outcome, missing row
23

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use | 1,923,484        611 | 1,924,095 
                      |     99.97       0.03 |    100.00 
----------------------+----------------------+----------
    current NSAID use |   535,301        218 |   535,519 
                      |     99.96       0.04 |    100.00 
----------------------+----------------------+----------
                Total | 2,458,785        829 | 2,459,614 
                      |     99.97       0.03 |    100.00 

. 
. /* Main Model=================================================================*/
. 
. * Age, Gender and Comorbidities 
. stcox i.exposure i.male age1 age2 age3  $varlist                 ///
>                                                                                 i.gp_consult             ///
>                                                                                 i.aande_attendance_last_year, strata(stp)               

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -9513.8021
Iteration 1:   log likelihood = -8551.9008
Iteration 2:   log likelihood = -8277.1017
Iteration 3:   log likelihood = -8257.6729
Iteration 4:   log likelihood = -8254.1245
Iteration 5:   log likelihood = -8253.6103
Iteration 6:   log likelihood = -8253.5942
Iteration 7:   log likelihood = -8253.5942
Refining estimates:
Iteration 0:   log likelihood = -8253.5942

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    2,459,614                  Number of obs    =   2,459,614
No. of failures =          829
Time at risk    =    252524169
                                                LR chi2(35)      =     2520.42
Log likelihood  =   -8253.5942                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------------
                          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------------+----------------------------------------------------------------
                    exposure |
          current NSAID use  |   .9734038    .085794    -0.31   0.760     .8189732    1.156955
                      1.male |   2.184575   .1590291    10.73   0.000     1.894099    2.519599
                        age1 |   1.158928   .0514937     3.32   0.001     1.062271    1.264378
                        age2 |   .8833171   .0754753    -1.45   0.146     .7471117    1.044354
                        age3 |   1.479503   .3638806     1.59   0.111      .913618    2.395891
                             |
                   obese4cat |
          Obese I (30-34.9)  |    1.10414   .1007832     1.09   0.278     .9232695    1.320443
         Obese II (35-39.9)  |   1.556492   .1922035     3.58   0.000     1.221902    1.982703
            Obese III (40+)  |   1.623087   .2885754     2.72   0.006     1.145522     2.29975
                             |
                smoke_nomiss |
                     Former  |   1.047684   .0803648     0.61   0.544     .9014409    1.217653
                    Current  |   .7960844   .1092656    -1.66   0.097     .6083149    1.041813
                             |
                         imd |
                          2  |   1.494454   .1679936     3.57   0.000     1.198941    1.862804
                          3  |   1.511383   .1759053     3.55   0.000     1.203111    1.898643
                          4  |   1.787077   .2109529     4.92   0.000     1.417962    2.252279
            5 most deprived  |   2.274815   .2771486     6.75   0.000     1.791601    2.888358
                             |
                         ckd |
                        CKD  |   1.415995   .1340969     3.67   0.000     1.176119    1.704793
              1.hypertension |   1.040649   .0802686     0.52   0.605     .8946397    1.210487
             1.heart_failure |   1.449806   .2442204     2.20   0.027     1.042137     2.01695
       1.other_heart_disease |   1.088943   .1811505     0.51   0.609     .7859667    1.508712
                             |
                diab_control |
        Controlled diabetes  |   1.443193   .1386102     3.82   0.000     1.195561    1.742117
      Uncontrolled diabetes  |   2.178508   .2887976     5.87   0.000     1.680035    2.824881
                             |
                      1.copd |   1.268174   .1571471     1.92   0.055     .9947212      1.6168
         1.other_respiratory |   2.280857    .306473     6.14   0.000     1.752767    2.968054
             1.immunodef_any |   2.325438   .6815202     2.88   0.004     1.309307    4.130169
                    1.cancer |   1.914741    .160076     7.77   0.000     1.625354    2.255652
                1.rheumatoid |   1.224828   .2351698     1.06   0.291      .840703    1.784464
            1.osteoarthritis |   .8378395   .0632363    -2.34   0.019     .7226301    .9714168
                    1.statin |   .6957184   .0587007    -4.30   0.000     .5896768    .8208295
                       1.ppi |   1.358369   .1085794     3.83   0.000      1.16139    1.588756
      1.steroid_prednisolone |   1.392045   .1783733     2.58   0.010     1.082885    1.789469
        1.hydroxychloroquine |   1.439777   .4263899     1.23   0.218     .8057719    2.572637
       1.dmards_primary_care |   1.582776   .3380948     2.15   0.032     1.041346    2.405711
               1.flu_vaccine |    1.06873   .0931931     0.76   0.446     .9008313    1.267922
      1.pneumococcal_vaccine |   1.056161   .1134839     0.51   0.611     .8555962     1.30374
                1.gp_consult |   .8397123   .1517146    -0.97   0.334      .589305    1.196523
1.aande_attendance_last_year |   2.352179   .1741434    11.55   0.000     2.034472      2.7195
----------------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates save ./$tempdir/multivar_gp_ae, replace 
file ./nsaid_tempdata/multivar_gp_ae.ster saved

. 
. /* Print table================================================================*/ 
. *  Print the results for the main model 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table7.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 7: Association between current NSAID use and death - $population Population, additionally adjusted for GP count and A&E count") _n

. file write tablecontent _tab ("Number of events") _tab ("Total person-weeks") _tab ("Rate per 1,000") _tab ("Univariable") _tab _tab ("Age/Sex Adjusted") _tab _tab ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _tab _n

. file write tablecontent _tab _tab _tab _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("HR") _tab ("95% CI") _n

. file write tablecontent ("Sensitivity Analysis") _n                                     

. 
. * Row headings 
. local lab0: label exposure 0

. local lab1: label exposure 1

.  
. * First row, exposure = 0 (reference)
. 
.         safecount if exposure == 0 & $outcome == 1
  611

.         local event = r(N)

.     bysort exposure: egen total_follow_up = total(_t)

.         su total_follow_up if exposure == 0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |  1,924,095    1.96e+08           0   1.96e+08   1.96e+08

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         
.         file write tablecontent ("`lab0'") _tab

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

.         file write tablecontent ("1.00 (ref)") _tab _tab ("1.00 (ref)") _tab _tab ("1.00 (ref)") _n

.         
. * Second row, exposure = 1 (NSAID)
. 
. file write tablecontent ("`lab1'") _tab  

. 
.         safecount if exposure == 1 & $outcome == 1
  218

.         local event = r(N)

.         su total_follow_up if exposure == 1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    535,519    5.62e+07           0   5.62e+07   5.62e+07

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

. 
. /* Main Model */ 
. estimates use ./$tempdir/multivar_gp_ae

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .9734038    .085794    -0.31   0.760     .8189732    1.156955
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _n 

. 
. 
. file write tablecontent _n

. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\nsaid_log\11_an_models_GPcount_A&E.log
  log type:  text
 closed on:  14 Jul 2020, 23:12:23
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
