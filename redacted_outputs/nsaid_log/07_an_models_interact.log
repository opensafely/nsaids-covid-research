----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\nsaid_log\07_an_models_interact.log
  log type:  text
 opened on:  14 Jul 2020, 21:46:50

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Age Interaction============================================================*/ 
. 
. /* Check Counts */ 
. 
. bysort age70: tab exposure $outcome, row

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> age70 = 0

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use | 1,699,841        224 | 1,700,065 
                      |     99.99       0.01 |    100.00 
----------------------+----------------------+----------
    current NSAID use |   457,238         96 |   457,334 
                      |     99.98       0.02 |    100.00 
----------------------+----------------------+----------
                Total | 2,157,079        320 | 2,157,399 
                      |     99.99       0.01 |    100.00 

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> age70 = 1

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
      NSAID Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
non-current NSAID use |   223,643        387 |   224,030 
                      |     99.83       0.17 |    100.00 
----------------------+----------------------+----------
    current NSAID use |    78,063        122 |    78,185 
                      |     99.84       0.16 |    100.00 
----------------------+----------------------+----------
                Total |   301,706        509 |   302,215 
                      |     99.83       0.17 |    100.00 


. 
. /* Univariable model */ 
. 
. stcox i.exposure i.age70

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -12180.875
Iteration 1:   log likelihood = -11962.018
Iteration 2:   log likelihood = -11633.589
Iteration 3:   log likelihood = -11622.547
Iteration 4:   log likelihood = -11622.543
Refining estimates:
Iteration 0:   log likelihood = -11622.543

Cox regression -- Breslow method for ties

No. of subjects =    2,459,614                  Number of obs    =   2,459,614
No. of failures =          829
Time at risk    =    252524169
                                                LR chi2(2)       =     1116.66
Log likelihood  =   -11622.543                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   1.095403   .0865502     1.15   0.249     .9382501    1.278878
           1.age70 |   11.34418   .8105495    33.99   0.000     9.861758    13.04945
------------------------------------------------------------------------------------

. estimates store A

. 
. stcox i.exposure##i.age70

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -12180.875
Iteration 1:   log likelihood = -11976.051
Iteration 2:   log likelihood = -11646.156
Iteration 3:   log likelihood = -11617.257
Iteration 4:   log likelihood = -11616.321
Iteration 5:   log likelihood =  -11616.32
Refining estimates:
Iteration 0:   log likelihood =  -11616.32

Cox regression -- Breslow method for ties

No. of subjects =    2,459,614                  Number of obs    =   2,459,614
No. of failures =          829
Time at risk    =    252524169
                                                LR chi2(3)       =     1129.11
Log likelihood  =    -11616.32                  Prob > chi2      =      0.0000

--------------------------------------------------------------------------------------
                  _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
---------------------+----------------------------------------------------------------
            exposure |
  current NSAID use  |   1.551322   .1892424     3.60   0.000     1.221422    1.970327
             1.age70 |   13.17864   1.106399    30.71   0.000     11.17915    15.53576
                     |
      exposure#age70 |
current NSAID use#1  |   .5660907   .0906835    -3.55   0.000     .4135518    .7748938
--------------------------------------------------------------------------------------

. estimates store B

. estimates save ./$tempdir/univar_int, replace 
file ./nsaid_tempdata/univar_int.ster saved

. 
. lrtest A B

Likelihood-ratio test                                 LR chi2(1)  =     12.44
(Assumption: A nested in B)                           Prob > chi2 =    0.0004

. local univar_p = round(r(p),0.001)

. 
. /* Multivariable models */ 
. 
. * Age and Gender 
. 
. stcox i.exposure i.age70 i.male

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -12180.875
Iteration 1:   log likelihood = -11913.392
Iteration 2:   log likelihood = -11584.938
Iteration 3:   log likelihood = -11573.884
Iteration 4:   log likelihood =  -11573.88
Refining estimates:
Iteration 0:   log likelihood =  -11573.88

Cox regression -- Breslow method for ties

No. of subjects =    2,459,614                  Number of obs    =   2,459,614
No. of failures =          829
Time at risk    =    252524169
                                                LR chi2(3)       =     1213.99
Log likelihood  =    -11573.88                  Prob > chi2      =      0.0000

------------------------------------------------------------------------------------
                _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
          exposure |
current NSAID use  |   1.104109   .0872605     1.25   0.210     .9456696    1.289094
           1.age70 |   11.56329   .8266719    34.24   0.000     10.05143    13.30254
            1.male |   1.991401   .1403747     9.77   0.000     1.734432    2.286443
------------------------------------------------------------------------------------

. estimates store A

. 
. stcox i.exposure##i.age70 i.male

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -12180.875
Iteration 1:   log likelihood = -11926.932
Iteration 2:   log likelihood = -11597.083
Iteration 3:   log likelihood = -11568.208
Iteration 4:   log likelihood = -11567.273
Iteration 5:   log likelihood = -11567.272
Refining estimates:
Iteration 0:   log likelihood = -11567.272

Cox regression -- Breslow method for ties

No. of subjects =    2,459,614                  Number of obs    =   2,459,614
No. of failures =          829
Time at risk    =    252524169
                                                LR chi2(4)       =     1227.21
Log likelihood  =   -11567.272                  Prob > chi2      =      0.0000

--------------------------------------------------------------------------------------
                  _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
---------------------+----------------------------------------------------------------
            exposure |
  current NSAID use  |   1.581517   .1929496     3.76   0.000     1.245159    2.008736
             1.age70 |   13.49324   1.133254    30.98   0.000     11.44528    15.90764
                     |
      exposure#age70 |
current NSAID use#1  |   .5562297   .0891091    -3.66   0.000     .4063403    .7614096
                     |
              1.male |   1.996866    .140763     9.81   0.000     1.739186    2.292724
--------------------------------------------------------------------------------------

. estimates store B

. estimates save ./$tempdir/multivar1_int, replace 
file ./nsaid_tempdata/multivar1_int.ster saved

. 
. lrtest A B

Likelihood-ratio test                                 LR chi2(1)  =     13.22
(Assumption: A nested in B)                           Prob > chi2 =    0.0003

. local multivar1_p = round(r(p),0.001)

. 
. * Age, Gender and Comorbidities 
. stcox i.exposure i.age70 i.male $varlist, strata(stp)           

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -9513.8021
Iteration 1:   log likelihood = -8783.6567
Iteration 2:   log likelihood = -8571.0417
Iteration 3:   log likelihood = -8567.0834
Iteration 4:   log likelihood = -8567.0818
Refining estimates:
Iteration 0:   log likelihood = -8567.0818

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    2,459,614                  Number of obs    =   2,459,614
No. of failures =          829
Time at risk    =    252524169
                                                LR chi2(31)      =     1893.44
Log likelihood  =   -8567.0818                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
    current NSAID use  |   .8990751   .0788239    -1.21   0.225     .7571279    1.067635
               1.age70 |   5.157119    .506401    16.71   0.000     4.254258     6.25159
                1.male |   2.110637   .1527245    10.32   0.000      1.83156    2.432238
                       |
             obese4cat |
    Obese I (30-34.9)  |   .9634617    .087272    -0.41   0.681     .8067354    1.150635
   Obese II (35-39.9)  |   1.240034   .1515966     1.76   0.078      .975826    1.575776
      Obese III (40+)  |   1.152311   .2031894     0.80   0.421     .8155971    1.628036
                       |
          smoke_nomiss |
               Former  |   1.087879   .0841128     1.09   0.276     .9349044    1.265884
              Current  |   .6622996   .0898374    -3.04   0.002     .5076841    .8640034
                       |
                   imd |
                    2  |   1.468191    .165019     3.42   0.001     1.177907    1.830014
                    3  |   1.468284   .1711307     3.30   0.001     1.168426    1.845096
                    4  |   1.674456   .1980398     4.36   0.000      1.32801    2.111283
      5 most deprived  |     2.0419   .2496889     5.84   0.000     1.606747    2.594906
                       |
                   ckd |
                  CKD  |   2.077471   .1930948     7.87   0.000     1.731484    2.492595
        1.hypertension |   1.369638   .1094657     3.94   0.000     1.171049    1.601904
       1.heart_failure |   2.017381   .3394626     4.17   0.000     1.450631    2.805554
 1.other_heart_disease |    1.16235    .194525     0.90   0.369     .8373061    1.613577
                       |
          diab_control |
  Controlled diabetes  |   1.565079   .1515596     4.63   0.000     1.294515    1.892192
Uncontrolled diabetes  |   2.209409   .2941718     5.95   0.000     1.701935      2.8682
                       |
                1.copd |   1.397616   .1746993     2.68   0.007     1.093929    1.785609
   1.other_respiratory |   2.589445   .3499649     7.04   0.000     1.986855    3.374792
       1.immunodef_any |   2.125065   .6227124     2.57   0.010     1.196582    3.773998
              1.cancer |    2.34652   .1986768    10.07   0.000     1.987715    2.770093
          1.rheumatoid |   1.309961    .250959     1.41   0.159     .8998856    1.906906
      1.osteoarthritis |   1.167228   .0912056     1.98   0.048     1.001484    1.360402
              1.statin |   .6491086   .0556653    -5.04   0.000     .5486827    .7679156
                 1.ppi |   1.553663   .1260448     5.43   0.000     1.325259     1.82143
1.steroid_prednisolone |   1.528286   .1971534     3.29   0.001     1.186854    1.967942
  1.hydroxychloroquine |   1.256794   .3708093     0.77   0.439     .7048914    2.240814
 1.dmards_primary_care |   1.451433   .3082156     1.75   0.079     .9572872    2.200655
         1.flu_vaccine |   1.515901   .1408982     4.48   0.000     1.263439     1.81881
1.pneumococcal_vaccine |   .9769818   .1033168    -0.22   0.826     .7940925    1.201993
----------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates store A

. 
. stcox i.exposure##i.age70 i.male $varlist, strata(stp)          

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -9513.8021
Iteration 1:   log likelihood = -8783.0066
Iteration 2:   log likelihood = -8568.1778
Iteration 3:   log likelihood = -8563.8094
Iteration 4:   log likelihood = -8563.8037
Iteration 5:   log likelihood = -8563.8037
Refining estimates:
Iteration 0:   log likelihood = -8563.8037

Stratified Cox regr. -- Breslow method for ties

No. of subjects =    2,459,614                  Number of obs    =   2,459,614
No. of failures =          829
Time at risk    =    252524169
                                                LR chi2(32)      =     1900.00
Log likelihood  =   -8563.8037                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
    current NSAID use  |   1.156892   .1491662     1.13   0.258     .8985481    1.489513
               1.age70 |   5.820784   .6368687    16.10   0.000     4.697308    7.212966
                       |
        exposure#age70 |
  current NSAID use#1  |   .6613407   .1063318    -2.57   0.010     .4825777    .9063236
                       |
                1.male |   2.114891   .1530403    10.35   0.000     1.835238    2.437158
                       |
             obese4cat |
    Obese I (30-34.9)  |   .9630344   .0872305    -0.42   0.678     .8063822    1.150119
   Obese II (35-39.9)  |   1.238301    .151407     1.75   0.080     .9744281     1.57363
      Obese III (40+)  |   1.148484   .2025825     0.78   0.433     .8127937    1.622816
                       |
          smoke_nomiss |
               Former  |    1.08644   .0839771     1.07   0.283     .9337088    1.264154
              Current  |   .6625789   .0898898    -3.03   0.002     .5078764    .8644049
                       |
                   imd |
                    2  |   1.468086   .1650118     3.42   0.001     1.177814    1.829894
                    3  |    1.46805   .1711098     3.29   0.001      1.16823    1.844818
                    4  |   1.674015   .1979862     4.36   0.000     1.327662    2.110723
      5 most deprived  |   2.040821   .2495511     5.83   0.000     1.605907    2.593521
                       |
                   ckd |
                  CKD  |   2.072082   .1926729     7.84   0.000     1.726862    2.486314
        1.hypertension |   1.364971   .1090038     3.90   0.000     1.167208    1.596242
       1.heart_failure |   1.996424   .3360694     4.11   0.000     1.435374    2.776773
 1.other_heart_disease |   1.159193   .1940125     0.88   0.377     .8350092    1.609237
                       |
          diab_control |
  Controlled diabetes  |   1.560759   .1511413     4.60   0.000     1.290942    1.886969
Uncontrolled diabetes  |   2.200234    .292929     5.92   0.000     1.694899    2.856235
                       |
                1.copd |   1.394496   .1743236     2.66   0.008     1.091465    1.781658
   1.other_respiratory |   2.589296   .3498769     7.04   0.000     1.986844    3.374425
       1.immunodef_any |   2.130831    .624306     2.58   0.010     1.199935    3.783903
              1.cancer |   2.339418   .1980757    10.04   0.000     1.981699     2.76171
          1.rheumatoid |   1.316971   .2517077     1.44   0.150     .9055017    1.915416
      1.osteoarthritis |   1.163574   .0906465     1.94   0.052     .9988094    1.355519
              1.statin |   .6492194   .0556551    -5.04   0.000      .548809    .7680008
                 1.ppi |   1.544923   .1244804     5.40   0.000     1.319235     1.80922
1.steroid_prednisolone |   1.526139   .1967673     3.28   0.001     1.185353    1.964902
  1.hydroxychloroquine |   1.254285   .3700159     0.77   0.442     .7035426    2.236155
 1.dmards_primary_care |   1.444452   .3061997     1.73   0.083     .9533727    2.188486
         1.flu_vaccine |   1.505424   .1396284     4.41   0.000     1.255191    1.805544
1.pneumococcal_vaccine |    .975483   .1031512    -0.23   0.814     .7928855    1.200132
----------------------------------------------------------------------------------------
                                                             Stratified by stp

. estimates store B

. estimates save ./$tempdir/multivar2_int, replace 
file ./nsaid_tempdata/multivar2_int.ster saved

. 
. lrtest A B

Likelihood-ratio test                                 LR chi2(1)  =      6.56
(Assumption: A nested in B)                           Prob > chi2 =    0.0105

. local multivar2_p = round(r(p),0.001)

. 
. /* Print interaction table====================================================*/ 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table3.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 3: Current NSAID use and $outcome, Age Interaction - $population Population") _n

. file write tablecontent  _tab ("Number of events") _tab ("Total person-weeks") _tab ("Rate per 1,000") _tab ("Univariable") _tab _tab _tab ("Age/Sex Adjusted") _tab _tab 
> _tab  ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _tab _tab _n

. file write tablecontent _tab _tab _tab _tab ("HR") _tab ("95% CI") _tab ("p (interaction)") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("p (interaction)") _tab ("HR") _tab ("95% CI") _tab ("p (interaction)") _tab _n

. 
. * Overall p-values 
. file write tablecontent ("Agegroup") _tab _tab _tab _tab _tab _tab ("`univar_p'") ///
>                                                 _tab _tab _tab ("`multivar1_p'") /// 
>                                                 _tab _tab _tab ("`multivar2_p'") _n

. 
.                                                 
. * Generic program to print model for a level of another variable 
. cap prog drop printinteraction

. prog define printinteraction 
  1. syntax, variable(varname) min(real) max(real) 
  2. 
.         forvalues varlevel = `min'/`max'{ 
  3. 
.                 * Row headings 
.                 file write tablecontent ("`varlevel'") _n       
  4. 
.                 local lab0: label exposure 0
  5.                 local lab1: label exposure 1
  6.                  
.                 /* Counts */
.                         
.                 * First row, exposure = 0 (reference)
.                 
.         file write tablecontent ("`lab0'") _tab
  7. 
.                         safecount if exposure == 0  & `variable' == `varlevel' & $outcome == 1
  8.             local event = r(N)
  9.                     bysort exposure `variable': egen total_follow_up = total(_t)
 10.             su total_follow_up if exposure == 0 & `variable' == `varlevel'
 11.             local person_week = r(mean)/7
 12.             local rate = 1000*(`event'/`person_week')
 13. 
.                         
.                 file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab
 14.         file write tablecontent ("1.00 (ref)") _tab _tab ("1.00 (ref)") _tab _tab ("1.00 (ref)") _n
 15. 
.                         
.                 * Second row, exposure = 1 (NSAID)
. 
.                 file write tablecontent ("`lab1'") _tab  
 16. 
. 
.                         safecount if exposure == 1 & `variable' == `varlevel' & $outcome == 1
 17.                 local event = r(N)
 18.             su total_follow_up if exposure == 1 & `variable' == `varlevel'
 19.             local person_week = r(mean)/7
 20.             local rate = 1000*(`event'/`person_week')
 21.             file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab
 22. 
.                 * Print models 
.                 estimates use ./$tempdir/univar_int 
 23.                 qui lincom 1.exposure + 1.exposure#`varlevel'.`variable', eform
 24.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab _tab
 25. 
.                 estimates use ./$tempdir/multivar1_int
 26.                 qui lincom 1.exposure + 1.exposure#`varlevel'.`variable', eform
 27.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab _tab
 28. 
.                 estimates use ./$tempdir/multivar2_int
 29.                 qui lincom 1.exposure + 1.exposure#`varlevel'.`variable', eform
 30.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab _n 
 31. 
.                 drop total_follow_up
 32.         } 
 33.                 
. end

. 
. printinteraction, variable(age70) min(0) max(1) 
  224

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |  1,700,065    1.74e+08           0   1.74e+08   1.74e+08
  96

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    457,334    4.80e+07           0   4.80e+07   4.80e+07
  387

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    224,030    2.28e+07           0   2.28e+07   2.28e+07
  122

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |     78,185     8173623           0    8173623    8173623

. 
. file write tablecontent _n

. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\alex\nsaids-covid-research\analysis\nsaid_log\07_an_models_interact.log
  log type:  text
 closed on:  14 Jul 2020, 22:02:07
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
